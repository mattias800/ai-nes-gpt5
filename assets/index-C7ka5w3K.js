(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function s(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(a){if(a.ep)return;a.ep=!0;const n=s(a);fetch(a.href,n)}})();const m=e=>document.querySelector(e),G=m("#help-btn"),x=m("#help-modal"),oe=m("#help-close"),Ge=()=>{!x||!G||(x.classList.remove("hidden"),G.setAttribute("aria-expanded","true"))},de=()=>{!x||!G||(x.classList.add("hidden"),G.setAttribute("aria-expanded","false"))};G==null||G.addEventListener("click",()=>Ge());oe==null||oe.addEventListener("click",()=>de());x==null||x.addEventListener("click",e=>{e.target===x&&de()});window.addEventListener("keydown",e=>{e.key==="Escape"&&de()});const _=m("#volume"),ge=m("#volumeLabel"),Ie=()=>{_&&ge&&(ge.textContent=`${_.value}%`)};_==null||_.addEventListener("input",Ie);Ie();const N=m("#screen"),Z=m("#scale-control"),v=m("#scale-fit"),se=()=>{if(!N)return;const e=256,t=240;if(!!(v!=null&&v.checked)){const o=N.parentElement;if(!o)return;const a=o.getBoundingClientRect(),n=Math.max(1,Math.floor(Math.min(a.width/e,a.height/t)));N.style.width=`${e*n}px`,N.style.height=`${t*n}px`}else if(Z){const o=Math.max(1,Math.min(6,parseInt(Z.value||"2",10)));N.style.width=`${e*o}px`,N.style.height=`${t*o}px`}};Z==null||Z.addEventListener("change",()=>{v&&(v.checked=!1),se()});v==null||v.addEventListener("change",se);window.addEventListener("resize",()=>{v!=null&&v.checked&&se()});se();const $=m("#dropzone"),R=m("#rom"),X=m("#fs-btn"),$e=document.querySelector(".screen-panel"),le=()=>{const e=!!document.fullscreenElement;X&&(X.textContent=e?"Exit Fullscreen":"Fullscreen",X.setAttribute("aria-pressed",e?"true":"false"))};X==null||X.addEventListener("click",async()=>{try{document.fullscreenElement?await document.exitFullscreen():await($e??document.documentElement).requestFullscreen()}catch{}finally{le()}});document.addEventListener("fullscreenchange",le);le();const Ve=e=>({0:"NROM",1:"MMC1",2:"UxROM (UNROM/UN1ROM)",3:"CNROM",4:"MMC3 (TxROM)",5:"MMC5",7:"AxROM",9:"MMC2",10:"MMC4",11:"Color Dreams",13:"CPROM",15:"100-in-1",19:"Namco 163/175/340",21:"Konami VRC4a/VRC4c",22:"Konami VRC2a",23:"Konami VRC2b/VRC4e",24:"Konami VRC6a",25:"Konami VRC4b/VRC4d",26:"Konami VRC6b",66:"GxROM / GNROM",69:"Sunsoft FME-7",70:"Bandai 74HC161/32",71:"Camerica",79:"NINA-003/006",85:"Konami VRC7",94:"MMC3 variant (TxSROM)"})[e]??`Mapper ${e}`,He=(e,t)=>{if(e.length<16||!(e[0]===78&&e[1]===69&&e[2]===83&&e[3]===26))return null;const s=e,o=s[6]|0,a=s[7]|0,n=(a&12)===8;let r=a&240|o>>4|0,u;n&&(r|=(s[8]&15)<<8,u=s[8]>>4&15);const g=(s[4]|0)*16*1024,F=(s[5]|0)*8*1024,j=!!(o&2),K=o&8?"Four-screen":o&1?"Vertical":"Horizontal";return{title:t.replace(/\.[^.]+$/i,""),prgRomBytes:g,chrRomBytes:F,mapper:r,mapperName:Ve(r),hasBattery:j,mirroring:K,isNES2:n,submapper:u}},we=e=>e>=1024*1024?`${(e/(1024*1024)).toFixed(2).replace(/\.00$/,"")} MB`:e>=1024?`${(e/1024).toFixed(0)} KB`:`${e} B`,re=m("#game-info"),ye=e=>{if(!re)return;if(!e){re.innerHTML='<div class="info-header">Game Info</div><div class="info-body muted">Invalid or unsupported ROM.</div>';return}const t=e.submapper!=null?` (submapper ${e.submapper})`:"";re.innerHTML=`
    <div class="info-header">Game Info</div>
    <div class="info-grid">
      <div class="k">Title</div><div class="v">${e.title}</div>
      <div class="k">PRG ROM</div><div class="v">${we(e.prgRomBytes)}</div>
      <div class="k">CHR ${e.chrRomBytes?"ROM":"RAM"}</div><div class="v">${e.chrRomBytes?we(e.chrRomBytes):"Present"}</div>
      <div class="k">Mapper</div><div class="v">${e.mapperName} (#${e.mapper})${t}</div>
      <div class="k">Mirroring</div><div class="v">${e.mirroring}</div>
      <div class="k">Battery</div><div class="v">${e.hasBattery?"Yes":"No"}</div>
      <div class="k">Header</div><div class="v">${e.isNES2?"NES 2.0":"iNES"}</div>
    </div>
  `},Ne=async e=>{try{const t=new Uint8Array(await e.arrayBuffer()),s=He(t,e.name);ye(s)}catch{ye(null)}};R==null||R.addEventListener("change",()=>{var t;const e=(t=R.files)==null?void 0:t[0];e&&Ne(e)});const he=m("#pad-ind");let V=null,p={};const W=(e,t)=>{const s=t?"keydown":"keyup",o=new KeyboardEvent(s,{code:e,bubbles:!0,cancelable:!0});window.dispatchEvent(o)},q=(e,t)=>{he&&(he.textContent=e?`ðŸŽ® ${t||"Controller"}`:"ðŸŽ® Not connected")};window.addEventListener("gamepadconnected",e=>{V==null&&(V=e.gamepad.index),q(!0,e.gamepad.id)});window.addEventListener("gamepaddisconnected",e=>{if(V===e.gamepad.index){for(const t of Object.keys(p))p[t]&&(W(t,!1),p[t]=!1);V=null,q(!1)}});const Xe=e=>{const t=u=>{const g=e.buttons[u];return!!g&&(typeof g=="object"?g.pressed:g>.5)},s=e.axes||[],o=.5,a=s[0]??0,n=s[1]??0,r={};return t(0)&&(r.KeyZ=!0),t(1)&&(r.KeyX=!0),t(9)&&(r.Enter=!0),t(8)&&(r.ShiftLeft=!0),(t(12)||n<-o)&&(r.ArrowUp=!0),(t(13)||n>o)&&(r.ArrowDown=!0),(t(14)||a<-o)&&(r.ArrowLeft=!0),(t(15)||a>o)&&(r.ArrowRight=!0),r},xe=()=>{const e=navigator.getGamepads?navigator.getGamepads():[];let t=null;if(V!=null&&(t=e[V]||null),!t){for(const s of e)if(s&&s.connected){t=s,V=s.index;break}}if(t&&t.connected){const s=Xe(t),o=new Set([...Object.keys(p),...Object.keys(s)]);for(const a of o){const n=!!p[a],r=!!s[a];r&&!n&&W(a,!0),!r&&n&&W(a,!1)}p=s,q(!0,t.id)}else{if(Object.keys(p).some(s=>p[s])){for(const s of Object.keys(p))p[s]&&W(s,!1);p={}}q(!1)}requestAnimationFrame(xe)};requestAnimationFrame(xe);window.addEventListener("blur",()=>{for(const e of Object.keys(p))p[e]&&W(e,!1);p={}});const Pe=()=>{$==null||$.classList.remove("hidden")},Re=()=>{$==null||$.classList.add("hidden")};window.addEventListener("dragenter",e=>{e.preventDefault(),Pe()});window.addEventListener("dragover",e=>{e.preventDefault()});window.addEventListener("dragleave",e=>{e.target===$&&Re()});window.addEventListener("drop",async e=>{var s;e.preventDefault(),Re();const t=(s=e.dataTransfer)==null?void 0:s.files;if(!(!t||t.length===0||!R))try{const o=new DataTransfer;o.items.add(t[0]),R.files=o.files,R.dispatchEvent(new Event("change",{bubbles:!0}))}catch{R.focus()}});const Fe=[[84,84,84],[0,30,116],[8,16,144],[48,0,136],[68,0,100],[92,0,48],[84,4,0],[60,24,0],[32,42,0],[8,58,0],[0,64,0],[0,60,0],[0,50,60],[0,0,0],[0,0,0],[0,0,0],[152,150,152],[8,76,196],[48,50,236],[92,30,228],[136,20,176],[160,20,100],[152,34,32],[120,60,0],[84,90,0],[40,114,0],[8,124,0],[0,118,40],[0,102,120],[0,0,0],[0,0,0],[0,0,0],[236,238,236],[76,154,236],[120,124,236],[176,98,236],[228,84,236],[236,88,180],[236,106,100],[212,136,32],[160,170,0],[116,196,0],[76,208,32],[56,204,108],[56,180,204],[60,60,60],[0,0,0],[0,0,0],[236,238,236],[168,204,236],[188,188,236],[212,178,236],[236,174,236],[236,174,212],[236,180,176],[228,196,144],[204,210,120],[180,222,120],[168,226,144],[152,226,180],[160,214,228],[160,162,160],[0,0,0],[0,0,0]],B={ReadIdx:0,WriteIdx:1,Capacity:2,Channels:3,Underruns:4,Overruns:5,LastOccupancy:6},ve=8,Ke=({capacityFrames:e,channels:t})=>{const s=Int32Array.BYTES_PER_ELEMENT*ve,o=Float32Array.BYTES_PER_ELEMENT*e*t,a=new SharedArrayBuffer(s+o),n=new Int32Array(a,0,ve);return n[B.ReadIdx]=0,n[B.WriteIdx]=0,n[B.Capacity]=e|0,n[B.Channels]=t|0,n[B.Underruns]=0,n[B.Overruns]=0,n[B.LastOccupancy]=0,{controlSAB:a,dataSAB:a,dataByteOffset:s,capacityFrames:e,channels:t}},H=new URL(window.location.href).searchParams,Me=H.get("stats")==="1",ke=H.get("noaudio")==="1",Le=H.has("fastdraw")?H.get("fastdraw")==="1":!0,Ee=H.has("lowlat")?H.get("lowlat")==="1":!0,Ce=(()=>{const e=Number(H.get("fill"));return Number.isFinite(e)&&e>0?Math.floor(e):0})(),J=typeof crossOriginIsolated<"u"&&crossOriginIsolated&&typeof SharedArrayBuffer<"u";if(!J){const e=document.createElement("div");e.style.cssText="position:fixed;left:8px;bottom:8px;background:rgba(0,0,0,0.75);color:#fff;padding:10px 12px;border-radius:6px;max-width:520px;font:13px/1.4 system-ui;z-index:9999;",e.innerHTML=`
    <div style="margin-bottom:6px;font-weight:600">SharedArrayBuffer unavailable</div>
    <div>This environment lacks COOP/COEP. Using legacy audio fallback (slightly higher latency). For optimal audio, start via the dev server or host with headers:<br/>
      <code style="display:inline-block;margin-top:4px">Cross-Origin-Opener-Policy: same-origin</code><br/>
      <code style="display:inline-block">Cross-Origin-Embedder-Policy: require-corp</code>
    </div>`,document.body.appendChild(e)}const A=e=>document.querySelector(e),ae=A("#screen"),y=A("#status"),D=A("#start"),b=A("#pause"),Ae=A("#rom"),k=A("#opt-stats"),L=A("#opt-fastdraw"),E=A("#opt-lowlat"),S=A("#opt-noaudio");k&&(k.checked=Me);L&&(L.checked=Le);E&&(E.checked=Ee);S&&(S.checked=ke);let h={statsEnabled:(k==null?void 0:k.checked)??Me,forceNoAudio:(S==null?void 0:S.checked)??ke,lowLat:(E==null?void 0:E.checked)??Ee},z=(L==null?void 0:L.checked)??Le,Q=ae.getContext("2d",{alpha:!1,desynchronized:z}),M=!1,l=null,d=null,f=null,i=null,O=null,T={useVT:!0,strict:!1},C=null,be=!1,I=0,ue=0;const _e=()=>{try{d==null||d.disconnect()}catch{}try{f==null||f.disconnect()}catch{}try{C==null||C.disconnect()}catch{}d=null,f=null,C=null},Ze=()=>{try{i==null||i.terminate()}catch{}i=null},We=()=>{P=null,w=!1,me=0,Y=0,I=0,te=0,U=0,ce=performance.now(),ue=0},Ue=()=>{const e=document.createElement("div");e.style.cssText="position:fixed;right:8px;bottom:8px;background:rgba(0,0,0,0.6);color:#0f0;font:12px/1.3 monospace;padding:6px 8px;border-radius:4px;max-width:40vw;white-space:pre;",e.id="stats-overlay";const t=new Map,s=(o,a)=>{let n=t.get(o);n||(n=document.createElement("div"),t.set(o,n),e.appendChild(n)),n.textContent=`${o}: ${a}`};return document.body.appendChild(e),{root:e,set:s}};let c=null;const Se=e=>{e?c||(c=Ue()):c&&(c.root.remove(),c=null);try{d==null||d.port.postMessage({type:"enable-stats",value:e})}catch{}};Se(h.statsEnabled);const ie=e=>{if(c)if((e==null?void 0:e.type)==="worker-stats"&&e.audio){const t=e.audio;c.set("pump/ms avg",(t.pumpMsAvg??0).toFixed(2)),c.set("pump/ms 95p",(t.pumpMs95p??0).toFixed(2)),c.set("frames/pump avg",(t.framesPerPumpAvg??0).toFixed(1)),c.set("SAB occ min/avg/max",`${Math.round(t.sabOccMin??0)}/${Math.round(t.sabOccAvg??0)}/${Math.round(t.sabOccMax??0)}`),c.set("occ now (cons/prod)",`${Math.round(t.occConsumerNow??-1)}/${Math.round(t.occProducerNow??-1)}`),c.set("rw (r/w)",`${Math.round(t.r??-1)}/${Math.round(t.w??-1)}`)}else(e==null?void 0:e.type)==="worklet-stats"&&(ue=performance.now(),c.set("Underruns",String((e.underruns??0)|0)),c.set("Worklet occ min/avg/max",`${Math.round(e.occMin??0)}/${Math.round(e.occAvg??0)}/${Math.round(e.occMax??0)}`),c.set("sampleRate",String((e.sampleRate??0)|0)),typeof e.r=="number"&&typeof e.w=="number"&&c.set("worklet rw (r/w)",`${e.r}|${e.w}`),typeof e.capacity=="number"&&c.set("worklet cap",String(e.capacity)),typeof e.ringChannels=="number"&&c.set("worklet ch",String(e.ringChannels)))},De=async()=>{l||(l=new AudioContext({sampleRate:44100})),be||(await l.audioWorklet.addModule(new URL("/ai-nes-gpt5/assets/nes-audio-processor-WCsM8W1W.ts",import.meta.url)),be=!0)},ze=()=>{const e=l,t=1,s=2,o=Ke({capacityFrames:16384,channels:t});d=new AudioWorkletNode(e,"nes-audio-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[s],channelCount:s,channelCountMode:"explicit",channelInterpretation:"speakers",processorOptions:{controlSAB:o.controlSAB,dataSAB:o.dataSAB,dataByteOffset:o.dataByteOffset??0}}),d.port.onmessage=a=>{const n=a.data;if((n==null?void 0:n.type)==="worklet-ready")try{d.port.postMessage({type:"set-sab",controlSAB:o.controlSAB,dataSAB:o.dataSAB,dataByteOffset:o.dataByteOffset??0})}catch(r){console.warn("[audio] failed to post set-sab:",r)}else(n==null?void 0:n.type)==="worklet-ack"?(console.log("[audio] worklet-ack:",n.what),ie(n)):(n==null?void 0:n.type)==="worklet-stats"?ie(n):(n==null?void 0:n.type)==="worklet-error"&&console.warn("[audio] worklet error:",n==null?void 0:n.message)},h.statsEnabled&&d.port.postMessage({type:"enable-stats",value:!0}),f=new GainNode(e,{gain:.25}),d.connect(f),f.connect(e.destination);try{e.resume(),console.log("[audio] context resumed, state:",e.state),setTimeout(()=>{console.log("[audio] context state after 1s:",e.state),console.log("[audio] worklet connected:",(d==null?void 0:d.context)===e),console.log("[audio] gain connected:",(f==null?void 0:f.context)===e)},1e3)}catch(a){console.warn("[audio] context resume failed:",a)}return{sab:o}},Be=async()=>{l||(l=new AudioContext),await l.audioWorklet.addModule(new URL("data:text/javascript;base64,Y2xhc3MgTmVzUHJvY2Vzc29yIGV4dGVuZHMgQXVkaW9Xb3JrbGV0UHJvY2Vzc29yIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKCk7CiAgICB0aGlzLl9xdWV1ZSA9IFtdOwogICAgdGhpcy5faW5kZXggPSAwOwogICAgdGhpcy5wb3J0Lm9ubWVzc2FnZSA9IChlKSA9PiB7CiAgICAgIGNvbnN0IHsgdHlwZSwgZGF0YSB9ID0gZS5kYXRhIHx8IHt9OwogICAgICBpZiAodHlwZSA9PT0gJ3NhbXBsZXMnICYmIGRhdGEgJiYgZGF0YS5idWZmZXIpIHsKICAgICAgICAvLyBkYXRhIGlzIGEgRmxvYXQzMkFycmF5OyBjb3B5IGEgcmVmZXJlbmNlIGJ5IHJldGFpbmluZyBpdHMgYnVmZmVyCiAgICAgICAgdGhpcy5fcXVldWUucHVzaChuZXcgRmxvYXQzMkFycmF5KGRhdGEuYnVmZmVyKSk7CiAgICAgIH0KICAgIH07CiAgfQogIHByb2Nlc3MoaW5wdXRzLCBvdXRwdXRzKSB7CiAgICBjb25zdCBvdXRwdXQgPSBvdXRwdXRzWzBdWzBdOwogICAgbGV0IGkgPSAwOwogICAgd2hpbGUgKGkgPCBvdXRwdXQubGVuZ3RoKSB7CiAgICAgIGlmICh0aGlzLl9xdWV1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICBvdXRwdXRbaSsrXSA9IDA7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgY2h1bmsgPSB0aGlzLl9xdWV1ZVswXTsKICAgICAgaWYgKHRoaXMuX2luZGV4ID49IGNodW5rLmxlbmd0aCkgewogICAgICAgIHRoaXMuX3F1ZXVlLnNoaWZ0KCk7CiAgICAgICAgdGhpcy5faW5kZXggPSAwOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIG91dHB1dFtpKytdID0gY2h1bmtbdGhpcy5faW5kZXgrK107CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9Cn0KcmVnaXN0ZXJQcm9jZXNzb3IoJ25lcy1wcm9jZXNzb3InLCBOZXNQcm9jZXNzb3IpOwoK",import.meta.url)),C=new AudioWorkletNode(l,"nes-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[1]}),C.connect(l.destination);try{await l.resume()}catch{}},pe=256,fe=240;ae.width=pe;ae.height=fe;let ee=Q.createImageData(pe,fe),Oe=new Uint32Array(ee.data.buffer);const Ye=()=>{Q=ae.getContext("2d",{alpha:!1,desynchronized:z}),ee=Q.createImageData(pe,fe),Oe=new Uint32Array(ee.data.buffer)},je=(()=>{const e=new Uint32Array(64);for(let t=0;t<64;t++){const[s,o,a]=Fe[t];e[t]=255<<24|a<<16|o<<8|s}return e})();let P=null,w=!1,me=0,Y=0,U=0,ce=performance.now(),te=0;const ne=()=>{if(!P)return;const e=performance.now(),t=P;for(let o=0;o<t.length;o++)Oe[o]=je[t[o]&63];Q.putImageData(ee,0,0);const s=performance.now()-e;U=U===0?s:U*.9+s*.1,me++,te++},Te=e=>{if(w&&(ne(),w=!1),c){const t=performance.now();t-ce>1e3&&(c.set("video fps",String(te)),c.set("frames drawn",String(me)),c.set("frames dropped",String(Y)),c.set("draw ms (EMA)",U.toFixed(2)),c.set("frames recv",String(I)),te=0,ce=t)}requestAnimationFrame(Te)};requestAnimationFrame(Te);k&&k.addEventListener("change",()=>{h.statsEnabled=k.checked,Se(h.statsEnabled)});L&&L.addEventListener("change",()=>{z=L.checked,Ye()});E&&E.addEventListener("change",()=>{h.lowLat=E.checked,y.textContent=`Low-latency audio ${h.lowLat?"enabled":"disabled"} (applies on next Start)`});S&&S.addEventListener("change",()=>{h.forceNoAudio=S.checked,y.textContent=`No audio ${h.forceNoAudio?"enabled":"disabled"} (applies on next Start)`});window.addEventListener("keydown",e=>{if(i)switch(e.code){case"KeyZ":case"KeyX":case"ShiftLeft":case"Enter":case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":e.preventDefault(),i.postMessage({type:"input",code:e.code,down:!0});break}});window.addEventListener("keyup",e=>{if(i)switch(e.code){case"KeyZ":case"KeyX":case"ShiftLeft":case"Enter":case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":e.preventDefault(),i.postMessage({type:"input",code:e.code,down:!1});break}});Ae.addEventListener("change",async()=>{var t;const e=(t=Ae.files)==null?void 0:t[0];if(e){y.textContent=`Loading ${e.name}...`;try{O=new Uint8Array(await e.arrayBuffer());const s=new URLSearchParams(window.location.search),a=!(s.get("legacy")==="1"||s.get("timing")==="legacy"),n=s.get("strict")==="1";T={useVT:a,strict:n},D.disabled=!1,b.disabled=!M;const r=(s.get("region")||"").toLowerCase(),u=r==="pal"?"PAL":r==="ntsc"?"NTSC":void 0,g=(s.get("apu_timing")||s.get("aputimings")||"").toLowerCase(),F=g==="fractional"?"fractional":g==="integer"?"integer":void 0,j=(s.get("apu_synth")||s.get("synth")||"").toLowerCase(),K=j==="blep"?"blep":j==="raw"?"raw":void 0;y.textContent=`Ready â€” press Start${a?" (VT timing)":" (legacy timing)"}${u?`, APU ${u}`:""}${F?`, ${F} fc`:""}${K?`, ${K} synth`:""}`,window.__apuRegion=u,window.__apuTiming=F,window.__apuSynth=K}catch(s){y.textContent="Failed to load ROM",console.error(s)}}});D.addEventListener("click",async()=>{if(!O)return;Ze(),_e(),We();let e=null,t=48e3;const s=J&&!h.forceNoAudio;let o=!1;if(s)try{await De(),e=ze().sab,t=l.sampleRate,await l.resume()}catch(r){console.warn("Audio setup failed, falling back to no-audio mode:",r),e=null}else if(!h.forceNoAudio&&!J)try{await Be(),t=(l==null?void 0:l.sampleRate)||48e3,o=!0}catch(r){console.warn("Legacy audio setup failed, continuing without audio:",r),o=!1}i=new Worker(new URL("/ai-nes-gpt5/assets/nesCore.worker-BHEG7TS9.js",import.meta.url),{type:"module"}),i.onmessage=r=>{const u=r.data||{};if(u.type==="ppu-frame")w&&Y++,P=u.indices,w=!0,I++,performance.now(),z&&(ne(),w=!1);else if(u.type!=="worker-stats"){if(u.type==="audio-chunk"&&C){const g=new Float32Array(u.samples);C.port.postMessage({type:"samples",data:g},[g.buffer])}}};const a=Ce>0?Ce:h.lowLat?768:1024;i.postMessage({type:"init",sab:e?{controlSAB:e.controlSAB,dataSAB:e.dataSAB,dataByteOffset:e.dataByteOffset??0}:null,sampleRate:t,channels:1,targetFillFrames:a,noAudio:!e&&!o,useLegacy:o}),i.onerror=r=>{console.error("[worker] error",r.message,r.error)},i.onmessageerror=r=>{console.error("[worker] messageerror",r.data)};{const r=new Uint8Array(O);i.postMessage({type:"load_rom",rom:r,useVT:T.useVT,strict:T.strict,apuRegion:window.__apuRegion,apuTiming:window.__apuTiming,apuSynth:window.__apuSynth},[r.buffer])}i.postMessage({type:"start"}),M=!0,D.disabled=!0,b.disabled=!1,b.textContent="Pause",y.textContent=e?"Running":o?"Running (legacy audio)":"Running (no audio)";const n=performance.now();setTimeout(()=>{I===0&&M&&performance.now()-n>=1900&&(y.textContent="No video frames received yet. Enable the Stats overlay and check the console for worker errors."),J&&!h.forceNoAudio&&ue<n&&I<=1&&M&&(console.warn("[audio] suspected stall at startup; switching to legacy audio fallback"),Je("startup stall"))},1800),setTimeout(()=>{if(I===0&&M&&performance.now()-n>=3e3){if(console.warn("[video] No frames received after 3s, attempting video-only restart"),y.textContent="Restarting in video-only mode...",i==null||i.terminate(),i=new Worker(new URL("/ai-nes-gpt5/assets/nesCore.worker-BHEG7TS9.js",import.meta.url),{type:"module"}),i.onmessage=r=>{const u=r.data||{};u.type==="ppu-frame"&&(w&&Y++,P=u.indices,w=!0,I++,performance.now(),z&&(ne(),w=!1))},i.postMessage({type:"init",sab:null,sampleRate:48e3,channels:1,targetFillFrames:2048,noAudio:!0}),O){const r=new Uint8Array(O);i.postMessage({type:"load_rom",rom:r,useVT:T.useVT,strict:T.strict,apuRegion:window.__apuRegion,apuTiming:window.__apuTiming,apuSynth:window.__apuSynth},[r.buffer])}i.postMessage({type:"start"}),y.textContent="Running (video-only fallback)"}},3e3)});b.addEventListener("click",()=>{i&&(M?(M=!1,D.disabled=!1,b.disabled=!1,b.textContent="Resume",y.textContent="Paused",i.postMessage({type:"pause"})):(i.postMessage({type:"start"}),M=!0,D.disabled=!0,b.disabled=!1,b.textContent="Pause",y.textContent="Running"))});const Je=async e=>{try{d==null||d.disconnect()}catch{}try{f==null||f.disconnect()}catch{}d=null,f=null;const t=i;try{t==null||t.terminate()}catch{}await Be(),i=new Worker(new URL("/ai-nes-gpt5/assets/nesCore.worker-BHEG7TS9.js",import.meta.url),{type:"module"}),i.onmessage=a=>{const n=a.data||{};if(n.type==="ppu-frame")w&&Y++,P=n.indices,w=!0,I++,performance.now(),ne(),w=!1;else if(n.type==="worker-stats")ie(n);else if(n.type==="audio-chunk"&&C){const r=new Float32Array(n.samples);C.port.postMessage({type:"samples",data:r},[r.buffer])}},i.onerror=a=>{console.error("[worker] error (legacy)",a.message,a.error)},i.onmessageerror=a=>{console.error("[worker] messageerror (legacy)",a.data)};const s=(l==null?void 0:l.sampleRate)||48e3;if(i.postMessage({type:"init",sab:null,sampleRate:s,channels:1,targetFillFrames:2048,noAudio:!1,useLegacy:!0}),O){const a=new Uint8Array(O);i.postMessage({type:"load_rom",rom:a,useVT:T.useVT,strict:T.strict,apuRegion:window.__apuRegion,apuTiming:window.__apuTiming,apuSynth:window.__apuSynth},[a.buffer])}i.postMessage({type:"start"}),y.textContent=`Running (legacy audio, fallback: ${e})`};
