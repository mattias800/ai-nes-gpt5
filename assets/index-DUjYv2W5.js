(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function s(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(a){if(a.ep)return;a.ep=!0;const n=s(a);fetch(a.href,n)}})();const m=e=>document.querySelector(e),$=m("#help-btn"),x=m("#help-modal"),ie=m("#help-close"),Fe=()=>{!x||!$||(x.classList.remove("hidden"),$.setAttribute("aria-expanded","true"))},ue=()=>{!x||!$||(x.classList.add("hidden"),$.setAttribute("aria-expanded","false"))};$==null||$.addEventListener("click",()=>Fe());ie==null||ie.addEventListener("click",()=>ue());x==null||x.addEventListener("click",e=>{e.target===x&&ue()});window.addEventListener("keydown",e=>{e.key==="Escape"&&ue()});const K=m("#volume"),ye=m("#volumeLabel"),Le=()=>{K&&ye&&(ye.textContent=`${K.value}%`)};K==null||K.addEventListener("input",Le);Le();const F=m("#screen"),_=m("#scale-control"),v=m("#scale-fit"),oe=()=>{if(!F)return;const e=256,t=240;if(!!(v!=null&&v.checked)){const o=F.parentElement;if(!o)return;const a=o.getBoundingClientRect(),n=Math.max(1,Math.floor(Math.min(a.width/e,a.height/t)));F.style.width=`${e*n}px`,F.style.height=`${t*n}px`}else if(_){const o=Math.max(1,Math.min(6,parseInt(_.value||"2",10)));F.style.width=`${e*o}px`,F.style.height=`${t*o}px`}};_==null||_.addEventListener("change",()=>{v&&(v.checked=!1),oe()});v==null||v.addEventListener("change",oe);window.addEventListener("resize",()=>{v!=null&&v.checked&&oe()});oe();const G=m("#dropzone"),M=m("#rom"),X=m("#fs-btn"),Xe=document.querySelector(".screen-panel"),pe=()=>{const e=!!document.fullscreenElement;X&&(X.textContent=e?"Exit Fullscreen":"Fullscreen",X.setAttribute("aria-pressed",e?"true":"false"))};X==null||X.addEventListener("click",async()=>{try{document.fullscreenElement?await document.exitFullscreen():await(Xe??document.documentElement).requestFullscreen()}catch{}finally{pe()}});document.addEventListener("fullscreenchange",pe);pe();const Pe=e=>({0:"NROM",1:"MMC1",2:"UxROM (UNROM/UN1ROM)",3:"CNROM",4:"MMC3 (TxROM)",5:"MMC5",7:"AxROM",9:"MMC2",10:"MMC4",11:"Color Dreams",13:"CPROM",15:"100-in-1",19:"Namco 163/175/340",21:"Konami VRC4a/VRC4c",22:"Konami VRC2a",23:"Konami VRC2b/VRC4e",24:"Konami VRC6a",25:"Konami VRC4b/VRC4d",26:"Konami VRC6b",66:"GxROM / GNROM",69:"Sunsoft FME-7",70:"Bandai 74HC161/32",71:"Camerica",79:"NINA-003/006",85:"Konami VRC7",94:"MMC3 variant (TxSROM)"})[e]??`Mapper ${e}`,He=(e,t)=>{if(e.length<16||!(e[0]===78&&e[1]===69&&e[2]===83&&e[3]===26))return null;const s=e,o=s[6]|0,a=s[7]|0,n=(a&12)===8;let r=a&240|o>>4|0,p;n&&(r|=(s[8]&15)<<8,p=s[8]>>4&15);const g=(s[4]|0)*16*1024,H=(s[5]|0)*8*1024,J=!!(o&2),W=o&8?"Four-screen":o&1?"Vertical":"Horizontal";return{title:t.replace(/\.[^.]+$/i,""),prgRomBytes:g,chrRomBytes:H,mapper:r,mapperName:Pe(r),hasBattery:J,mirroring:W,isNES2:n,submapper:p}},he=e=>e>=1024*1024?`${(e/(1024*1024)).toFixed(2).replace(/\.00$/,"")} MB`:e>=1024?`${(e/1024).toFixed(0)} KB`:`${e} B`,ce=m("#game-info"),ve=e=>{if(!ce)return;if(!e){ce.innerHTML='<div class="info-header">Game Info</div><div class="info-body muted">Invalid or unsupported ROM.</div>';return}const t=e.submapper!=null?` (submapper ${e.submapper})`:"";ce.innerHTML=`
    <div class="info-header">Game Info</div>
    <div class="info-grid">
      <div class="k">Title</div><div class="v">${e.title}</div>
      <div class="k">PRG ROM</div><div class="v">${he(e.prgRomBytes)}</div>
      <div class="k">CHR ${e.chrRomBytes?"ROM":"RAM"}</div><div class="v">${e.chrRomBytes?he(e.chrRomBytes):"Present"}</div>
      <div class="k">Mapper</div><div class="v">${e.mapperName} (#${e.mapper})${t}</div>
      <div class="k">Mirroring</div><div class="v">${e.mirroring}</div>
      <div class="k">Battery</div><div class="v">${e.hasBattery?"Yes":"No"}</div>
      <div class="k">Header</div><div class="v">${e.isNES2?"NES 2.0":"iNES"}</div>
    </div>
  `},We=async e=>{try{const t=new Uint8Array(await e.arrayBuffer()),s=He(t,e.name);ve(s)}catch{ve(null)}};M==null||M.addEventListener("change",()=>{var t;const e=(t=M.files)==null?void 0:t[0];e&&We(e)});const be=m("#pad-ind");let V=null,f={};const Z=(e,t)=>{const s=t?"keydown":"keyup",o=new KeyboardEvent(s,{code:e,bubbles:!0,cancelable:!0});window.dispatchEvent(o)},ee=(e,t)=>{be&&(be.textContent=e?`ðŸŽ® ${t||"Controller"}`:"ðŸŽ® Not connected")};window.addEventListener("gamepadconnected",e=>{V==null&&(V=e.gamepad.index),ee(!0,e.gamepad.id)});window.addEventListener("gamepaddisconnected",e=>{if(V===e.gamepad.index){for(const t of Object.keys(f))f[t]&&(Z(t,!1),f[t]=!1);V=null,ee(!1)}});const Ke=e=>{const t=p=>{const g=e.buttons[p];return!!g&&(typeof g=="object"?g.pressed:g>.5)},s=e.axes||[],o=.5,a=s[0]??0,n=s[1]??0,r={};return t(0)&&(r.KeyZ=!0),t(1)&&(r.KeyX=!0),t(9)&&(r.Enter=!0),t(8)&&(r.ShiftLeft=!0),(t(12)||n<-o)&&(r.ArrowUp=!0),(t(13)||n>o)&&(r.ArrowDown=!0),(t(14)||a<-o)&&(r.ArrowLeft=!0),(t(15)||a>o)&&(r.ArrowRight=!0),r},ke=()=>{const e=navigator.getGamepads?navigator.getGamepads():[];let t=null;if(V!=null&&(t=e[V]||null),!t){for(const s of e)if(s&&s.connected){t=s,V=s.index;break}}if(t&&t.connected){const s=Ke(t),o=new Set([...Object.keys(f),...Object.keys(s)]);for(const a of o){const n=!!f[a],r=!!s[a];r&&!n&&Z(a,!0),!r&&n&&Z(a,!1)}f=s,ee(!0,t.id)}else{if(Object.keys(f).some(s=>f[s])){for(const s of Object.keys(f))f[s]&&Z(s,!1);f={}}ee(!1)}requestAnimationFrame(ke)};requestAnimationFrame(ke);window.addEventListener("blur",()=>{for(const e of Object.keys(f))f[e]&&Z(e,!1);f={}});const _e=()=>{G==null||G.classList.remove("hidden")},Ee=()=>{G==null||G.classList.add("hidden")};window.addEventListener("dragenter",e=>{e.preventDefault(),_e()});window.addEventListener("dragover",e=>{e.preventDefault()});window.addEventListener("dragleave",e=>{e.target===G&&Ee()});window.addEventListener("drop",async e=>{var s;e.preventDefault(),Ee();const t=(s=e.dataTransfer)==null?void 0:s.files;if(!(!t||t.length===0||!M))try{const o=new DataTransfer;o.items.add(t[0]),M.files=o.files,M.dispatchEvent(new Event("change",{bubbles:!0}))}catch{M.focus()}});const Ze=[[84,84,84],[0,30,116],[8,16,144],[48,0,136],[68,0,100],[92,0,48],[84,4,0],[60,24,0],[32,42,0],[8,58,0],[0,64,0],[0,60,0],[0,50,60],[0,0,0],[0,0,0],[0,0,0],[152,150,152],[8,76,196],[48,50,236],[92,30,228],[136,20,176],[160,20,100],[152,34,32],[120,60,0],[84,90,0],[40,114,0],[8,124,0],[0,118,40],[0,102,120],[0,0,0],[0,0,0],[0,0,0],[236,238,236],[76,154,236],[120,124,236],[176,98,236],[228,84,236],[236,88,180],[236,106,100],[212,136,32],[160,170,0],[116,196,0],[76,208,32],[56,204,108],[56,180,204],[60,60,60],[0,0,0],[0,0,0],[236,238,236],[168,204,236],[188,188,236],[212,178,236],[236,174,236],[236,174,212],[236,180,176],[228,196,144],[204,210,120],[180,222,120],[168,226,144],[152,226,180],[160,214,228],[160,162,160],[0,0,0],[0,0,0]],B={ReadIdx:0,WriteIdx:1,Capacity:2,Channels:3,Underruns:4,Overruns:5,LastOccupancy:6},Ce=8,Ue=({capacityFrames:e,channels:t})=>{const s=Int32Array.BYTES_PER_ELEMENT*Ce,o=Float32Array.BYTES_PER_ELEMENT*e*t,a=new SharedArrayBuffer(s+o),n=new Int32Array(a,0,Ce);return n[B.ReadIdx]=0,n[B.WriteIdx]=0,n[B.Capacity]=e|0,n[B.Channels]=t|0,n[B.Underruns]=0,n[B.Overruns]=0,n[B.LastOccupancy]=0,{controlSAB:a,dataSAB:a,dataByteOffset:s,capacityFrames:e,channels:t}},N=new URL(window.location.href).searchParams,Se=N.get("stats")==="1",Be=N.get("noaudio")==="1",Oe=N.has("fastdraw")?N.get("fastdraw")==="1":!0,Te=N.has("lowlat")?N.get("lowlat")==="1":!0,Ae=(()=>{const e=Number(N.get("fill"));return Number.isFinite(e)&&e>0?Math.floor(e):0})(),q=typeof crossOriginIsolated<"u"&&crossOriginIsolated&&typeof SharedArrayBuffer<"u";if(!q){const e=document.createElement("div");e.style.cssText="position:fixed;left:8px;bottom:8px;background:rgba(0,0,0,0.75);color:#fff;padding:10px 12px;border-radius:6px;max-width:520px;font:13px/1.4 system-ui;z-index:9999;",e.innerHTML=`
    <div style="margin-bottom:6px;font-weight:600">SharedArrayBuffer unavailable</div>
    <div>This environment lacks COOP/COEP. Using legacy audio fallback (slightly higher latency). For optimal audio, start via the dev server or host with headers:<br/>
      <code style="display:inline-block;margin-top:4px">Cross-Origin-Opener-Policy: same-origin</code><br/>
      <code style="display:inline-block">Cross-Origin-Embedder-Policy: require-corp</code>
    </div>`,document.body.appendChild(e)}const b=e=>document.querySelector(e),re=b("#screen"),y=b("#status"),Y=b("#start"),A=b("#pause"),Ie=b("#rom"),L=b("#opt-stats"),k=b("#opt-fastdraw"),E=b("#opt-lowlat"),S=b("#opt-noaudio"),U=b("#volume"),xe=b("#volumeLabel");L&&(L.checked=Se);k&&(k.checked=Oe);E&&(E.checked=Te);S&&(S.checked=Be);let h={statsEnabled:(L==null?void 0:L.checked)??Se,forceNoAudio:(S==null?void 0:S.checked)??Be,lowLat:(E==null?void 0:E.checked)??Te},j=(k==null?void 0:k.checked)??Oe,te=re.getContext("2d",{alpha:!1,desynchronized:j}),R=!1,d=null,l=null,u=null,D=.25,i=null,O=null,T={useVT:!0,strict:!1},C=null,Me=!1,I=0,fe=0;const De=()=>{try{l==null||l.disconnect()}catch{}try{u==null||u.disconnect()}catch{}try{C==null||C.disconnect()}catch{}l=null,u=null,C=null},ze=()=>{try{i==null||i.terminate()}catch{}i=null},Ye=()=>{P=null,w=!1,we=0,Q=0,I=0,se=0,z=0,de=performance.now(),fe=0},je=()=>{const e=document.createElement("div");e.style.cssText="position:fixed;right:8px;bottom:8px;background:rgba(0,0,0,0.6);color:#0f0;font:12px/1.3 monospace;padding:6px 8px;border-radius:4px;max-width:40vw;white-space:pre;",e.id="stats-overlay";const t=new Map,s=(o,a)=>{let n=t.get(o);n||(n=document.createElement("div"),t.set(o,n),e.appendChild(n)),n.textContent=`${o}: ${a}`};return document.body.appendChild(e),{root:e,set:s}};let c=null;const $e=e=>{e?c||(c=je()):c&&(c.root.remove(),c=null);try{l==null||l.port.postMessage({type:"enable-stats",value:e})}catch{}};$e(h.statsEnabled);const le=e=>{if(c)if((e==null?void 0:e.type)==="worker-stats"&&e.audio){const t=e.audio;c.set("pump/ms avg",(t.pumpMsAvg??0).toFixed(2)),c.set("pump/ms 95p",(t.pumpMs95p??0).toFixed(2)),c.set("frames/pump avg",(t.framesPerPumpAvg??0).toFixed(1)),c.set("SAB occ min/avg/max",`${Math.round(t.sabOccMin??0)}/${Math.round(t.sabOccAvg??0)}/${Math.round(t.sabOccMax??0)}`),c.set("occ now (cons/prod)",`${Math.round(t.occConsumerNow??-1)}/${Math.round(t.occProducerNow??-1)}`),c.set("rw (r/w)",`${Math.round(t.r??-1)}/${Math.round(t.w??-1)}`)}else(e==null?void 0:e.type)==="worklet-stats"&&(fe=performance.now(),c.set("Underruns",String((e.underruns??0)|0)),c.set("Worklet occ min/avg/max",`${Math.round(e.occMin??0)}/${Math.round(e.occAvg??0)}/${Math.round(e.occMax??0)}`),c.set("sampleRate",String((e.sampleRate??0)|0)),typeof e.r=="number"&&typeof e.w=="number"&&c.set("worklet rw (r/w)",`${e.r}|${e.w}`),typeof e.capacity=="number"&&c.set("worklet cap",String(e.capacity)),typeof e.ringChannels=="number"&&c.set("worklet ch",String(e.ringChannels)))},Qe=()=>{const e=Number((U==null?void 0:U.value)??"25");return Number.isFinite(e)?Math.max(0,Math.min(1,e/100)):.25},Re=()=>{D=Qe();try{u&&(u.gain.value=D)}catch{}xe&&(xe.textContent=`${Math.round(D*100)}%`)};U&&(Re(),U.addEventListener("input",Re));const Je=async()=>{d||(d=new AudioContext({sampleRate:44100})),Me||(await d.audioWorklet.addModule(new URL("/ai-nes-gpt5/assets/nes-audio-processor-WCsM8W1W.ts",import.meta.url)),Me=!0)},qe=()=>{const e=d,t=1,s=2,o=Ue({capacityFrames:16384,channels:t});l=new AudioWorkletNode(e,"nes-audio-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[s],channelCount:s,channelCountMode:"explicit",channelInterpretation:"speakers",processorOptions:{controlSAB:o.controlSAB,dataSAB:o.dataSAB,dataByteOffset:o.dataByteOffset??0}}),l.port.onmessage=a=>{const n=a.data;if((n==null?void 0:n.type)==="worklet-ready")try{l.port.postMessage({type:"set-sab",controlSAB:o.controlSAB,dataSAB:o.dataSAB,dataByteOffset:o.dataByteOffset??0})}catch(r){console.warn("[audio] failed to post set-sab:",r)}else(n==null?void 0:n.type)==="worklet-ack"?(console.log("[audio] worklet-ack:",n.what),le(n)):(n==null?void 0:n.type)==="worklet-stats"?le(n):(n==null?void 0:n.type)==="worklet-error"&&console.warn("[audio] worklet error:",n==null?void 0:n.message)},h.statsEnabled&&l.port.postMessage({type:"enable-stats",value:!0}),u=new GainNode(e,{gain:D}),l.connect(u),u.connect(e.destination);try{e.resume(),console.log("[audio] context resumed, state:",e.state),setTimeout(()=>{console.log("[audio] context state after 1s:",e.state),console.log("[audio] worklet connected:",(l==null?void 0:l.context)===e),console.log("[audio] gain connected:",(u==null?void 0:u.context)===e)},1e3)}catch(a){console.warn("[audio] context resume failed:",a)}return{sab:o}},Ge=async()=>{d||(d=new AudioContext),await d.audioWorklet.addModule(new URL("data:text/javascript;base64,Y2xhc3MgTmVzUHJvY2Vzc29yIGV4dGVuZHMgQXVkaW9Xb3JrbGV0UHJvY2Vzc29yIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKCk7CiAgICB0aGlzLl9xdWV1ZSA9IFtdOwogICAgdGhpcy5faW5kZXggPSAwOwogICAgdGhpcy5wb3J0Lm9ubWVzc2FnZSA9IChlKSA9PiB7CiAgICAgIGNvbnN0IHsgdHlwZSwgZGF0YSB9ID0gZS5kYXRhIHx8IHt9OwogICAgICBpZiAodHlwZSA9PT0gJ3NhbXBsZXMnICYmIGRhdGEgJiYgZGF0YS5idWZmZXIpIHsKICAgICAgICAvLyBkYXRhIGlzIGEgRmxvYXQzMkFycmF5OyBjb3B5IGEgcmVmZXJlbmNlIGJ5IHJldGFpbmluZyBpdHMgYnVmZmVyCiAgICAgICAgdGhpcy5fcXVldWUucHVzaChuZXcgRmxvYXQzMkFycmF5KGRhdGEuYnVmZmVyKSk7CiAgICAgIH0KICAgIH07CiAgfQogIHByb2Nlc3MoaW5wdXRzLCBvdXRwdXRzKSB7CiAgICBjb25zdCBvdXRwdXQgPSBvdXRwdXRzWzBdWzBdOwogICAgbGV0IGkgPSAwOwogICAgd2hpbGUgKGkgPCBvdXRwdXQubGVuZ3RoKSB7CiAgICAgIGlmICh0aGlzLl9xdWV1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICBvdXRwdXRbaSsrXSA9IDA7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29uc3QgY2h1bmsgPSB0aGlzLl9xdWV1ZVswXTsKICAgICAgaWYgKHRoaXMuX2luZGV4ID49IGNodW5rLmxlbmd0aCkgewogICAgICAgIHRoaXMuX3F1ZXVlLnNoaWZ0KCk7CiAgICAgICAgdGhpcy5faW5kZXggPSAwOwogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIG91dHB1dFtpKytdID0gY2h1bmtbdGhpcy5faW5kZXgrK107CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9Cn0KcmVnaXN0ZXJQcm9jZXNzb3IoJ25lcy1wcm9jZXNzb3InLCBOZXNQcm9jZXNzb3IpOwoK",import.meta.url)),C=new AudioWorkletNode(d,"nes-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[1]}),u=new GainNode(d,{gain:D}),C.connect(u),u.connect(d.destination);try{await d.resume()}catch{}},me=256,ge=240;re.width=me;re.height=ge;let ne=te.createImageData(me,ge),Ve=new Uint32Array(ne.data.buffer);const et=()=>{te=re.getContext("2d",{alpha:!1,desynchronized:j}),ne=te.createImageData(me,ge),Ve=new Uint32Array(ne.data.buffer)},tt=(()=>{const e=new Uint32Array(64);for(let t=0;t<64;t++){const[s,o,a]=Ze[t];e[t]=255<<24|a<<16|o<<8|s}return e})();let P=null,w=!1,we=0,Q=0,z=0,de=performance.now(),se=0;const ae=()=>{if(!P)return;const e=performance.now(),t=P;for(let o=0;o<t.length;o++)Ve[o]=tt[t[o]&63];te.putImageData(ne,0,0);const s=performance.now()-e;z=z===0?s:z*.9+s*.1,we++,se++},Ne=e=>{if(w&&(ae(),w=!1),c){const t=performance.now();t-de>1e3&&(c.set("video fps",String(se)),c.set("frames drawn",String(we)),c.set("frames dropped",String(Q)),c.set("draw ms (EMA)",z.toFixed(2)),c.set("frames recv",String(I)),se=0,de=t)}requestAnimationFrame(Ne)};requestAnimationFrame(Ne);L&&L.addEventListener("change",()=>{h.statsEnabled=L.checked,$e(h.statsEnabled)});k&&k.addEventListener("change",()=>{j=k.checked,et()});E&&E.addEventListener("change",()=>{h.lowLat=E.checked,y.textContent=`Low-latency audio ${h.lowLat?"enabled":"disabled"} (applies on next Start)`});S&&S.addEventListener("change",()=>{h.forceNoAudio=S.checked,y.textContent=`No audio ${h.forceNoAudio?"enabled":"disabled"} (applies on next Start)`});window.addEventListener("keydown",e=>{if(i)switch(e.code){case"KeyZ":case"KeyX":case"ShiftLeft":case"Enter":case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":e.preventDefault(),i.postMessage({type:"input",code:e.code,down:!0});break}});window.addEventListener("keyup",e=>{if(i)switch(e.code){case"KeyZ":case"KeyX":case"ShiftLeft":case"Enter":case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":e.preventDefault(),i.postMessage({type:"input",code:e.code,down:!1});break}});Ie.addEventListener("change",async()=>{var t;const e=(t=Ie.files)==null?void 0:t[0];if(e){y.textContent=`Loading ${e.name}...`;try{O=new Uint8Array(await e.arrayBuffer());const s=new URLSearchParams(window.location.search),a=!(s.get("legacy")==="1"||s.get("timing")==="legacy"),n=s.get("strict")==="1";T={useVT:a,strict:n},Y.disabled=!1,A.disabled=!R;const r=(s.get("region")||"").toLowerCase(),p=r==="pal"?"PAL":r==="ntsc"?"NTSC":void 0,g=(s.get("apu_timing")||s.get("aputimings")||"").toLowerCase(),H=g==="fractional"?"fractional":g==="integer"?"integer":void 0,J=(s.get("apu_synth")||s.get("synth")||"").toLowerCase(),W=J==="blep"?"blep":J==="raw"?"raw":void 0;y.textContent=`Ready â€” press Start${a?" (VT timing)":" (legacy timing)"}${p?`, APU ${p}`:""}${H?`, ${H} fc`:""}${W?`, ${W} synth`:""}`,window.__apuRegion=p,window.__apuTiming=H,window.__apuSynth=W}catch(s){y.textContent="Failed to load ROM",console.error(s)}}});Y.addEventListener("click",async()=>{if(!O)return;ze(),De(),Ye();let e=null,t=48e3;const s=q&&!h.forceNoAudio;let o=!1;if(s)try{await Je(),e=qe().sab,t=d.sampleRate,await d.resume()}catch(r){console.warn("Audio setup failed, falling back to no-audio mode:",r),e=null}else if(!h.forceNoAudio&&!q)try{await Ge(),t=(d==null?void 0:d.sampleRate)||48e3,o=!0}catch(r){console.warn("Legacy audio setup failed, continuing without audio:",r),o=!1}i=new Worker(new URL("/ai-nes-gpt5/assets/nesCore.worker-BfDMWFQQ.js",import.meta.url),{type:"module"}),i.onmessage=r=>{const p=r.data||{};if(p.type==="ppu-frame")w&&Q++,P=p.indices,w=!0,I++,performance.now(),j&&(ae(),w=!1);else if(p.type!=="worker-stats"){if(p.type==="audio-chunk"&&C){const g=new Float32Array(p.samples);C.port.postMessage({type:"samples",data:g},[g.buffer])}}};const a=Ae>0?Ae:h.lowLat?768:1024;i.postMessage({type:"init",sab:e?{controlSAB:e.controlSAB,dataSAB:e.dataSAB,dataByteOffset:e.dataByteOffset??0}:null,sampleRate:t,channels:1,targetFillFrames:a,noAudio:!e&&!o,useLegacy:o}),i.onerror=r=>{console.error("[worker] error",r.message,r.error)},i.onmessageerror=r=>{console.error("[worker] messageerror",r.data)};{const r=new Uint8Array(O);i.postMessage({type:"load_rom",rom:r,useVT:T.useVT,strict:T.strict,apuRegion:window.__apuRegion,apuTiming:window.__apuTiming,apuSynth:window.__apuSynth},[r.buffer])}i.postMessage({type:"start"}),R=!0,Y.disabled=!0,A.disabled=!1,A.textContent="Pause",y.textContent=e?"Running":o?"Running (legacy audio)":"Running (no audio)";const n=performance.now();setTimeout(()=>{I===0&&R&&performance.now()-n>=1900&&(y.textContent="No video frames received yet. Enable the Stats overlay and check the console for worker errors."),q&&!h.forceNoAudio&&fe<n&&I<=1&&R&&(console.warn("[audio] suspected stall at startup; switching to legacy audio fallback"),nt("startup stall"))},1800),setTimeout(()=>{if(I===0&&R&&performance.now()-n>=3e3){if(console.warn("[video] No frames received after 3s, attempting video-only restart"),y.textContent="Restarting in video-only mode...",i==null||i.terminate(),i=new Worker(new URL("/ai-nes-gpt5/assets/nesCore.worker-BfDMWFQQ.js",import.meta.url),{type:"module"}),i.onmessage=r=>{const p=r.data||{};p.type==="ppu-frame"&&(w&&Q++,P=p.indices,w=!0,I++,performance.now(),j&&(ae(),w=!1))},i.postMessage({type:"init",sab:null,sampleRate:48e3,channels:1,targetFillFrames:2048,noAudio:!0}),O){const r=new Uint8Array(O);i.postMessage({type:"load_rom",rom:r,useVT:T.useVT,strict:T.strict,apuRegion:window.__apuRegion,apuTiming:window.__apuTiming,apuSynth:window.__apuSynth},[r.buffer])}i.postMessage({type:"start"}),y.textContent="Running (video-only fallback)"}},3e3)});A.addEventListener("click",()=>{i&&(R?(R=!1,Y.disabled=!1,A.disabled=!1,A.textContent="Resume",y.textContent="Paused",i.postMessage({type:"pause"})):(i.postMessage({type:"start"}),R=!0,Y.disabled=!0,A.disabled=!1,A.textContent="Pause",y.textContent="Running"))});const nt=async e=>{try{l==null||l.disconnect()}catch{}try{u==null||u.disconnect()}catch{}l=null,u=null;const t=i;try{t==null||t.terminate()}catch{}await Ge(),i=new Worker(new URL("/ai-nes-gpt5/assets/nesCore.worker-BfDMWFQQ.js",import.meta.url),{type:"module"}),i.onmessage=a=>{const n=a.data||{};if(n.type==="ppu-frame")w&&Q++,P=n.indices,w=!0,I++,performance.now(),ae(),w=!1;else if(n.type==="worker-stats")le(n);else if(n.type==="audio-chunk"&&C){const r=new Float32Array(n.samples);C.port.postMessage({type:"samples",data:r},[r.buffer])}},i.onerror=a=>{console.error("[worker] error (legacy)",a.message,a.error)},i.onmessageerror=a=>{console.error("[worker] messageerror (legacy)",a.data)};const s=(d==null?void 0:d.sampleRate)||48e3;if(i.postMessage({type:"init",sab:null,sampleRate:s,channels:1,targetFillFrames:2048,noAudio:!1,useLegacy:!0}),O){const a=new Uint8Array(O);i.postMessage({type:"load_rom",rom:a,useVT:T.useVT,strict:T.strict,apuRegion:window.__apuRegion,apuTiming:window.__apuTiming,apuSynth:window.__apuSynth},[a.buffer])}i.postMessage({type:"start"}),y.textContent=`Running (legacy audio, fallback: ${e})`};
