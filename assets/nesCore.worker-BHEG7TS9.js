var fs=Object.defineProperty;var us=(_,D,E)=>D in _?fs(_,D,{enumerable:!0,configurable:!0,writable:!0,value:E}):_[D]=E;var h=(_,D,E)=>us(_,typeof D!="symbol"?D+"":D,E);(function(){"use strict";var _={};class D{constructor(){h(this,"ram",new Uint8Array(2048));h(this,"readIO",()=>0);h(this,"writeIO",()=>{});h(this,"cartRead",()=>0);h(this,"cartWrite",()=>{});try{const t=typeof process<"u"?_:void 0,s=t==null?void 0:t.NES_RAM_INIT;if(s){const a=parseInt(s,16)&255;this.ram.fill(a)}}catch{}}loadRAM(t,s=0){const a=Math.min(this.ram.length-(s|0),t.length);a>0&&this.ram.set(t.subarray(0,a),s|0)}connectIO(t,s){this.readIO=t,this.writeIO=s}connectCart(t,s){this.cartRead=t,this.cartWrite=s}read(t){return t&=65535,t<8192?this.ram[t&2047]:t<16384?this.readIO(8192+(t&7)):t<16416?this.readIO(t):this.cartRead(t)}write(t,s){if(t&=65535,s&=255,t<8192){this.ram[t&2047]=s;return}if(t<16384){this.writeIO(8192+(t&7),s);return}if(t<16416){this.writeIO(t,s);return}this.cartWrite(t,s)}}var E={};const b=1,Y=2,$=4,Ct=8,V=16,z=32,O=64,st=128;class Dt{constructor(t){h(this,"state");h(this,"nmiPending",!1);h(this,"irqPending",!1);h(this,"irqLine",!1);h(this,"jammed",!1);h(this,"illegalMode","lenient");h(this,"irqInhibitNext",!1);h(this,"delayedIrqPending",!1);h(this,"tracePC",new Array(64).fill(0));h(this,"traceIdx",0);h(this,"traceHook",null);h(this,"spTraceEnabled",!1);h(this,"spTraceStart",0);h(this,"spTraceEnd",0);h(this,"traceStackWritesEnabled",!1);h(this,"traceStackTopMatch",null);h(this,"extraTraceHook",null);h(this,"lastEA",null);h(this,"lastCrossed",!1);h(this,"cycleHook",null);h(this,"busAccessCountCurr",0);h(this,"lastBusAccessCount",0);h(this,"brkPushDelta",1);this.bus=t,this.state={a:0,x:0,y:0,s:253,pc:0,p:36,cycles:0};try{const s=typeof process<"u"?E:void 0;if(s&&typeof s.TRACE_SP_WINDOW=="string"&&s.TRACE_SP_WINDOW.length>0){const a=/^(0x)?([0-9a-fA-F]+)-(0x)?([0-9a-fA-F]+)$/.exec(s.TRACE_SP_WINDOW);if(a){const c=parseInt(a[2],16)&65535,o=parseInt(a[4],16)&65535;this.spTraceStart=Math.min(c,o),this.spTraceEnd=Math.max(c,o),this.spTraceEnabled=!0}}s&&s.TRACE_STACK_WRITES==="1"&&(this.traceStackWritesEnabled=!0);try{const a=s==null?void 0:s.TRACE_STACK_TOP_MATCH;if(a&&a.length>0){const c=parseInt(a,16)&65535;this.traceStackTopMatch=c}}catch{}}catch{}}setTraceHook(t){this.traceHook=t}setExtraTraceHook(t){this.extraTraceHook=t}getRecentPCs(t=16){const s=Math.min(t,this.tracePC.length,this.traceIdx),a=[];for(let c=this.traceIdx-s;c<this.traceIdx;c++)a.push(this.tracePC[c&63]);return a}reset(t){this.state={a:0,x:0,y:0,s:253,pc:t&65535,p:36,cycles:0},this.nmiPending=!1,this.irqPending=!1,this.jammed=!1,this.irqInhibitNext=!1,this.delayedIrqPending=!1}setIllegalMode(t){this.illegalMode=t}requestNMI(){this.nmiPending=!0}requestIRQ(){this.irqLine=!0}setIrqLine(t){this.irqLine=!!t}addCycles(t){this.state.cycles+=t}setCycleHook(t){this.cycleHook=t}getLastBusAccessCount(){return this.lastBusAccessCount}setBrkReturnMode(t){this.brkPushDelta=t==="pc+2"?1:0}incCycle(t=1){if(!(t<=0)&&(this.state.cycles+=t,this.cycleHook))try{this.cycleHook(t)}catch{}}read(t){const s=t&65535,a=this.bus.read(s)&255;try{const c=typeof process<"u"?E:void 0;if(c&&c.TRACE_2002_READS==="1"&&s>=8192&&s<16384&&(s&7)===2){let o=!0;const r=c.TRACE_2002_WINDOW;if(r){const n=/^(\d+)-(\d+)$/.exec(r);if(n){const d=parseInt(n[1],10)|0,e=parseInt(n[2],10)|0,i=this.state.cycles|0;o=i>=d&&i<=e}}o&&console.log(`[cpu] read $2002 => $${a.toString(16).padStart(2,"0")} at pc=$${this.state.pc.toString(16).padStart(4,"0")} cycles=${this.state.cycles}`)}}catch{}return this.busAccessCountCurr++,this.incCycle(1),a}write(t,s){const a=t&65535;if(this.bus.write(a,s&255),this.traceStackWritesEnabled&&(a&65280)===256){const c=this.state.pc&65535;if(!this.spTraceEnabled||c>=this.spTraceStart&&c<=this.spTraceEnd)try{console.log(`[stackwr] PC=$${c.toString(16).padStart(4,"0")} [$${a.toString(16).padStart(4,"0")}] <= $${(s&255).toString(16).padStart(2,"0")}`)}catch{}}this.busAccessCountCurr++,this.incCycle(1);try{const c=typeof process<"u"?E:void 0,o=c==null?void 0:c.TRACE_WRITE_WINDOW,r=c==null?void 0:c.TRACE_WRITE_ADDRS;if(o){const n=/^(\d+)-(\d+)$/.exec(o);if(n){const d=parseInt(n[1],10)|0,e=parseInt(n[2],10)|0,i=this.state.cycles|0;if(i>=d&&i<=e){let l=!0;r&&(l=new Set(r.split(",").map(f=>parseInt(f.trim(),16)&65535)).has(t&65535)),l&&console.log(`[cpu] write $${(t&65535).toString(16).padStart(4,"0")} <= $${(s&255).toString(16).padStart(2,"0")} at cyc=${i}`)}}}}catch{}}read16(t){const s=this.read(t),a=this.read(t+1&65535);return s|a<<8}fetch8(){const t=this.read(this.state.pc);return this.state.pc=this.state.pc+1&65535,t}fetch16(){const t=this.fetch8(),s=this.fetch8();return t|s<<8}interrupt(t){const s=this.state.pc;this.push16(s),this.push8(this.state.p&~V|z),this.setFlag($,!0),this.state.pc=t&65535,this.incCycle(2)}push8(t){this.write(256+this.state.s,t),this.state.s=this.state.s-1&255}pop8(){return this.state.s=this.state.s+1&255,this.read(256+this.state.s)}push16(t){this.push8(t>>>8&255),this.push8(t&255)}pop16(){const t=this.pop8(),s=this.pop8();return t|s<<8}setZN(t){const s=this.state.p;this.state.p=s&-131|(t===0?Y:0)|t&128}getFlag(t){return(this.state.p&t)!==0}setFlag(t,s){const a=this.state.p;this.state.p=a&~t|(s?t:0);try{const c=typeof process<"u"?E:void 0;if(c&&c.TRACE_I_CHANGES==="1"&&t===$){const o=(a&$)!==0,r=(this.state.p&$)!==0;o!==r&&console.log(`[cpu] I change ${o?"1->0":"0->1"} at cycles=${this.state.cycles}`)}}catch{}}aslByte(t){const s=(t&128)!==0,a=t<<1&255;return this.setFlag(b,s),a}lsrByte(t){const s=(t&1)!==0,a=t>>>1&255;return this.setFlag(b,s),a}rolByte(t){const s=this.getFlag(b),a=(t&128)!==0,c=(t<<1|(s?1:0))&255;return this.setFlag(b,a),c}rorByte(t){const s=this.getFlag(b),a=(t&1)!==0,c=(t>>>1|(s?128:0))&255;return this.setFlag(b,a),c}adrIMM(){return{value:this.fetch8(),crossed:!1}}adrZP(){const t=this.fetch8();return this.lastEA=t,this.lastCrossed=!1,{addr:t,crossed:!1}}adrZPX(){const t=this.fetch8()+this.state.x&255;return this.lastEA=t,this.lastCrossed=!1,{addr:t,crossed:!1}}adrZPY(){const t=this.fetch8()+this.state.y&255;return this.lastEA=t,this.lastCrossed=!1,{addr:t,crossed:!1}}adrABS(){const t=this.fetch16();return this.lastEA=t,this.lastCrossed=!1,{addr:t,crossed:!1}}adrABSX(){const t=this.fetch16(),s=t+this.state.x&65535,a=(t&65280)!==(s&65280);return this.lastEA=s,this.lastCrossed=a,{addr:s,crossed:a}}adrABSY(){const t=this.fetch16(),s=t+this.state.y&65535,a=(t&65280)!==(s&65280);return this.lastEA=s,this.lastCrossed=a,{addr:s,crossed:a}}adrIND(){const t=this.fetch16(),s=this.read(t),a=t&65280|t+1&255,c=this.read(a),o=s|c<<8;return this.lastEA=o,this.lastCrossed=!1,{addr:o,crossed:!1}}adrINDX(){const t=this.fetch8()+this.state.x&255,s=this.read(t),a=this.read(t+1&255),c=s|a<<8;return this.lastEA=c,this.lastCrossed=!1,{addr:c,crossed:!1}}adrINDY(){const t=this.fetch8(),s=this.read(t),a=this.read(t+1&255),c=s|a<<8,o=c+this.state.y&65535,r=(c&65280)!==(o&65280);return this.lastEA=o,this.lastCrossed=r,{addr:o,crossed:r}}adc(t){const s=this.state.a,a=this.getFlag(b)?1:0,c=s+t+a,o=c&255;this.setFlag(b,c>255);const r=(~(s^t)&(s^o)&128)!==0;this.setFlag(O,r),this.state.a=o,this.setZN(this.state.a)}cmp(t,s){const a=t-s&255;this.setFlag(b,t>=s),this.setZN(a)}sbc(t){this.adc((t^255)&255)}serviceInterrupts(){if(this.nmiPending){this.nmiPending=!1;const t=this.read16(65530);try{const s=typeof process<"u"?E:void 0;s&&s.TRACE_IRQ_VECTOR==="1"&&console.log(`[cpu] NMI vector taken pc=$${this.state.pc.toString(16).padStart(4,"0")} cycles=${this.state.cycles} p=$${this.state.p.toString(16).padStart(2,"0")}`)}catch{}return this.interrupt(t),!0}if(this.delayedIrqPending){this.delayedIrqPending=!1;const t=this.read16(65534);try{const s=typeof process<"u"?E:void 0;s&&s.TRACE_IRQ_VECTOR==="1"&&console.log(`[cpu] IRQ vector taken (delayed from CLI) pc=$${this.state.pc.toString(16).padStart(4,"0")} cycles=${this.state.cycles} p=$${this.state.p.toString(16).padStart(2,"0")}`)}catch{}return this.interrupt(t),!0}if(this.irqLine&&!this.getFlag($)){const t=this.read16(65534);try{const s=typeof process<"u"?E:void 0;s&&s.TRACE_IRQ_VECTOR==="1"&&console.log(`[cpu] IRQ vector taken (normal) pc=$${this.state.pc.toString(16).padStart(4,"0")} cycles=${this.state.cycles} p=$${this.state.p.toString(16).padStart(2,"0")}`)}catch{}return this.interrupt(t),!0}try{const t=typeof process<"u"?E:void 0,s=t==null?void 0:t.TRACE_IRQ_MASKED_WINDOW;if(s&&this.irqLine&&this.getFlag($)){const a=/^(\d+)-(\d+)$/.exec(s);if(a){const c=parseInt(a[1],10)|0,o=parseInt(a[2],10)|0,r=this.state.cycles|0;r>=c&&r<=o&&console.log(`[cpu] IRQ masked (I=1) pc=$${this.state.pc.toString(16).padStart(4,"0")} cycles=${r} p=$${this.state.p.toString(16).padStart(2,"0")}`)}}}catch{}return!1}step(){if(this.jammed)return;const t=this.state.cycles|0;let s=!1;try{const e=typeof process<"u"?E:void 0,i=e==null?void 0:e.TRACE_PC_WINDOW;if(i){const l=/^(\d+)-(\d+)$/.exec(i);if(l){const p=parseInt(l[1],10)|0,f=parseInt(l[2],10)|0,u=this.state.cycles|0;s=u>=p&&u<=f}}}catch{}const a=this.bus.read(this.state.pc)&255;if(this.illegalMode==="strict")switch(a){case 2:case 18:case 34:case 50:case 66:case 82:case 98:case 114:case 146:case 178:case 210:case 242:this.jammed=!0;return}try{const e=typeof process<"u"?E:void 0;if(e&&e.TRACE_IRQ_DECISION==="1"){let i=!0;const l=e.TRACE_DECISION_WINDOW;if(l){const p=/^(\d+)-(\d+)$/.exec(l);if(p){const f=parseInt(p[1],10)|0,u=parseInt(p[2],10)|0,g=this.state.cycles|0;i=g>=f&&g<=u}}if(i){const p=this.getFlag($),f=this.irqLine,u=this.irqInhibitNext;let g="no-irq";this.nmiPending?g="nmi":u&&f?g="irq-inhibited":f&&!p?g="irq-normal":f&&p&&(g="irq-masked"),console.log(`[cpu] IRQ decision pc=$${this.state.pc.toString(16).padStart(4,"0")} cycles=${this.state.cycles} I=${p?1:0} line=${f?1:0} inhibit=${u?1:0} -> ${g}`)}}}catch{}if(!this.irqInhibitNext&&this.serviceInterrupts())return;this.irqInhibitNext=!1;const c=this.state.pc;if(this.spTraceEnabled){const e=c&65535;if(e>=this.spTraceStart&&e<=this.spTraceEnd)try{console.log(`[sp] pre  PC=$${e.toString(16).padStart(4,"0")} SP=$${this.state.s.toString(16).padStart(2,"0")} P=$${this.state.p.toString(16).padStart(2,"0")} A=$${this.state.a.toString(16).padStart(2,"0")} X=$${this.state.x.toString(16).padStart(2,"0")} Y=$${this.state.y.toString(16).padStart(2,"0")}`)}catch{}}this.busAccessCountCurr=0,this.lastEA=null,this.lastCrossed=!1,this.tracePC[this.traceIdx&63]=c,this.traceIdx++;const o=this.fetch8();if(s)try{console.log(`[trace] pc=$${c.toString(16).padStart(4,"0")} op=$${o.toString(16).padStart(2,"0")} p=$${this.state.p.toString(16).padStart(2,"0")} cyc=${this.state.cycles}`)}catch{}if(this.traceHook)try{this.traceHook(c,o)}catch{}const r=this.state;let n=0;switch(o){case 234:n+=2;break;case 169:{const{value:e}=this.adrIMM();r.a=e,this.setZN(r.a),n+=2;break}case 165:{const{addr:e}=this.adrZP();r.a=this.read(e),this.setZN(r.a),n+=3;break}case 181:{const{addr:e}=this.adrZPX();r.a=this.read(e),this.setZN(r.a),n+=4;break}case 173:{const{addr:e}=this.adrABS();r.a=this.read(e),this.setZN(r.a),n+=4;break}case 189:{const{addr:e,crossed:i}=this.adrABSX();r.a=this.read(e),this.setZN(r.a),n+=4+(i?1:0);break}case 185:{const{addr:e,crossed:i}=this.adrABSY();r.a=this.read(e),this.setZN(r.a),n+=4+(i?1:0);break}case 161:{const{addr:e}=this.adrINDX();r.a=this.read(e),this.setZN(r.a),n+=6;break}case 177:{const{addr:e,crossed:i}=this.adrINDY();r.a=this.read(e),this.setZN(r.a),n+=5+(i?1:0);break}case 162:{const{value:e}=this.adrIMM();r.x=e,this.setZN(r.x),n+=2;break}case 166:{const{addr:e}=this.adrZP();r.x=this.read(e),this.setZN(r.x),n+=3;break}case 182:{const{addr:e}=this.adrZPY();r.x=this.read(e),this.setZN(r.x),n+=4;break}case 174:{const{addr:e}=this.adrABS();r.x=this.read(e),this.setZN(r.x),n+=4;break}case 190:{const{addr:e,crossed:i}=this.adrABSY();r.x=this.read(e),this.setZN(r.x),n+=4+(i?1:0);break}case 160:{const{value:e}=this.adrIMM();r.y=e,this.setZN(r.y),n+=2;break}case 164:{const{addr:e}=this.adrZP();r.y=this.read(e),this.setZN(r.y),n+=3;break}case 180:{const{addr:e}=this.adrZPX();r.y=this.read(e),this.setZN(r.y),n+=4;break}case 172:{const{addr:e}=this.adrABS();r.y=this.read(e),this.setZN(r.y),n+=4;break}case 188:{const{addr:e,crossed:i}=this.adrABSX();r.y=this.read(e),this.setZN(r.y),n+=4+(i?1:0);break}case 133:{const{addr:e}=this.adrZP();this.write(e,r.a),n+=3;break}case 149:{const{addr:e}=this.adrZPX();this.write(e,r.a),n+=4;break}case 141:{const{addr:e}=this.adrABS();this.write(e,r.a),n+=4;break}case 157:{const{addr:e}=this.adrABSX();this.write(e,r.a),n+=5;break}case 153:{const{addr:e}=this.adrABSY();this.write(e,r.a),n+=5;break}case 129:{const{addr:e}=this.adrINDX();this.write(e,r.a),n+=6;break}case 145:{const{addr:e}=this.adrINDY();this.write(e,r.a),n+=6;break}case 135:{const{addr:e}=this.adrZP();this.write(e,r.a&r.x),n+=3;break}case 151:{const{addr:e}=this.adrZPY();this.write(e,r.a&r.x),n+=4;break}case 143:{const{addr:e}=this.adrABS();this.write(e,r.a&r.x),n+=4;break}case 131:{const{addr:e}=this.adrINDX();this.write(e,r.a&r.x),n+=6;break}case 134:{const{addr:e}=this.adrZP();this.write(e,r.x),n+=3;break}case 150:{const{addr:e}=this.adrZPY();this.write(e,r.x),n+=4;break}case 142:{const{addr:e}=this.adrABS();this.write(e,r.x),n+=4;break}case 132:{const{addr:e}=this.adrZP();this.write(e,r.y),n+=3;break}case 148:{const{addr:e}=this.adrZPX();this.write(e,r.y),n+=4;break}case 140:{const{addr:e}=this.adrABS();this.write(e,r.y),n+=4;break}case 170:r.x=r.a,this.setZN(r.x),n+=2;break;case 168:r.y=r.a,this.setZN(r.y),n+=2;break;case 138:r.a=r.x,this.setZN(r.a),n+=2;break;case 152:r.a=r.y,this.setZN(r.a),n+=2;break;case 186:r.x=r.s,this.setZN(r.x),n+=2;break;case 154:r.s=r.x,n+=2;break;case 72:this.push8(r.a),n+=3;break;case 104:r.a=this.pop8(),this.setZN(r.a),n+=4;break;case 8:this.push8((r.p|z|V)&255),n+=3;break;case 40:{const e=this.getFlag($);r.p=this.pop8()&~V|z;const i=(r.p&$)!==0;e&&!i&&this.irqLine&&(this.irqInhibitNext=!0,this.delayedIrqPending=!0),n+=4;break}case 41:{const{value:e}=this.adrIMM();r.a=r.a&e,this.setZN(r.a),n+=2;break}case 37:{const{addr:e}=this.adrZP();r.a=r.a&this.read(e),this.setZN(r.a),n+=3;break}case 53:{const{addr:e}=this.adrZPX();r.a=r.a&this.read(e),this.setZN(r.a),n+=4;break}case 45:{const{addr:e}=this.adrABS();r.a=r.a&this.read(e),this.setZN(r.a),n+=4;break}case 61:{const{addr:e,crossed:i}=this.adrABSX();r.a=r.a&this.read(e),this.setZN(r.a),n+=4+(i?1:0);break}case 57:{const{addr:e,crossed:i}=this.adrABSY();r.a=r.a&this.read(e),this.setZN(r.a),n+=4+(i?1:0);break}case 33:{const{addr:e}=this.adrINDX();r.a=r.a&this.read(e),this.setZN(r.a),n+=6;break}case 49:{const{addr:e,crossed:i}=this.adrINDY();r.a=r.a&this.read(e),this.setZN(r.a),n+=5+(i?1:0);break}case 9:{const{value:e}=this.adrIMM();r.a=r.a|e,this.setZN(r.a),n+=2;break}case 5:{const{addr:e}=this.adrZP();r.a=r.a|this.read(e),this.setZN(r.a),n+=3;break}case 21:{const{addr:e}=this.adrZPX();r.a=r.a|this.read(e),this.setZN(r.a),n+=4;break}case 13:{const{addr:e}=this.adrABS();r.a=r.a|this.read(e),this.setZN(r.a),n+=4;break}case 29:{const{addr:e,crossed:i}=this.adrABSX();r.a=r.a|this.read(e),this.setZN(r.a),n+=4+(i?1:0);break}case 25:{const{addr:e,crossed:i}=this.adrABSY();r.a=r.a|this.read(e),this.setZN(r.a),n+=4+(i?1:0);break}case 1:{const{addr:e}=this.adrINDX();r.a=r.a|this.read(e),this.setZN(r.a),n+=6;break}case 17:{const{addr:e,crossed:i}=this.adrINDY();r.a=r.a|this.read(e),this.setZN(r.a),n+=5+(i?1:0);break}case 167:{const{addr:e}=this.adrZP(),i=this.read(e);r.a=i,r.x=i,this.setZN(i),n+=3;break}case 187:{const{addr:e,crossed:i}=this.adrABSY(),p=this.read(e)&r.s;r.a=p,r.x=p,r.s=p,this.setZN(r.a),n+=4+(i?1:0);break}case 183:{const{addr:e}=this.adrZPY(),i=this.read(e);r.a=i,r.x=i,this.setZN(i),n+=4;break}case 175:{const{addr:e}=this.adrABS(),i=this.read(e);r.a=i,r.x=i,this.setZN(i),n+=4;break}case 191:{const{addr:e,crossed:i}=this.adrABSY(),l=this.read(e);r.a=l,r.x=l,this.setZN(l),n+=4+(i?1:0);break}case 163:{const{addr:e}=this.adrINDX(),i=this.read(e);r.a=i,r.x=i,this.setZN(i),n+=6;break}case 179:{const{addr:e,crossed:i}=this.adrINDY(),l=this.read(e);r.a=l,r.x=l,this.setZN(l),n+=5+(i?1:0);break}case 171:{const{value:e}=this.adrIMM(),i=e;r.a=i,r.x=i,this.setZN(i),n+=2;break}case 73:{const{value:e}=this.adrIMM();r.a=r.a^e,this.setZN(r.a),n+=2;break}case 69:{const{addr:e}=this.adrZP();r.a=r.a^this.read(e),this.setZN(r.a),n+=3;break}case 85:{const{addr:e}=this.adrZPX();r.a=r.a^this.read(e),this.setZN(r.a),n+=4;break}case 77:{const{addr:e}=this.adrABS();r.a=r.a^this.read(e),this.setZN(r.a),n+=4;break}case 93:{const{addr:e,crossed:i}=this.adrABSX();r.a=r.a^this.read(e),this.setZN(r.a),n+=4+(i?1:0);break}case 89:{const{addr:e,crossed:i}=this.adrABSY();r.a=r.a^this.read(e),this.setZN(r.a),n+=4+(i?1:0);break}case 65:{const{addr:e}=this.adrINDX();r.a=r.a^this.read(e),this.setZN(r.a),n+=6;break}case 81:{const{addr:e,crossed:i}=this.adrINDY();r.a=r.a^this.read(e),this.setZN(r.a),n+=5+(i?1:0);break}case 11:case 43:{const{value:e}=this.adrIMM();r.a=r.a&e,this.setZN(r.a),this.setFlag(b,(r.a&128)!==0),n+=2;break}case 105:{const{value:e}=this.adrIMM();this.adc(e),n+=2;break}case 101:{const{addr:e}=this.adrZP();this.adc(this.read(e)),n+=3;break}case 117:{const{addr:e}=this.adrZPX();this.adc(this.read(e)),n+=4;break}case 109:{const{addr:e}=this.adrABS();this.adc(this.read(e)),n+=4;break}case 125:{const{addr:e,crossed:i}=this.adrABSX();this.adc(this.read(e)),n+=4+(i?1:0);break}case 121:{const{addr:e,crossed:i}=this.adrABSY();this.adc(this.read(e)),n+=4+(i?1:0);break}case 97:{const{addr:e}=this.adrINDX();this.adc(this.read(e)),n+=6;break}case 113:{const{addr:e,crossed:i}=this.adrINDY();this.adc(this.read(e)),n+=5+(i?1:0);break}case 233:case 235:{const{value:e}=this.adrIMM();this.sbc(e),n+=2;break}case 229:{const{addr:e}=this.adrZP();this.sbc(this.read(e)),n+=3;break}case 245:{const{addr:e}=this.adrZPX();this.sbc(this.read(e)),n+=4;break}case 237:{const{addr:e}=this.adrABS();this.sbc(this.read(e)),n+=4;break}case 253:{const{addr:e,crossed:i}=this.adrABSX();this.sbc(this.read(e)),n+=4+(i?1:0);break}case 249:{const{addr:e,crossed:i}=this.adrABSY();this.sbc(this.read(e)),n+=4+(i?1:0);break}case 225:{const{addr:e}=this.adrINDX();this.sbc(this.read(e)),n+=6;break}case 241:{const{addr:e,crossed:i}=this.adrINDY();this.sbc(this.read(e)),n+=5+(i?1:0);break}case 230:{const{addr:e}=this.adrZP(),i=this.read(e)+1&255;this.write(e,i),this.setZN(i),n+=5;break}case 246:{const{addr:e}=this.adrZPX(),i=this.read(e)+1&255;this.write(e,i),this.setZN(i),n+=6;break}case 238:{const{addr:e}=this.adrABS(),i=this.read(e)+1&255;this.write(e,i),this.setZN(i),n+=6;break}case 254:{const{addr:e}=this.adrABSX(),i=this.read(e)+1&255;this.write(e,i),this.setZN(i),n+=7;break}case 198:{const{addr:e}=this.adrZP(),i=this.read(e)-1&255;this.write(e,i),this.setZN(i),n+=5;break}case 214:{const{addr:e}=this.adrZPX(),i=this.read(e)-1&255;this.write(e,i),this.setZN(i),n+=6;break}case 206:{const{addr:e}=this.adrABS(),i=this.read(e)-1&255;this.write(e,i),this.setZN(i),n+=6;break}case 222:{const{addr:e}=this.adrABSX(),i=this.read(e)-1&255;this.write(e,i),this.setZN(i),n+=7;break}case 232:r.x=r.x+1&255,this.setZN(r.x),n+=2;break;case 200:r.y=r.y+1&255,this.setZN(r.y),n+=2;break;case 202:r.x=r.x-1&255,this.setZN(r.x),n+=2;break;case 136:r.y=r.y-1&255,this.setZN(r.y),n+=2;break;case 75:{const{value:e}=this.adrIMM();let i=r.a&e;const l=(i&1)!==0;i=i>>>1&255,r.a=i,this.setFlag(b,l),this.setZN(r.a),n+=2;break}case 107:{const{value:e}=this.adrIMM(),i=this.getFlag(b);let p=((r.a&e)>>>1|(i?128:0))&255;r.a=p,this.setZN(r.a),this.setFlag(b,(p&64)!==0),this.setFlag(O,((p^p<<1&255)&64)!==0),n+=2;break}case 10:{const e=(r.a&128)!==0;r.a=r.a<<1&255,this.setFlag(b,e),this.setZN(r.a),n+=2;break}case 74:{const e=(r.a&1)!==0;r.a=r.a>>>1&255,this.setFlag(b,e),this.setZN(r.a),n+=2;break}case 42:{const e=this.getFlag(b),i=(r.a&128)!==0;r.a=(r.a<<1|(e?1:0))&255,this.setFlag(b,i),this.setZN(r.a),n+=2;break}case 106:{const e=this.getFlag(b),i=(r.a&1)!==0;r.a=(r.a>>>1|(e?128:0))&255,this.setFlag(b,i),this.setZN(r.a),n+=2;break}case 6:{const{addr:e}=this.adrZP();let i=this.read(e);const l=(i&128)!==0;i=i<<1&255,this.write(e,i),this.setFlag(b,l),this.setZN(i),n+=5;break}case 156:{const e=this.fetch16(),i=e&255,l=e>>>8&255,p=i+r.x&255,f=(l<<8|p)&65535,u=l+1&255,g=r.y&u;this.write(f,g),n+=5;break}case 158:{const e=this.fetch16(),i=e&255,l=e>>>8&255,p=i+r.y&255,f=(l<<8|p)&65535,u=l+1&255,g=r.x&u;this.write(f,g),n+=5;break}case 155:{const e=this.fetch16(),i=e&255,l=e>>>8&255,p=i+r.y&255,f=(l<<8|p)&65535;r.s=r.a&r.x;const u=l+1&255,g=r.s&u;this.write(f,g),n+=5;break}case 159:{const e=this.fetch16(),i=e&255,l=e>>>8&255,p=i+r.y&255,f=(l<<8|p)&65535,u=l+1&255,g=r.a&r.x&u;this.write(f,g),n+=5;break}case 147:{const e=this.fetch8(),i=this.read(e),l=this.read(e+1&255),p=i|l<<8,f=p+r.y&65535,u=(p>>8&255)+1&255,g=r.a&r.x&u;this.write(f,g),n+=6;break}case 22:{const{addr:e}=this.adrZPX();let i=this.read(e);const l=(i&128)!==0;i=i<<1&255,this.write(e,i),this.setFlag(b,l),this.setZN(i),n+=6;break}case 14:{const{addr:e}=this.adrABS();let i=this.read(e);const l=(i&128)!==0;i=i<<1&255,this.write(e,i),this.setFlag(b,l),this.setZN(i),n+=6;break}case 30:{const{addr:e}=this.adrABSX();let i=this.read(e);const l=(i&128)!==0;i=i<<1&255,this.write(e,i),this.setFlag(b,l),this.setZN(i),n+=7;break}case 70:{const{addr:e}=this.adrZP();let i=this.read(e);const l=(i&1)!==0;i=i>>>1&255,this.write(e,i),this.setFlag(b,l),this.setZN(i),n+=5;break}case 86:{const{addr:e}=this.adrZPX();let i=this.read(e);const l=(i&1)!==0;i=i>>>1&255,this.write(e,i),this.setFlag(b,l),this.setZN(i),n+=6;break}case 78:{const{addr:e}=this.adrABS();let i=this.read(e);const l=(i&1)!==0;i=i>>>1&255,this.write(e,i),this.setFlag(b,l),this.setZN(i),n+=6;break}case 94:{const{addr:e}=this.adrABSX();let i=this.read(e);const l=(i&1)!==0;i=i>>>1&255,this.write(e,i),this.setFlag(b,l),this.setZN(i),n+=7;break}case 38:{const{addr:e}=this.adrZP();let i=this.read(e);const l=this.getFlag(b),p=(i&128)!==0;i=(i<<1|(l?1:0))&255,this.write(e,i),this.setFlag(b,p),this.setZN(i),n+=5;break}case 54:{const{addr:e}=this.adrZPX();let i=this.read(e);const l=this.getFlag(b),p=(i&128)!==0;i=(i<<1|(l?1:0))&255,this.write(e,i),this.setFlag(b,p),this.setZN(i),n+=6;break}case 46:{const{addr:e}=this.adrABS();let i=this.read(e);const l=this.getFlag(b),p=(i&128)!==0;i=(i<<1|(l?1:0))&255,this.write(e,i),this.setFlag(b,p),this.setZN(i),n+=6;break}case 62:{const{addr:e}=this.adrABSX();let i=this.read(e);const l=this.getFlag(b),p=(i&128)!==0;i=(i<<1|(l?1:0))&255,this.write(e,i),this.setFlag(b,p),this.setZN(i),n+=7;break}case 102:{const{addr:e}=this.adrZP();let i=this.read(e);const l=this.getFlag(b),p=(i&1)!==0;i=(i>>>1|(l?128:0))&255,this.write(e,i),this.setFlag(b,p),this.setZN(i),n+=5;break}case 118:{const{addr:e}=this.adrZPX();let i=this.read(e);const l=this.getFlag(b),p=(i&1)!==0;i=(i>>>1|(l?128:0))&255,this.write(e,i),this.setFlag(b,p),this.setZN(i),n+=6;break}case 110:{const{addr:e}=this.adrABS();let i=this.read(e);const l=this.getFlag(b),p=(i&1)!==0;i=(i>>>1|(l?128:0))&255,this.write(e,i),this.setFlag(b,p),this.setZN(i),n+=6;break}case 126:{const{addr:e}=this.adrABSX();let i=this.read(e);const l=this.getFlag(b),p=(i&1)!==0;i=(i>>>1|(l?128:0))&255,this.write(e,i),this.setFlag(b,p),this.setZN(i),n+=7;break}case 3:{const{addr:e}=this.adrINDX();let i=this.read(e);i=this.aslByte(i),this.write(e,i),r.a=(r.a|i)&255,this.setZN(r.a),n+=8;break}case 7:{const{addr:e}=this.adrZP();let i=this.read(e);i=this.aslByte(i),this.write(e,i),r.a=(r.a|i)&255,this.setZN(r.a),n+=5;break}case 15:{const{addr:e}=this.adrABS();let i=this.read(e);i=this.aslByte(i),this.write(e,i),r.a=(r.a|i)&255,this.setZN(r.a),n+=6;break}case 19:{const{addr:e}=this.adrINDY();let i=this.read(e);i=this.aslByte(i),this.write(e,i),r.a=(r.a|i)&255,this.setZN(r.a),n+=8;break}case 23:{const{addr:e}=this.adrZPX();let i=this.read(e);i=this.aslByte(i),this.write(e,i),r.a=(r.a|i)&255,this.setZN(r.a),n+=6;break}case 27:{const{addr:e}=this.adrABSY();let i=this.read(e);i=this.aslByte(i),this.write(e,i),r.a=(r.a|i)&255,this.setZN(r.a),n+=7;break}case 31:{const{addr:e}=this.adrABSX();let i=this.read(e);i=this.aslByte(i),this.write(e,i),r.a=(r.a|i)&255,this.setZN(r.a),n+=7;break}case 35:{const{addr:e}=this.adrINDX();let i=this.read(e);i=this.rolByte(i),this.write(e,i),r.a=r.a&i&255,this.setZN(r.a),n+=8;break}case 39:{const{addr:e}=this.adrZP();let i=this.read(e);i=this.rolByte(i),this.write(e,i),r.a=r.a&i&255,this.setZN(r.a),n+=5;break}case 47:{const{addr:e}=this.adrABS();let i=this.read(e);i=this.rolByte(i),this.write(e,i),r.a=r.a&i&255,this.setZN(r.a),n+=6;break}case 51:{const{addr:e}=this.adrINDY();let i=this.read(e);i=this.rolByte(i),this.write(e,i),r.a=r.a&i&255,this.setZN(r.a),n+=8;break}case 55:{const{addr:e}=this.adrZPX();let i=this.read(e);i=this.rolByte(i),this.write(e,i),r.a=r.a&i&255,this.setZN(r.a),n+=6;break}case 59:{const{addr:e}=this.adrABSY();let i=this.read(e);i=this.rolByte(i),this.write(e,i),r.a=r.a&i&255,this.setZN(r.a),n+=7;break}case 63:{const{addr:e}=this.adrABSX();let i=this.read(e);i=this.rolByte(i),this.write(e,i),r.a=r.a&i&255,this.setZN(r.a),n+=7;break}case 67:{const{addr:e}=this.adrINDX();let i=this.read(e);i=this.lsrByte(i),this.write(e,i),r.a=(r.a^i)&255,this.setZN(r.a),n+=8;break}case 71:{const{addr:e}=this.adrZP();let i=this.read(e);i=this.lsrByte(i),this.write(e,i),r.a=(r.a^i)&255,this.setZN(r.a),n+=5;break}case 79:{const{addr:e}=this.adrABS();let i=this.read(e);i=this.lsrByte(i),this.write(e,i),r.a=(r.a^i)&255,this.setZN(r.a),n+=6;break}case 83:{const{addr:e}=this.adrINDY();let i=this.read(e);i=this.lsrByte(i),this.write(e,i),r.a=(r.a^i)&255,this.setZN(r.a),n+=8;break}case 87:{const{addr:e}=this.adrZPX();let i=this.read(e);i=this.lsrByte(i),this.write(e,i),r.a=(r.a^i)&255,this.setZN(r.a),n+=6;break}case 91:{const{addr:e}=this.adrABSY();let i=this.read(e);i=this.lsrByte(i),this.write(e,i),r.a=(r.a^i)&255,this.setZN(r.a),n+=7;break}case 95:{const{addr:e}=this.adrABSX();let i=this.read(e);i=this.lsrByte(i),this.write(e,i),r.a=(r.a^i)&255,this.setZN(r.a),n+=7;break}case 99:{const{addr:e}=this.adrINDX();let i=this.read(e);i=this.rorByte(i),this.write(e,i),this.adc(i),n+=8;break}case 103:{const{addr:e}=this.adrZP();let i=this.read(e);i=this.rorByte(i),this.write(e,i),this.adc(i),n+=5;break}case 111:{const{addr:e}=this.adrABS();let i=this.read(e);i=this.rorByte(i),this.write(e,i),this.adc(i),n+=6;break}case 115:{const{addr:e}=this.adrINDY();let i=this.read(e);i=this.rorByte(i),this.write(e,i),this.adc(i),n+=8;break}case 119:{const{addr:e}=this.adrZPX();let i=this.read(e);i=this.rorByte(i),this.write(e,i),this.adc(i),n+=6;break}case 123:{const{addr:e}=this.adrABSY();let i=this.read(e);i=this.rorByte(i),this.write(e,i),this.adc(i),n+=7;break}case 127:{const{addr:e}=this.adrABSX();let i=this.read(e);i=this.rorByte(i),this.write(e,i),this.adc(i),n+=7;break}case 195:{const{addr:e}=this.adrINDX();let i=this.read(e)-1&255;this.write(e,i),this.cmp(r.a,i),n+=8;break}case 199:{const{addr:e}=this.adrZP();let i=this.read(e)-1&255;this.write(e,i),this.cmp(r.a,i),n+=5;break}case 207:{const{addr:e}=this.adrABS();let i=this.read(e)-1&255;this.write(e,i),this.cmp(r.a,i),n+=6;break}case 211:{const{addr:e}=this.adrINDY();let i=this.read(e)-1&255;this.write(e,i),this.cmp(r.a,i),n+=8;break}case 215:{const{addr:e}=this.adrZPX();let i=this.read(e)-1&255;this.write(e,i),this.cmp(r.a,i),n+=6;break}case 219:{const{addr:e}=this.adrABSY();let i=this.read(e)-1&255;this.write(e,i),this.cmp(r.a,i),n+=7;break}case 223:{const{addr:e}=this.adrABSX();let i=this.read(e)-1&255;this.write(e,i),this.cmp(r.a,i),n+=7;break}case 227:{const{addr:e}=this.adrINDX();let i=this.read(e)+1&255;this.write(e,i),this.sbc(i),n+=8;break}case 231:{const{addr:e}=this.adrZP();let i=this.read(e)+1&255;this.write(e,i),this.sbc(i),n+=5;break}case 239:{const{addr:e}=this.adrABS();let i=this.read(e)+1&255;this.write(e,i),this.sbc(i),n+=6;break}case 243:{const{addr:e}=this.adrINDY();let i=this.read(e)+1&255;this.write(e,i),this.sbc(i),n+=8;break}case 247:{const{addr:e}=this.adrZPX();let i=this.read(e)+1&255;this.write(e,i),this.sbc(i),n+=6;break}case 251:{const{addr:e}=this.adrABSY();let i=this.read(e)+1&255;this.write(e,i),this.sbc(i),n+=7;break}case 255:{const{addr:e}=this.adrABSX();let i=this.read(e)+1&255;this.write(e,i),this.sbc(i),n+=7;break}case 36:{const{addr:e}=this.adrZP(),i=this.read(e);this.setFlag(Y,(r.a&i)===0),this.setFlag(O,(i&64)!==0),this.setFlag(st,(i&128)!==0),n+=3;break}case 44:{const{addr:e}=this.adrABS(),i=this.read(e);this.setFlag(Y,(r.a&i)===0),this.setFlag(O,(i&64)!==0),this.setFlag(st,(i&128)!==0),n+=4;break}case 137:{this.fetch8(),n+=2;break}case 201:{const{value:e}=this.adrIMM();this.cmp(r.a,e),n+=2;break}case 197:{const{addr:e}=this.adrZP();this.cmp(r.a,this.read(e)),n+=3;break}case 213:{const{addr:e}=this.adrZPX();this.cmp(r.a,this.read(e)),n+=4;break}case 205:{const{addr:e}=this.adrABS();this.cmp(r.a,this.read(e)),n+=4;break}case 221:{const{addr:e,crossed:i}=this.adrABSX();this.cmp(r.a,this.read(e)),n+=4+(i?1:0);break}case 217:{const{addr:e,crossed:i}=this.adrABSY();this.cmp(r.a,this.read(e)),n+=4+(i?1:0);break}case 193:{const{addr:e}=this.adrINDX();this.cmp(r.a,this.read(e)),n+=6;break}case 209:{const{addr:e,crossed:i}=this.adrINDY();this.cmp(r.a,this.read(e)),n+=5+(i?1:0);break}case 224:{const{value:e}=this.adrIMM();this.cmp(r.x,e),n+=2;break}case 228:{const{addr:e}=this.adrZP();this.cmp(r.x,this.read(e)),n+=3;break}case 236:{const{addr:e}=this.adrABS();this.cmp(r.x,this.read(e)),n+=4;break}case 192:{const{value:e}=this.adrIMM();this.cmp(r.y,e),n+=2;break}case 196:{const{addr:e}=this.adrZP();this.cmp(r.y,this.read(e)),n+=3;break}case 204:{const{addr:e}=this.adrABS();this.cmp(r.y,this.read(e)),n+=4;break}case 24:this.setFlag(b,!1),n+=2;break;case 56:this.setFlag(b,!0),n+=2;break;case 88:{try{const i=typeof process<"u"?E:void 0;i&&i.TRACE_IRQ_VECTOR==="1"&&console.log(`[cpu] CLI executed pc=$${c.toString(16).padStart(4,"0")} cycles=${r.cycles} p=$${r.p.toString(16).padStart(2,"0")}`)}catch{}const e=this.getFlag($);this.setFlag($,!1),e&&this.irqLine&&(this.irqInhibitNext=!0,this.delayedIrqPending=!0),n+=2;break}case 120:{try{const e=typeof process<"u"?E:void 0;e&&e.TRACE_IRQ_VECTOR==="1"&&console.log(`[cpu] SEI executed pc=$${c.toString(16).padStart(4,"0")} cycles=${r.cycles} p=$${r.p.toString(16).padStart(2,"0")}`)}catch{}this.setFlag($,!0),n+=2;break}case 184:this.setFlag(O,!1),n+=2;break;case 216:this.setFlag(Ct,!1),n+=2;break;case 248:this.setFlag(Ct,!0),n+=2;break;case 144:{const e=this.fetch8()<<24>>24;let i=2;if(!this.getFlag(b)){const l=r.pc;r.pc=r.pc+e&65535,i++,(l&65280)!==(r.pc&65280)&&i++}n+=i;break}case 176:{const e=this.fetch8()<<24>>24;let i=2;if(this.getFlag(b)){const l=r.pc;r.pc=r.pc+e&65535,i++,(l&65280)!==(r.pc&65280)&&i++}n+=i;break}case 240:{const e=this.fetch8()<<24>>24;let i=2;if(this.getFlag(Y)){const l=r.pc;r.pc=r.pc+e&65535,i++,(l&65280)!==(r.pc&65280)&&i++}n+=i;break}case 208:{const e=this.fetch8()<<24>>24;let i=2;if(!this.getFlag(Y)){const l=r.pc;r.pc=r.pc+e&65535,i++,(l&65280)!==(r.pc&65280)&&i++}n+=i;break}case 16:{const e=this.fetch8()<<24>>24;let i=2;if(!this.getFlag(st)){const l=r.pc;r.pc=r.pc+e&65535,i++,(l&65280)!==(r.pc&65280)&&i++}n+=i;break}case 48:{const e=this.fetch8()<<24>>24;let i=2;if(this.getFlag(st)){const l=r.pc;r.pc=r.pc+e&65535,i++,(l&65280)!==(r.pc&65280)&&i++}n+=i;break}case 80:{const e=this.fetch8()<<24>>24;let i=2;if(!this.getFlag(O)){const l=r.pc;r.pc=r.pc+e&65535,i++,(l&65280)!==(r.pc&65280)&&i++}n+=i;break}case 112:{const e=this.fetch8()<<24>>24;let i=2;if(this.getFlag(O)){const l=r.pc;r.pc=r.pc+e&65535,i++,(l&65280)!==(r.pc&65280)&&i++}n+=i;break}case 76:{const{addr:e}=this.adrABS();r.pc=e,n+=3;break}case 108:{const{addr:e}=this.adrIND();r.pc=e,n+=5;break}case 32:{const e=this.fetch16(),i=r.pc-1&65535,l=r.s&255;this.push16(i);try{const p=typeof process<"u"?E:void 0;if(p&&p.TRACE_JSR==="1"){const f=this.state.s&255,u=256+(f+1&255)&65535,g=256+(f+2&255)&65535;console.log(`[cpu] JSR $${e.toString(16).padStart(4,"0")} push=$${i.toString(16).padStart(4,"0")} to [$${g.toString(16).padStart(4,"0")},$${u.toString(16).padStart(4,"0")}] sp ${l.toString(16).padStart(2,"0")}->${f.toString(16).padStart(2,"0")}`)}}catch{}r.pc=e,n+=6;break}case 96:{const e=this.pop16();try{const l=typeof process<"u"?E:void 0;if(l&&l.TRACE_RTS==="1"){const p=this.state.s&255,f=256+(p-1&255)&65535,u=256+(p&255)&65535;console.log(`[cpu] RTS pop=$${e.toString(16).padStart(4,"0")} from [$${f.toString(16).padStart(4,"0")},$${u.toString(16).padStart(4,"0")}] -> sp=$${p.toString(16).padStart(2,"0")}`)}}catch{}const i=e+1&65535;r.pc=i,n+=6;break}case 0:{const e=r.pc+this.brkPushDelta&65535;this.push16(e),this.push8((r.p|V|z)&255),this.setFlag($,!0);const i=this.read16(65534);r.pc=i,n+=7;break}case 64:{r.p=this.pop8()&~V|z,r.pc=this.pop16(),r.p&$&&(this.delayedIrqPending=!1),n+=6;break}case 26:case 58:case 90:case 122:case 218:case 250:n+=2;break;case 139:{const{value:e}=this.adrIMM();r.a=r.x&e,this.setZN(r.a),n+=2;break}case 203:{const{value:e}=this.adrIMM(),i=r.a&r.x&255,l=e,p=i-l&255;this.setFlag(b,i>=l),r.x=p,this.setZN(r.x),n+=2;break}case 128:case 130:case 194:case 226:{this.fetch8(),n+=2;break}case 4:case 68:case 100:{this.adrZP(),n+=3;break}case 20:case 52:case 84:case 116:case 212:case 244:{this.adrZPX(),n+=4;break}case 12:{this.adrABS(),n+=4;break}case 28:case 60:case 92:case 124:case 220:case 252:{const{crossed:e}=this.adrABSX();n+=4+(e?1:0);break}case 2:case 18:case 34:case 50:case 66:case 82:case 98:case 114:case 146:case 178:case 210:case 242:if(this.illegalMode==="strict"){this.jammed=!0;return}else{n+=2;break}default:{const e=this.state;this.tracePC[this.traceIdx&63]=c,this.traceIdx++;const i=e.pc-1&65535,l=(R,A)=>{const I=[];for(let w=0;w<A;w++){const N=this.read(R+w&65535);I.push(N.toString(16).padStart(2,"0"))}return I.join(" ")},p=i-8&65535,f=l(p,17),u=`A=${e.a.toString(16).padStart(2,"0")} X=${e.x.toString(16).padStart(2,"0")} Y=${e.y.toString(16).padStart(2,"0")} S=${e.s.toString(16).padStart(2,"0")} P=${e.p.toString(16).padStart(2,"0")} CYC=${e.cycles}`,g=[],y=Math.min(16,this.traceIdx);for(let R=y-1;R>=0;R--){const A=this.traceIdx-1-R&63;g.push(`$${this.tracePC[A].toString(16).padStart(4,"0")}`)}const S=256,B=S+(e.s+1&255)&65535,k=l(S,32),P=`Opcode not implemented: $${o.toString(16)} at $${i.toString(16).padStart(4,"0")}
Regs: ${u}
Mem[$${(i-8&65535).toString(16).padStart(4,"0")}..]: ${f}
TracePC: ${g.join(" ")}
Stack[S=${e.s.toString(16)} next=$${B.toString(16)}]: ${k}`;throw new Error(P)}}if(this.extraTraceHook)try{this.extraTraceHook({pc:c,opcode:o,ea:this.lastEA,crossed:this.lastCrossed})}catch{}try{const e=typeof process<"u"?E:void 0,i=e==null?void 0:e.TRACE_PC_WINDOW;if(i&&this.lastEA!==null){const l=/^(\d+)-(\d+)$/.exec(i);if(l){const p=parseInt(l[1],10)|0,f=parseInt(l[2],10)|0,u=this.state.cycles|0;u>=p&&u<=f&&console.log(`[traceea] pc=$${c.toString(16).padStart(4,"0")} ea=$${(this.lastEA&65535).toString(16).padStart(4,"0")} crossed=${this.lastCrossed?1:0} cyc=${u}`)}}}catch{}this.lastBusAccessCount=this.busAccessCountCurr;const d=n-this.busAccessCountCurr;if(d>0&&this.incCycle(d),this.traceStackTopMatch!==null)try{const e=this.state.s+1&255,i=this.bus.read(256+e)&255,p=(this.bus.read(256+(e+1&255))&255)<<8|i;p===this.traceStackTopMatch&&console.log(`[stacktop] match=$${p.toString(16).padStart(4,"0")} at PC=$${this.state.pc.toString(16).padStart(4,"0")} SP=$${this.state.s.toString(16).padStart(2,"0")}`)}catch{}if(this.spTraceEnabled){const e=this.state.pc&65535,i=c&65535;if(i>=this.spTraceStart&&i<=this.spTraceEnd||e>=this.spTraceStart&&e<=this.spTraceEnd){const l=(this.state.cycles|0)-t;try{console.log(`[sp] post PC=$${e.toString(16).padStart(4,"0")} SP=$${this.state.s.toString(16).padStart(2,"0")} P=$${this.state.p.toString(16).padStart(2,"0")} dCYC=${l}`)}catch{}}}}}var M={};class qt{constructor(t="vertical"){h(this,"ctrl",0);h(this,"mask",0);h(this,"status",0);h(this,"oamAddr",0);h(this,"framebuffer",new Uint8Array(256*240));h(this,"w",0);h(this,"t",0);h(this,"v",0);h(this,"x",0);h(this,"latchedX",0);h(this,"ctrlLine",0);h(this,"scrollCoarseX",0);h(this,"scrollCoarseY",0);h(this,"scrollFineY",0);h(this,"vram",new Uint8Array(2048));h(this,"palette",new Uint8Array(32));h(this,"oam",new Uint8Array(256));h(this,"chrRead",()=>0);h(this,"chrWrite",()=>{});h(this,"onA12Rise",null);h(this,"lastA12",0);h(this,"a12LastLowDot",0);h(this,"a12Filter",8);h(this,"dot",0);h(this,"a12DetectOverride",!1);h(this,"linePulseDone",!1);h(this,"uncondPulses",!1);h(this,"phaseTrace",[]);h(this,"traceA12",[]);h(this,"traceEnabled",!1);h(this,"ctrlTrace",[]);h(this,"maskTrace",[]);h(this,"readBuffer",0);h(this,"powerOnStatusReadCount",0);h(this,"powerOnStatusSeqEnabled",!1);h(this,"cycle",0);h(this,"scanline",0);h(this,"frame",0);h(this,"oddFrame",!1);h(this,"nmiOccurred",!1);h(this,"nmiOutput",!1);h(this,"useVT",!1);h(this,"offlineUseVT",!1);h(this,"region","ntsc");this.mirror=t;try{const s=typeof process<"u"?M:void 0;s&&s.PPU_TIMING_DEFAULT==="vt"&&(this.useVT=!0),s&&s.PPU_TRACE==="1"&&(this.traceEnabled=!0),s&&s.PPU_POWERON_STATUS_SEQ==="1"&&(this.powerOnStatusSeqEnabled=!0),s&&s.PPU_MMC3_UNCOND_PULSES==="1"&&(this.uncondPulses=!0)}catch{}}setMirroring(t){this.mirror=t}setRegion(t){this.region=t}getRegion(){return this.region}connectCHR(t,s){this.chrRead=t,this.chrWrite=s}setA12Hook(t){this.onA12Rise=t}getA12Trace(){return this.traceA12}getCtrlTrace(){return this.ctrlTrace}getMaskTrace(){return this.maskTrace}getCtrlLine(){return this.ctrlLine&255}getPhaseTrace(){return this.phaseTrace}setTimingMode(t){const s=t==="vt";this.useVT=s,this.offlineUseVT=s}reset(){this.ctrl=0,this.mask=0,this.status=0,this.oamAddr=0,this.w=0,this.t=0,this.v=0,this.x=0,this.readBuffer=0,this.cycle=0,this.scanline=0,this.frame=0,this.powerOnStatusReadCount=0,this.ctrlTrace.length=0,this.maskTrace.length=0,this.nmiOccurred=!1,this.nmiOutput=!1,this.vram.fill(0),this.palette.fill(0),this.oam.fill(0),this.framebuffer.fill(0),this.scrollCoarseX=0,this.scrollCoarseY=0,this.scrollFineY=0,this.latchedX=0,this.lastA12=0,this.a12LastLowDot=0,this.dot=0}cpuRead(t){switch(t&=8199,t){case 8194:{let s=this.status&224|this.readBuffer&31;if(this.powerOnStatusSeqEnabled&&this.powerOnStatusReadCount<2){const a=this.powerOnStatusReadCount===1?128:0;s=s&31|a,this.powerOnStatusReadCount++}this.status&=-129,this.w=0,this.nmiOccurred=!1;try{const a=typeof process<"u"?M:void 0;a&&a.TRACE_PPUSTATUS==="1"&&console.log(`[ppu] read $2002 value=$${(s&255).toString(16).padStart(2,"0")} at f=${this.frame} sl=${this.scanline} cyc=${this.cycle}`)}catch{}return s&255}case 8196:return this.oam[this.oamAddr&255];case 8199:{const s=this.v&16383;s<8192&&this.detectA12FromAddr(s);try{const c=typeof process<"u"?M:void 0;c&&c.PPU_A12_CPU_DEBUG==="1"&&console.log(`[ppu-a12-cpu] $2007 read addr=$${s.toString(16).padStart(4,"0")} f=${this.frame} sl=${this.scanline} cyc=${this.cycle}`)}catch{}let a;return s>=16128&&s<=16383?(a=this.readPalette(s&31),this.readBuffer=this.ppuRead(s-4096&16383)):(a=this.readBuffer,this.readBuffer=this.ppuRead(s)),this.v=this.v+this.vramIncrement()&32767,this.evalA12FromAddr(this.v&16383,!1),a&255}default:return 0}}cpuWrite(t,s){switch(t&=8199,s&=255,t){case 8192:{if(this.ctrl=s,this.traceEnabled){this.ctrlTrace.length>1024&&this.ctrlTrace.shift(),this.ctrlTrace.push({frame:this.frame,scanline:this.scanline,cycle:this.cycle,ctrl:this.ctrl});try{console.log(`[ppu] $2000<=${(this.ctrl&255).toString(16).padStart(2,"0")} @[f${this.frame} s${this.scanline} c${this.cycle}]`)}catch{}}this.t=this.t&62463|(s&3)<<10;const a=this.nmiOutput;this.nmiOutput=!!(s&128),!a&&this.nmiOutput&&this.status&128&&(this.nmiOccurred=!0);break}case 8193:{if(this.mask=s,this.traceEnabled){this.maskTrace.length>1024&&this.maskTrace.shift(),this.maskTrace.push({frame:this.frame,scanline:this.scanline,cycle:this.cycle,mask:this.mask});try{console.log(`[ppu] $2001<=${(this.mask&255).toString(16).padStart(2,"0")} @[f${this.frame} s${this.scanline} c${this.cycle}]`)}catch{}}break}case 8195:{this.oamAddr=s;break}case 8196:{this.oam[this.oamAddr&255]=s,this.oamAddr=this.oamAddr+1&255;break}case 8197:{this.w===0?(this.x=s&7,this.t=this.t&32736|s>>3,this.scrollCoarseX=s>>3&31,this.w=1):(this.t=this.t&3103|(s&7)<<12|(s&248)<<2,this.scrollFineY=s&7,this.scrollCoarseY=s>>3&31,this.w=0);break}case 8198:{if(this.w===0)this.t=this.t&255|(s&63)<<8,this.w=1;else{this.t=this.t&32512|s,this.v=this.t,this.evalA12FromAddr(this.v&16383,!1);try{const a=typeof process<"u"?M:void 0;a&&a.PPU_A12_CPU_DEBUG==="1"&&console.log(`[ppu-a12-cpu] $2006 write v=$${(this.v&16383).toString(16).padStart(4,"0")} f=${this.frame} sl=${this.scanline} cyc=${this.cycle}`)}catch{}this.w=0}break}case 8199:{const a=this.v&16383;a<8192&&this.detectA12FromAddr(a);try{const c=typeof process<"u"?M:void 0;c&&c.PPU_A12_CPU_DEBUG==="1"&&console.log(`[ppu-a12-cpu] $2007 write addr=$${a.toString(16).padStart(4,"0")} f=${this.frame} sl=${this.scanline} cyc=${this.cycle}`)}catch{}this.ppuWrite(a,s),this.v=this.v+this.vramIncrement()&32767,this.evalA12FromAddr(this.v&16383,!1);break}}}oamDMA(t,s){const a=s<<8&65280;let c=this.oamAddr&255;for(let o=0;o<256;o++)this.oam[c]=t(a+o&65535)&255,c=c+1&255}getOAMByte(t){return this.oam[t&255]}tick(t=1){for(let s=0;s<t;s++){this.dot++;const a=(this.mask&24)!==0;if(this.useVT&&a&&this.scanline===261&&this.cycle===0&&this.oddFrame&&(this.cycle=1),this.scanline>=0&&this.scanline<=239||this.scanline===261){this.cycle===1&&(this.linePulseDone=!1,this.ctrlLine=this.ctrl&255,this.a12DetectOverride=!0,this.ppuRead(4088),this.a12DetectOverride=!1,this.scanline>=0&&this.scanline<=239&&(this.latchedX=this.x&7));const c=this.ctrlLine&255,o=(c&32)!==0,r=(c&8)!==0||o,n=a&&r||this.scanline===261||this.uncondPulses,d=a||this.scanline===261||this.uncondPulses;if(n&&this.cycle===260){const e=!this.linePulseDone&&r;this.traceEnabled&&this.scanline===0&&(this.phaseTrace.length>256&&this.phaseTrace.shift(),this.phaseTrace.push({frame:this.frame,scanline:this.scanline,cycle:this.cycle,ctrl:this.ctrl&255,mask:this.mask&255,emitted:e})),e?(this.a12DetectOverride=!0,this.ppuRead(4096),this.a12DetectOverride=!1,this.linePulseDone=!0):(this.a12DetectOverride=!0,this.ppuRead(4088),this.a12DetectOverride=!1)}if(d&&this.cycle===324){const e=!this.linePulseDone;this.traceEnabled&&this.scanline===0&&(this.phaseTrace.length>256&&this.phaseTrace.shift(),this.phaseTrace.push({frame:this.frame,scanline:this.scanline,cycle:this.cycle,ctrl:this.ctrl&255,mask:this.mask&255,emitted:e})),e?(this.a12DetectOverride=!0,this.ppuRead(4096),this.a12DetectOverride=!1,this.linePulseDone=!0):(this.a12DetectOverride=!0,this.ppuRead(4088),this.a12DetectOverride=!1)}}if(a){if(this.scanline>=0&&this.scanline<=239){const c=this.cycle-1,o=this.scanline;if(this.cycle===1){const n=(this.ctrl&32)!==0?16:8;let d=0;for(let e=0;e<64;e++){const i=e*4,l=this.oam[i+0&255]+1&255;if(o>=l&&o<l+n&&(d++,d>8)){this.status|=32;break}}}if(this.cycle===256&&this.incY(),this.cycle===257&&this.copyX(),this.traceEnabled&&this.scanline===0&&this.cycle===1&&(this.phaseTrace.length>256&&this.phaseTrace.shift(),this.phaseTrace.push({frame:this.frame,scanline:this.scanline,cycle:this.cycle,ctrl:this.ctrl&255,mask:this.mask&255})),c>=0&&c<256){const r=(this.mask&8)!==0,n=(this.mask&16)!==0;if(r&&n&&!(this.status&64)){const d=(this.mask&2)!==0,e=(this.mask&4)!==0,i=c>=8||d,l=c>=8||e;if(i&&l){const p=this.sampleBgPixelV(c,o),f=this.sampleBgPixel(c,o),u=this.useVT&&p||f,g=this.sampleSprite0Pixel(c,o);if(u!==0&&g!==0&&!(this.status&64)){this.status|=64;try{const y=typeof process<"u"?M:void 0;y&&y.TRACE_SP0==="1"&&console.log(`[ppu] sprite0 SET at f=${this.frame} sl=${this.scanline} cyc=${this.cycle}`)}catch{}}}}if(c>=0&&c<256){let d=0;const e=(this.mask&2)!==0,i=(this.useVT?this.sampleBgPixelV(c,o):this.sampleBgPixel(c,o))&3,p=!e&&c<8?0:i,f=p===0?this.readPalette(0):this.useVT?this.sampleBgColorV(c,o):this.sampleBgColor(c,o),g=(this.mask&4)!==0||c>=8?this.sampleSpritePixel(c,o):null;if(d=f&63,g&&g.pix!==0){const y=16+((g.pal&3)<<2)+g.pix,S=this.readPalette(y)&63;(p===0||g.priority===0)&&(d=S)}this.framebuffer[o*256+c]=d}}}else if(this.scanline===261){if(this.cycle===1){const c=(this.status&64)!==0,o=(this.status&128)!==0;this.status&=-129,this.status&=-65,this.status&=-33,this.nmiOccurred=!1;try{const r=typeof process<"u"?M:void 0;r&&r.TRACE_PPUSTATUS==="1"&&(o&&console.log(`[ppu] VBlank cleared at pre-render f=${this.frame} sl=${this.scanline} cyc=${this.cycle}`),c&&r.TRACE_SP0==="1"&&console.log(`[ppu] sprite0 CLEAR at pre-render f=${this.frame} sl=${this.scanline} cyc=${this.cycle}`))}catch{}}a&&this.cycle>=280&&this.cycle<=304&&this.copyY(),a&&this.cycle>=280&&this.cycle<=304&&this.copyY()}}if(this.cycle++,this.cycle>340){if(this.cycle=0,this.scanline++,this.scanline===241){this.status|=128,this.nmiOutput&&(this.nmiOccurred=!0);try{const c=typeof process<"u"?M:void 0;c&&c.TRACE_PPUSTATUS==="1"&&console.log(`[ppu] VBlank set at f=${this.frame} sl=${this.scanline} cyc=${this.cycle}`)}catch{}}else if(this.scanline>=262&&(this.scanline=0,this.frame++,(this.mask&24)!==0?this.oddFrame=!this.oddFrame:this.oddFrame=!1,(this.status&128)!==0))try{const r=typeof process<"u"?M:void 0;r&&r.TRACE_PPUSTATUS==="1"&&console.log(`[ppu] VBlank cleared at frame start f=${this.frame} sl=${this.scanline} cyc=${this.cycle}`)}catch{}}}}incY(){if((this.v&28672)!==28672)this.v+=4096;else{this.v&=-28673;let t=(this.v&992)>>5;t===29?(t=0,this.v^=2048):t===31?t=0:t++,this.v=this.v&-993|t<<5}}copyX(){this.v=this.v&-1056|this.t&1055}copyY(){this.v=this.v&-31713|this.t&31712}vramIncrement(){return this.ctrl&4?32:1}ppuRead(t){const s=t&16383;if(s<8192)return(!((this.mask&24)!==0)||this.a12DetectOverride)&&this.detectA12FromAddr(s),this.chrRead(s);if(s<16128){const a=this.mapNametable(s);return this.vram[a]}return this.readPalette(s&31)}ppuWrite(t,s){const a=t&16383;if(s&=255,a<8192){(!((this.mask&24)!==0)||this.a12DetectOverride)&&this.detectA12FromAddr(a),this.chrWrite(a,s);return}if(a<16128){const c=this.mapNametable(a);this.vram[c]=s;return}this.writePalette(a&31,s)}detectA12FromAddr(t,s=!1){const a=t&16383;if(a>=8192)return;if((a>>12&1)===0){this.lastA12!==0&&(this.a12LastLowDot=this.dot),this.lastA12=0;try{const o=typeof process<"u"?M:void 0;o&&o.PPU_A12_DEBUG==="1"&&console.log(`[ppu-a12] low at f=${this.frame} sl=${this.scanline} cyc=${this.cycle} addr=$${a.toString(16).padStart(4,"0")}`)}catch{}return}if(this.lastA12===0)if(s||this.dot-this.a12LastLowDot>=this.a12Filter){this.traceEnabled&&(this.traceA12.length>1024&&this.traceA12.shift(),this.traceA12.push({frame:this.frame,scanline:this.scanline,cycle:this.cycle}));try{const o=typeof process<"u"?M:void 0;o&&o.PPU_A12_DEBUG==="1"&&console.log(`[ppu-a12] detect rise at f=${this.frame} sl=${this.scanline} cyc=${this.cycle} addr=$${a.toString(16).padStart(4,"0")}${s?" (forced)":""}`)}catch{}this.onA12Rise&&this.onA12Rise(),this.lastA12=1}else try{const o=typeof process<"u"?M:void 0;o&&o.PPU_A12_DEBUG==="1"&&console.log(`[ppu-a12] filtered rise (ignored) at f=${this.frame} sl=${this.scanline} cyc=${this.cycle} addr=$${a.toString(16).padStart(4,"0")}`)}catch{}}evalA12FromAddr(t,s=!1){const a=t&16383;if(a<8192){const c=this.lastA12;if(this.detectA12FromAddr(a,s),c===0&&this.lastA12===1)try{const o=typeof process<"u"?M:void 0;o&&o.PPU_A12_DEBUG==="1"&&console.log(`[ppu-a12] eval ${s?"(forced)":"(filtered)"} rise at f=${this.frame} sl=${this.scanline} cyc=${this.cycle} addr=$${a.toString(16).padStart(4,"0")}`)}catch{}}}mapNametable(t){const s=t-8192&4095,a=s>>10&3,c=s&1023;let o;switch(this.mirror){case"vertical":o=(a&1)*1024+c;break;case"horizontal":o=(a>>1&1)*1024+c;break;case"single0":o=0+c;break;case"single1":o=1024+c;break;case"four":default:o=(a&1)*1024+c}return o&2047}readPalette(t){const s=this.paletteIndexMirror(t&31);return this.palette[s]&63}writePalette(t,s){const a=this.paletteIndexMirror(t&31);this.palette[a]=s&63}paletteIndexMirror(t){return(t&19)===16&&(t&=15),t&31}sampleBgPixel(t,s){const a=this.ctrl&16?4096:0,c=(this.scrollCoarseX&31)<<3,o=this.scrollFineY&7,r=(this.scrollCoarseY&31)<<3,n=c+(this.x&7)+t,d=r+o+s,e=n&7,i=d&7,l=n>>3&31,p=d>>3&31,f=this.ctrl&3,u=f&1,g=f>>1&1,y=u+(n>>8&1)&1,P=8192+((g+(d>>8&1)&1)<<1|y)*1024+(p*32+l),R=this.mapNametable(P),A=this.vram[R],I=a+(A<<4)+i&8191,w=this.chrRead(I),N=this.chrRead(I+8&8191),U=7-e,xt=w>>U&1;return((N>>U&1)<<1|xt)&3}sampleBgColor(t,s){const a=this.sampleBgPixel(t,s)&3;if(a===0)return this.readPalette(0);const c=(this.scrollCoarseX&31)<<3,o=this.scrollFineY&7,r=(this.scrollCoarseY&31)<<3,n=c+(this.x&7)+t,d=r+o+s,e=n>>3&31,i=d>>3&31,l=this.ctrl&3,p=l&1,f=l>>1&1,u=p+(n>>8&1)&1,S=8192+((f+(d>>8&1)&1)<<1|u)*1024+960+(i>>2)*8+(e>>2),B=this.mapNametable(S),k=this.vram[B],P=(i&2)<<1|e&2,R=k>>P&3;return this.readPalette(0+(R<<2)+a)}sampleBgPixelV(t,s){const a=this.ctrl&16?4096:0,c=(this.v&31)<<3,o=this.latchedX&7,r=(this.v>>5&31)<<3,n=this.v>>12&7,d=c+o+t,e=r+n,i=d&7,l=e&7,p=d>>3&31,f=e>>3&31,u=this.v>>10&1,g=this.v>>11&1,y=u+(d>>8&1)&1,k=8192+((g+(e>>8&1)&1)<<1|y)*1024+(f*32+p),P=this.mapNametable(k),R=this.vram[P],A=a+(R<<4)+l&8191,I=this.chrRead(A),w=this.chrRead(A+8&8191),N=7-i,U=I>>N&1;return((w>>N&1)<<1|U)&3}sampleBgColorV(t,s){const a=this.sampleBgPixelV(t,s)&3;if(a===0)return this.readPalette(0);const c=(this.v&31)<<3,o=this.latchedX&7,r=(this.v>>5&31)<<3,n=this.v>>12&7,d=c+o+t,e=r+n,i=d>>3&31,l=e>>3&31,p=this.v>>10&1,f=this.v>>11&1,u=p+(d>>8&1)&1,S=8192+((f+(e>>8&1)&1)<<1|u)*1024+960+(l>>2)*8+(i>>2),B=this.mapNametable(S),k=this.vram[B],P=(l&2)<<1|i&2,R=k>>P&3;return this.readPalette(0+(R<<2)+a)}sampleSprite0Pixel(t,s){const a=this.oam[0]+1&255,c=this.oam[1]&255,o=this.oam[2]&255,r=this.oam[3]&255,n=(this.ctrl&32)!==0,d=n?16:8;if(t<r||t>=r+8||s<a||s>=a+d)return 0;const e=(o&64)!==0,i=(o&128)!==0;let l=t-r&7,p=s-a&15;e&&(l=7-l);let f=0,u=c&255,g=0;if(!n)f=this.ctrl&8?4096:0,g=i?7-(p&7):p&7;else{const A=u&1?4096:0,I=u&254,w=i?15-p:p,N=w<8;u=N?I:I+1&255,g=N?w&7:w-8&7,f=A}const y=f+(u<<4)+g&8191,S=this.chrRead(y),B=this.chrRead(y+8&8191),k=7-l,P=S>>k&1;return(B>>k&1)<<1|P}renderBgFrame(){const a=new Uint8Array(61440);for(let c=0;c<240;c++){const o=c*256;for(let r=0;r<256;r++){const d=!((this.mask&2)!==0)&&r<8?this.readPalette(0):this.sampleBgColor(r,c);a[o+r]=d&63}}return a}sampleSpritePixel(t,s){const a=(this.ctrl&32)!==0;let c=null;for(let o=63;o>=0;o--){const r=o*4,n=this.oam[r+0&255]+1&255;let d=this.oam[r+1&255]&255;const e=this.oam[r+2&255]&255,i=this.oam[r+3&255]&255,l=a?16:8;if(t<i||t>=i+8||s<n||s>=n+l)continue;let p=t-i&7,f=s-n&15;e&64&&(p=7-p);let u=0,g=0;if(!a)u=this.ctrl&8?4096:0,g=e&128?7-(f&7):f&7;else{const I=d&1?4096:0,w=d&254,N=e&128?15-f:f,U=N<8;d=U?w:w+1&255,g=U?N&7:N-8&7,u=I}const y=u+(d<<4)+g&8191,S=this.chrRead(y),B=this.chrRead(y+8&8191),k=7-p,P=S>>k&1,A=((B>>k&1)<<1|P)&3;if(A!==0){const I=e&32?1:0,w=e&3;c={pix:A,priority:I,pal:w}}}return c}getFrameBuffer(){return this.framebuffer}renderFrame(){const a=new Uint8Array(61440);for(let c=0;c<240;c++){const o=c*256;for(let r=0;r<256;r++){const n=(this.mask&2)!==0,d=(this.offlineUseVT?this.sampleBgPixelV(r,c):this.sampleBgPixel(r,c))&3,i=!n&&r<8?0:d,l=i===0?this.readPalette(0):this.offlineUseVT?this.sampleBgColorV(r,c):this.sampleBgColor(r,c),f=(this.mask&4)!==0||r>=8?this.sampleSpritePixel(r,c):null;let u=l&63;if(f&&f.pix!==0){const g=16+((f.pal&3)<<2)+f.pix,y=this.readPalette(g)&63;(i===0||f.priority===0)&&(u=y)}a[o+r]=u}}return a}}const tt=class tt{constructor(){h(this,"strobe",0);h(this,"latched",0);h(this,"shift",0);h(this,"pressed",{A:!1,B:!1,Select:!1,Start:!1,Up:!1,Down:!1,Left:!1,Right:!1})}setButton(t,s){this.pressed[t]=s,this.strobe&1&&this.latchButtons()}write4016(t){const s=t&1;(this.strobe&1)===1&&s===0&&this.latchButtons(),this.strobe=s,s===1&&this.latchButtons()}read(){let t=1;return(this.strobe&1)===1?t=this.pressed.A?1:0:(t=this.shift&1,this.shift=this.shift>>>1|128),64|t}latchButtons(){let t=0;for(let s=0;s<tt.order.length;s++)this.pressed[tt.order[s]]&&(t|=1<<s);this.latched=t,this.shift=t}};h(tt,"order",["A","B","Select","Start","Up","Down","Left","Right"]);let et=tt;var At={};class Ft{constructor(t,s){h(this,"pad1",new et);h(this,"pad2",new et);h(this,"getCpuCycles",null);h(this,"addCpuCycles",null);h(this,"apu",null);h(this,"read",t=>{switch(t){case 8194:case 8196:case 8199:return this.ppu.cpuRead(t);case 16406:return this.pad1.read();case 16407:return this.pad2.read();case 16405:{const s=this.apu?this.apu.read4015():0;try{const a=typeof process<"u"?At:void 0,c=this.getCpuCycles?this.getCpuCycles():0;let o=!1;a&&a.TRACE_APU_4015==="1"&&(o=!0);const r=a==null?void 0:a.TRACE_READ_WINDOW,n=a==null?void 0:a.TRACE_READ_ADDRS;let d=!0;if(r){const i=/^(\d+)-(\d+)$/.exec(r);if(i){const l=parseInt(i[1],10)|0,p=parseInt(i[2],10)|0;d=c>=l&&c<=p}}let e=!0;n&&(e=new Set(n.split(",").map(l=>parseInt(l.trim(),16)&65535)).has(16405)),d&&e&&(o||r||n)&&console.log(`[io] read $4015 => $${(s&255).toString(16).padStart(2,"0")} at CPU cyc=${c}`)}catch{}return s}default:return 0}});h(this,"write",(t,s)=>{var a,c;switch(t){case 8192:case 8193:case 8195:case 8196:case 8197:case 8198:case 8199:this.ppu.cpuWrite(t,s);break;case 16404:{if(this.ppu.oamDMA(o=>this.bus.read(o),s),this.getCpuCycles&&this.addCpuCycles){const r=this.getCpuCycles()&1?514:513;this.addCpuCycles(r);try{this.ppu.tick(r*3)}catch{}try{this.apu&&((c=(a=this.apu).tick)==null||c.call(a,r))}catch{}}break}case 16406:{this.pad1.write4016(s),this.pad2.write4016(s);break}case 16407:{try{const o=typeof process<"u"?At:void 0;if(o&&o.TRACE_APU_4015==="1"){const r=this.getCpuCycles?this.getCpuCycles():0;console.log(`[io] write $4017 <= $${(s&255).toString(16).padStart(2,"0")} at CPU cyc=${r}`)}}catch{}this.apu&&this.apu.write4017(s);break}case 16405:{this.apu&&this.apu.write4015(s);break}default:if(t>=16384&&t<=16403){this.apu&&this.apu.writeRegister&&this.apu.writeRegister(t,s);break}break}});this.ppu=t,this.bus=s}attachAPU(t){this.apu=t}setCpuCycleHooks(t,s){this.getCpuCycles=t,this.addCpuCycles=s}getController(t){return t===1?this.pad1:this.pad2}}class _t{constructor(t,s=new Uint8Array(0),a,c=8192,o=0){h(this,"prg");h(this,"chr");h(this,"prgMask");h(this,"prgRam");h(this,"prgBatteryOffset",0);this.prg=t,this.chr=s.length?s:new Uint8Array(a||8192),this.prgMask=t.length===16384?16383:32767;const r=Math.max(0,c|0)+Math.max(0,o|0);this.prgRam=new Uint8Array(r||8192),this.prgBatteryOffset=Math.max(0,c|0)}cpuRead(t){if(t>=32768){const s=t-32768&this.prgMask;return this.prg[s]}if(t>=24576&&t<32768){const s=t-24576;return s<this.prgRam.length?this.prgRam[s]:0}return 0}cpuWrite(t,s){if(t>=24576&&t<32768){const a=t-24576;a<this.prgRam.length&&(this.prgRam[a]=s&255)}}getBatteryRam(){return this.prgRam.length-this.prgBatteryOffset>0?this.prgRam.slice(this.prgBatteryOffset):null}setBatteryRam(t){const s=this.prgRam.length-this.prgBatteryOffset;if(s<=0)return;const a=Math.min(s,t.length);this.prgRam.set(t.subarray(0,a),this.prgBatteryOffset)}ppuRead(t){const s=t&8191;return this.chr[s]}ppuWrite(t,s){const a=t&8191;this.chr.length&&(this.chr[a]=s&255)}}class Ot{constructor(t,s=new Uint8Array(0),a,c=8192,o=0){h(this,"prg");h(this,"chr");h(this,"bankSelect",0);h(this,"prgBankCount");h(this,"prgRam");h(this,"prgBatteryOffset",0);this.prg=t,this.chr=s.length?s:new Uint8Array(a||8192),this.prgBankCount=t.length/16384;const r=Math.max(0,c|0)+Math.max(0,o|0);this.prgRam=new Uint8Array(r||8192),this.prgBatteryOffset=Math.max(0,c|0)}cpuRead(t){if(t>=32768&&t<49152){const s=this.bankSelect%this.prgBankCount,a=t-32768+s*16384;return this.prg[a]}if(t>=49152){const s=t-49152+(this.prg.length-16384);return this.prg[s]}if(t>=24576&&t<32768){const s=t-24576;return s<this.prgRam.length?this.prgRam[s]:0}return 0}cpuWrite(t,s){if(t>=32768){this.bankSelect=s&15;return}if(t>=24576&&t<32768){const a=t-24576;a<this.prgRam.length&&(this.prgRam[a]=s&255)}}ppuRead(t){return this.chr[t&8191]}ppuWrite(t,s){this.chr[t&8191]=s&255}getBatteryRam(){return this.prgRam.length-this.prgBatteryOffset>0?this.prgRam.slice(this.prgBatteryOffset):null}setBatteryRam(t){const s=this.prgRam.length-this.prgBatteryOffset;if(s<=0)return;const a=Math.min(s,t.length);this.prgRam.set(t.subarray(0,a),this.prgBatteryOffset)}}var Lt={};class it{constructor(t,s=new Uint8Array(0),a){h(this,"prg");h(this,"chr");h(this,"prgRam");h(this,"prgRamEnable",!1);h(this,"prgRamWriteProtect",!1);h(this,"prgBatteryOffset",0);h(this,"bankSelect",0);h(this,"bankRegs",new Uint8Array(8));h(this,"mirroring",0);h(this,"ramProtect",0);h(this,"mirrorCb",null);h(this,"irqLatch",0);h(this,"irqCounter",0);h(this,"irqEnabled",!1);h(this,"irq",!1);h(this,"reloadPending",!1);h(this,"traceEnabled",!1);h(this,"trace",[]);h(this,"timeProvider",null);h(this,"ctrlProvider",null);h(this,"assertOnRel0",!1);this.prg=t,this.chr=s.length?s:new Uint8Array((a==null?void 0:a.chrRamSize)||8192);const c=Math.max(0,(a==null?void 0:a.prgRamSize)??8192)+Math.max(0,(a==null?void 0:a.prgNvramSize)??0);this.prgRam=new Uint8Array(c||8192),this.prgBatteryOffset=Math.max(0,(a==null?void 0:a.prgRamSize)??8192);try{const o=typeof process<"u"?Lt:void 0;o&&o.MMC3_TRACE==="1"&&(this.traceEnabled=!0),o&&(o.MMC3_ASSERT_ON_RELOAD_ZERO==="1"||o.MMC3_1_CLOCK==="1")&&(this.assertOnRel0=!0)}catch{}a&&typeof a.assertOnRel0=="boolean"&&(this.assertOnRel0=!!a.assertOnRel0)}addTrace(t){if(this.trace.length>4096&&this.trace.shift(),this.timeProvider)try{const s=this.timeProvider();t.f=s.frame,t.s=s.scanline,t.c=s.cycle}catch{}if(this.ctrlProvider)try{t.ctrl=this.ctrlProvider()&255}catch{}this.trace.push(t)}cpuRead(t){if(t>=24576&&t<32768){if(!this.prgRamEnable)return 0;const s=t-24576;return s<this.prgRam.length?this.prgRam[s]:0}if(t>=32768){const s=this.mapPrg(t);return this.prg[s]}return 0}cpuWrite(t,s){if(t>=24576&&t<32768){if(this.prgRamEnable&&!this.prgRamWriteProtect){const a=t-24576;a<this.prgRam.length&&(this.prgRam[a]=s&255)}return}if(t>=32768&&t<=40958&&!(t&1))this.bankSelect=s&7|(s&64?64:0)|(s&128?128:0),this.addTrace({type:"8000",a:t,v:s});else if(t>=32769&&t<=40959&&(t&1)===1){const a=this.bankSelect&7;this.bankRegs[a]=s,this.addTrace({type:"8001",a,v:s})}else if(t>=40960&&t<=49150&&!(t&1))this.mirroring=s&1,this.mirrorCb&&this.mirrorCb(this.mirroring&1?"horizontal":"vertical"),this.addTrace({type:"A000",v:s&1});else if(t>=40961&&t<=49151&&(t&1)===1)this.ramProtect=s&227,this.prgRamEnable=!!(s&128),this.prgRamWriteProtect=!!(s&64),this.addTrace({type:"A001",v:s});else if(t>=49152&&t<=57342&&!(t&1)){if(this.irqLatch=s,this.addTrace({type:"C000",v:s}),this.traceEnabled)try{const a=this.timeProvider?this.timeProvider():null;console.log(`[mmc3] C000 latch=$${(s&255).toString(16).padStart(2,"0")}${a?` @[f${a.frame}s${a.scanline}c${a.cycle}]`:""}`)}catch{}}else if(t>=49153&&t<=57343&&(t&1)===1){if(this.reloadPending=!0,this.addTrace({type:"C001"}),this.traceEnabled)try{const a=this.timeProvider?this.timeProvider():null;console.log(`[mmc3] C001 reload${a?` @[f${a.frame}s${a.scanline}c${a.cycle}]`:""}`)}catch{}}else if(t>=57344&&t<=65534&&!(t&1)){if(this.irqEnabled=!1,this.irq=!1,this.addTrace({type:"E000"}),this.traceEnabled)try{const a=this.timeProvider?this.timeProvider():null;console.log(`[mmc3] E000 disable${a?` @[f${a.frame}s${a.scanline}c${a.cycle}]`:""}`)}catch{}}else if(t>=57345&&t<=65535&&(t&1)===1&&(this.irqEnabled=!0,this.addTrace({type:"E001"}),this.traceEnabled))try{const a=this.timeProvider?this.timeProvider():null;console.log(`[mmc3] E001 enable${a?` @[f${a.frame}s${a.scanline}c${a.cycle}]`:""}`)}catch{}}ppuRead(t){return this.chr[this.mapChr(t&8191)]}ppuWrite(t,s){this.chr[this.mapChr(t&8191)]=s&255}irqPending(){return this.irq}clearIrq(){this.irq=!1}notifyA12Rise(){const t=this.timeProvider?this.timeProvider():null,s=!!(t&&t.scanline===261);if(s){this.reloadPending?(this.irqCounter=this.irqLatch&255,this.reloadPending=!1):this.irqCounter===0&&(this.irqCounter=this.irqLatch&255),this.addTrace({type:"A12",ctr:this.irqCounter,en:this.irqEnabled});return}let a="dec";this.reloadPending;const c=this.irqCounter&255;if(this.reloadPending?(this.irqCounter=this.irqLatch&255,this.reloadPending=!1,a=this.irqCounter===0?"rel0":"rel"):this.irqCounter===0?(this.irqCounter=this.irqLatch&255,a=this.irqCounter===0?"rel0":"rel"):(this.irqCounter=this.irqCounter-1&255,a="dec"),this.traceEnabled)try{console.log(`[mmc3] A12 rise: op=${a} latch=${this.irqLatch} ctrBefore=${c} ctrAfter=${this.irqCounter} en=${this.irqEnabled?1:0} reloadPend=${this.reloadPending?1:0}`)}catch{}if(!s){const r=a==="dec"&&this.irqCounter===0,n=a==="rel0";if(r&&this.addTrace({type:"DEC0",en:this.irqEnabled}),this.irqEnabled&&(r||this.assertOnRel0&&n)){if(this.irq=!0,this.addTrace({type:"IRQ"}),this.traceEnabled)try{console.log(`[mmc3] IRQ assert${t?` @[f${t.frame}s${t.scanline}c${t.cycle}]`:""}`)}catch{}}else r&&!this.irqEnabled&&this.addTrace({type:"DEC0MISS"})}const o={type:"A12",ctr:this.irqCounter,en:this.irqEnabled};if(o.op=a,o.pre=s,this.addTrace(o),this.traceEnabled)try{console.log(`[mmc3] A12 op=${a} ctr=${this.irqCounter} en=${this.irqEnabled?1:0} pre=${s?1:0}`)}catch{}}setMirrorCallback(t){this.mirrorCb=t,t(this.mirroring&1?"horizontal":"vertical")}getTrace(){return this.trace}setTimeProvider(t){this.timeProvider=t}setCtrlProvider(t){this.ctrlProvider=t}getBatteryRam(){return this.prgRam.length-this.prgBatteryOffset>0?this.prgRam.slice(this.prgBatteryOffset):null}setBatteryRam(t){const s=this.prgRam.length-this.prgBatteryOffset;if(s<=0)return;const a=Math.min(s,t.length);this.prgRam.set(t.subarray(0,a),this.prgBatteryOffset)}reset(){this.bankSelect=0,this.bankRegs.fill(0),this.mirroring=0,this.ramProtect=0,this.prgRamEnable=!1,this.prgRamWriteProtect=!1,this.irqLatch=0,this.irqCounter=0,this.irqEnabled=!1,this.irq=!1,this.reloadPending=!1,this.trace.length=0,this.lastA12=0,this.a12LastLowDot=0,this.dot=0}mapPrg(t){const s=this.bankSelect>>6&1,a=this.bankRegs[6]&63,c=this.bankRegs[7]&63,o=this.prg.length,r=o-16384;return s===0?t<40960?a*8192+(t-32768):t<49152?c*8192+(t-40960):t<57344?r+(t-49152):o-8192+(t-57344):t<40960?r+(t-32768):t<49152?c*8192+(t-40960):t<57344?a*8192+(t-49152):o-8192+(t-57344)}mapChr(t){const s=this.bankSelect>>7&1,a=this.bankRegs[0]&254,c=this.bankRegs[1]&254,o=this.bankRegs[2]&255,r=this.bankRegs[3]&255,n=this.bankRegs[4]&255,d=this.bankRegs[5]&255,e=(i,l)=>{const p=(i*1024+l)%this.chr.length;return p<0?p+this.chr.length:p};return s===0?t<2048?e(a,t):t<4096?e(c,t-2048):t<5120?e(o,t-4096):t<6144?e(r,t-5120):t<7168?e(n,t-6144):e(d,t-7168):t<2048?e(o,t):t<4096?e(r,t-2048):t<5120?e(n,t-4096):t<6144?e(d,t-5120):t<7168?e(a,t-6144):e(c,t-7168)}}class Zt{constructor(t,s=new Uint8Array(0),a){h(this,"inner");h(this,"wram",new Uint8Array(1024));h(this,"wramEnable",!1);h(this,"wramWriteProtect",!1);this.inner=new it(t,s,{chrRamSize:a})}reset(){this.inner.reset(),this.wram.fill(0),this.wramEnable=!1,this.wramWriteProtect=!1}cpuRead(t){return t>=24576&&t<32768?this.wramEnable?this.wram[t-24576&1023]:0:this.inner.cpuRead(t)}cpuWrite(t,s){if(t>=24576&&t<32768){this.wramEnable&&!this.wramWriteProtect&&(this.wram[t-24576&1023]=s&255);return}t>=40961&&t<=49151&&(t&1)===1&&(this.wramEnable=!!(s&128),this.wramWriteProtect=!!(s&64)),this.inner.cpuWrite(t,s)}ppuRead(t){return this.inner.ppuRead(t)}ppuWrite(t,s){this.inner.ppuWrite(t,s)}irqPending(){return this.inner.irqPending?this.inner.irqPending():!1}clearIrq(){this.inner.clearIrq&&this.inner.clearIrq()}notifyA12Rise(){this.inner.notifyA12Rise&&this.inner.notifyA12Rise()}setMirrorCallback(t){this.inner.setMirrorCallback&&this.inner.setMirrorCallback(t)}setTimeProvider(t){var s,a;(a=(s=this.inner).setTimeProvider)==null||a.call(s,t)}setCtrlProvider(t){var s,a;(a=(s=this.inner).setCtrlProvider)==null||a.call(s,t)}}class Ut{constructor(t,s=new Uint8Array(0),a,c=8192,o=0){h(this,"prg");h(this,"chr");h(this,"prgRam");h(this,"prgBatteryOffset",0);h(this,"shift",16);h(this,"control",12);h(this,"chrBank0",0);h(this,"chrBank1",0);h(this,"prgBank",0);this.prg=t,this.chr=s.length?s:new Uint8Array(a||8192);const r=Math.max(0,c|0)+Math.max(0,o|0);this.prgRam=new Uint8Array(r||8192),this.prgBatteryOffset=Math.max(0,c|0)}cpuRead(t){if(t>=24576&&t<32768){const s=t-24576;return s<this.prgRam.length?this.prgRam[s]:0}if(t>=32768){const s=this.mapPrg(t);return this.prg[s]}return 0}cpuWrite(t,s){if(t>=24576&&t<32768){const c=t-24576;c<this.prgRam.length&&(this.prgRam[c]=s&255);return}if(t<32768)return;if(s&128){this.shift=16,this.control|=12;return}const a=(this.shift&1)===1;if(this.shift=this.shift>>>1|(s&1)<<4,a){const c=this.shift&31;t<40960?this.control=c:t<49152?this.chrBank0=c:t<57344?this.chrBank1=c:this.prgBank=c&15,this.shift=16}}getBatteryRam(){return this.prgRam.length-this.prgBatteryOffset>0?this.prgRam.slice(this.prgBatteryOffset):null}setBatteryRam(t){const s=this.prgRam.length-this.prgBatteryOffset;if(s<=0)return;const a=Math.min(s,t.length);this.prgRam.set(t.subarray(0,a),this.prgBatteryOffset)}ppuRead(t){const s=t&8191;if((this.control>>4&1)===0){const c=(this.chrBank0&30)*4096;return this.chr[c+s]}else return s<4096?this.chr[this.chrBank0*4096+s]:this.chr[this.chrBank1*4096+(s-4096)]}ppuWrite(t,s){const a=t&8191;if((this.control>>4&1)===0){const o=(this.chrBank0&30)*4096;this.chr[o+a]=s&255}else a<4096?this.chr[this.chrBank0*4096+a]=s&255:this.chr[this.chrBank1*4096+(a-4096)]=s&255}mapPrg(t){const s=this.control>>2&3,a=this.prg.length;switch(s){case 0:case 1:return(this.prgBank&14)*16384+(t-32768);case 2:return t<49152?t-32768:this.prgBank*16384+(t-49152);case 3:default:return t<49152?this.prgBank*16384+(t-32768):a-16384+(t-49152)}}}class Wt{constructor(t,s=new Uint8Array(0),a,c=8192,o=0){h(this,"prg");h(this,"chr");h(this,"prgRam");h(this,"prgBatteryOffset",0);h(this,"chrBank",0);h(this,"chrBanks");this.prg=t,this.chr=s.length?s:new Uint8Array(a||8192),this.chrBanks=Math.max(1,this.chr.length/8192);const r=Math.max(0,c|0)+Math.max(0,o|0);this.prgRam=new Uint8Array(r||8192),this.prgBatteryOffset=Math.max(0,c|0)}cpuRead(t){if(t>=24576&&t<32768){const s=t-24576;return s<this.prgRam.length?this.prgRam[s]:0}return t>=32768?this.prg[t-32768]:0}cpuWrite(t,s){if(t>=24576&&t<32768){const a=t-24576;a<this.prgRam.length&&(this.prgRam[a]=s&255);return}t>=32768&&(this.chrBank=(s&3)%this.chrBanks)}ppuRead(t){const s=this.chrBank*8192;return this.chr[s+(t&8191)]}ppuWrite(t,s){const a=this.chrBank*8192;this.chr[a+(t&8191)]=s&255}getBatteryRam(){return this.prgRam.length-this.prgBatteryOffset>0?this.prgRam.slice(this.prgBatteryOffset):null}setBatteryRam(t){const s=this.prgRam.length-this.prgBatteryOffset;if(s<=0)return;const a=Math.min(s,t.length);this.prgRam.set(t.subarray(0,a),this.prgBatteryOffset)}}class Xt{constructor(t,s=new Uint8Array(0),a){h(this,"prg");h(this,"chr");h(this,"prgRam",new Uint8Array(8192));h(this,"prgBankSelect",0);h(this,"bankChr0FD",0);h(this,"bankChr0FE",0);h(this,"bankChr1FD",0);h(this,"bankChr1FE",0);h(this,"latch0",254);h(this,"latch1",254);h(this,"mirroring",0);h(this,"mirrorCb",null);h(this,"prg16kBanks");h(this,"chr4kBanks");this.prg=t,this.chr=s.length?s:new Uint8Array(a||8192),this.prg16kBanks=Math.max(1,this.prg.length>>>14),this.chr4kBanks=Math.max(1,this.chr.length>>>12)}cpuRead(t){if(t&=65535,t>=24576&&t<32768)return this.prgRam[t-24576];if(t>=32768&&t<49152){const a=(this.prgBankSelect%this.prg16kBanks&255)*16384;return this.prg[a+(t-32768)]}if(t>=49152){const s=(this.prg16kBanks-1)*16384;return this.prg[s+(t-49152)]}return 0}cpuWrite(t,s){if(t&=65535,s&=255,t>=24576&&t<32768){this.prgRam[t-24576]=s;return}switch(t&61440){case 40960:this.prgBankSelect=s%this.prg16kBanks>>>0;break;case 45056:this.bankChr0FD=s%this.chr4kBanks>>>0;break;case 49152:this.bankChr0FE=s%this.chr4kBanks>>>0;break;case 53248:this.bankChr1FD=s%this.chr4kBanks>>>0;break;case 57344:this.bankChr1FE=s%this.chr4kBanks>>>0;break;case 61440:{this.mirroring=s&1,this.mirrorCb&&this.mirrorCb(this.mirroring&1?"horizontal":"vertical");break}}}ppuRead(t){const s=t&8191;if(this.updateLatches(s),s<4096){const c=(this.latch0===253?this.bankChr0FD:this.bankChr0FE)%this.chr4kBanks*4096;return this.chr[c+s]}else{const c=(this.latch1===253?this.bankChr1FD:this.bankChr1FE)%this.chr4kBanks*4096;return this.chr[c+(s-4096)]}}ppuWrite(t,s){const a=t&8191;if(s&=255,this.updateLatches(a),a<4096){const o=(this.latch0===253?this.bankChr0FD:this.bankChr0FE)%this.chr4kBanks*4096;this.chr[o+a]=s}else{const o=(this.latch1===253?this.bankChr1FD:this.bankChr1FE)%this.chr4kBanks*4096;this.chr[o+(a-4096)]=s}}setMirrorCallback(t){this.mirrorCb=t,t(this.mirroring&1?"horizontal":"vertical")}reset(){this.prgRam.fill(0),this.prgBankSelect=0,this.bankChr0FD=0,this.bankChr0FE=0,this.bankChr1FD=0,this.bankChr1FE=0,this.latch0=254,this.latch1=254,this.mirroring=0}updateLatches(t){const s=t&16376;s===4056?this.latch0=253:s===4072?this.latch0=254:s===8152?this.latch1=253:s===8168&&(this.latch1=254)}}class Yt{constructor(t,s=new Uint8Array(0),a){h(this,"prg");h(this,"chr");h(this,"prgRam",new Uint8Array(8192));h(this,"bankReg",0);h(this,"prgBankCount");h(this,"mirrorCb",null);this.prg=t,this.chr=s.length?s:new Uint8Array(a||8192),this.prgBankCount=Math.max(1,t.length/32768|0)}reset(){this.bankReg=0}effectiveBank(){const t=this.bankReg&31;return this.prgBankCount>0?t%this.prgBankCount:0}applyMirror(){if(!this.mirrorCb)return;const t=(this.bankReg&16)!==0;this.mirrorCb(t?"single1":"single0")}cpuRead(t){if(t>=32768){const a=this.effectiveBank()*32768+(t-32768&32767);return this.prg[a]}return t>=24576&&t<32768?this.prgRam[t-24576]:0}cpuWrite(t,s){if(t>=32768){this.bankReg=s&255,this.applyMirror();return}t>=24576&&t<32768&&(this.prgRam[t-24576]=s&255)}ppuRead(t){return this.chr[t&8191]}ppuWrite(t,s){this.chr[t&8191]=s&255}setMirrorCallback(t){this.mirrorCb=t}}class Vt{constructor(t,s=new Uint8Array(0),a,c=8192,o=0){h(this,"prg");h(this,"chr");h(this,"reg",0);h(this,"prgRam");h(this,"prgBatteryOffset",0);this.prg=t,this.chr=s.length?s:new Uint8Array(a||8192);const r=Math.max(0,c|0)+Math.max(0,o|0);this.prgRam=new Uint8Array(r||8192),this.prgBatteryOffset=Math.max(0,c|0)}cpuRead(t){if(t>=32768){const a=(this.reg>>4&3)*32768%Math.max(32768,this.prg.length);return this.prg[a+(t-32768&32767)]}if(t>=24576&&t<32768){const s=t-24576;return s<this.prgRam.length?this.prgRam[s]:0}return 0}cpuWrite(t,s){if(t>=32768){this.reg=s&255;return}if(t>=24576&&t<32768){const a=t-24576;a<this.prgRam.length&&(this.prgRam[a]=s&255)}}ppuRead(t){const a=(this.reg&3)*8192%Math.max(8192,this.chr.length);return this.chr[a+(t&8191)]}ppuWrite(t,s){const c=(this.reg&3)*8192%Math.max(8192,this.chr.length);this.chr[c+(t&8191)]=s&255}getBatteryRam(){return this.prgRam.length-this.prgBatteryOffset>0?this.prgRam.slice(this.prgBatteryOffset):null}setBatteryRam(t){const s=this.prgRam.length-this.prgBatteryOffset;if(s<=0)return;const a=Math.min(s,t.length);this.prgRam.set(t.subarray(0,a),this.prgBatteryOffset)}}class zt{constructor(t,s=new Uint8Array(0),a,c=8192,o=0){h(this,"prg");h(this,"chr");h(this,"reg",0);h(this,"prgRam");h(this,"prgBatteryOffset",0);this.prg=t,this.chr=s.length?s:new Uint8Array(a||8192);const r=Math.max(0,c|0)+Math.max(0,o|0);this.prgRam=new Uint8Array(r||8192),this.prgBatteryOffset=Math.max(0,c|0)}cpuRead(t){if(t>=32768){const a=(this.reg>>4&15)*32768%Math.max(32768,this.prg.length);return this.prg[a+(t-32768&32767)]}if(t>=24576&&t<32768){const s=t-24576;return s<this.prgRam.length?this.prgRam[s]:0}return 0}cpuWrite(t,s){if(t>=32768){this.reg=s&255;return}if(t>=24576&&t<32768){const a=t-24576;a<this.prgRam.length&&(this.prgRam[a]=s&255)}}ppuRead(t){const a=(this.reg&15)*8192%Math.max(8192,this.chr.length);return this.chr[a+(t&8191)]}ppuWrite(t,s){const c=(this.reg&15)*8192%Math.max(8192,this.chr.length);this.chr[c+(t&8191)]=s&255}getBatteryRam(){return this.prgRam.length-this.prgBatteryOffset>0?this.prgRam.slice(this.prgBatteryOffset):null}setBatteryRam(t){const s=this.prgRam.length-this.prgBatteryOffset;if(s<=0)return;const a=Math.min(s,t.length);this.prgRam.set(t.subarray(0,a),this.prgBatteryOffset)}}class Ht{constructor(t,s=new Uint8Array(0),a,c=8192,o=0){h(this,"prg");h(this,"chr");h(this,"prgBank",0);h(this,"prgRam");h(this,"prgBatteryOffset",0);this.prg=t,this.chr=s.length?s:new Uint8Array(a||8192);const r=Math.max(0,c|0)+Math.max(0,o|0);this.prgRam=new Uint8Array(r||8192),this.prgBatteryOffset=Math.max(0,c|0)}cpuRead(t){if(t>=32768){const a=(this.prgBank&15)*32768%Math.max(32768,this.prg.length);return this.prg[a+(t-32768&32767)]}if(t>=24576&&t<32768){const s=t-24576;return s<this.prgRam.length?this.prgRam[s]:0}return 0}cpuWrite(t,s){if(t>=32768){this.prgBank=s&15;return}if(t>=24576&&t<32768){const a=t-24576;a<this.prgRam.length&&(this.prgRam[a]=s&255)}}ppuRead(t){return this.chr[t&8191]}ppuWrite(t,s){this.chr[t&8191]=s&255}getBatteryRam(){return this.prgRam.length-this.prgBatteryOffset>0?this.prgRam.slice(this.prgBatteryOffset):null}setBatteryRam(t){const s=this.prgRam.length-this.prgBatteryOffset;if(s<=0)return;const a=Math.min(s,t.length);this.prgRam.set(t.subarray(0,a),this.prgBatteryOffset)}}class rt{constructor(t,s=new Uint8Array(0),a=22,c,o=8192,r=0){h(this,"prg");h(this,"chr");h(this,"prgRam");h(this,"prgBatteryOffset",0);h(this,"prg16kBank",0);h(this,"chr8kBank",0);h(this,"mirrorCb",null);this.mapperNum=a,this.prg=t,this.chr=s.length?s:new Uint8Array(c||8192);const n=Math.max(0,o|0)+Math.max(0,r|0);this.prgRam=new Uint8Array(n||8192),this.prgBatteryOffset=Math.max(0,o|0)}cpuRead(t){const s=t&65535;if(s>=32768&&s<49152){const a=this.prg16kBank*16384%Math.max(16384,this.prg.length);return this.prg[a+(s-32768)]}if(s>=49152){const a=Math.max(0,this.prg.length-16384);return this.prg[a+(s-49152)]}if(s>=24576&&s<32768){const a=s-24576;return a<this.prgRam.length?this.prgRam[a]:0}return 0}cpuWrite(t,s){const a=t&65535,c=s&255;if(a>=24576&&a<32768){const o=a-24576;o<this.prgRam.length&&(this.prgRam[o]=c);return}if(a>=32768&&a<36864){this.prg16kBank=c&15;return}if(a>=36864&&a<40960){this.mirrorCb&&this.mirrorCb(c&1?"horizontal":"vertical");return}if(a>=40960&&a<45056){this.chr8kBank=c&31;return}}ppuRead(t){const s=t&8191,a=this.chr8kBank*8192%Math.max(8192,this.chr.length);return this.chr[a+s]}ppuWrite(t,s){const a=t&8191,c=s&255,o=this.chr8kBank*8192%Math.max(8192,this.chr.length);this.chr[o+a]=c}setMirrorCallback(t){this.mirrorCb=t}getBatteryRam(){return this.prgRam.length-this.prgBatteryOffset>0?this.prgRam.slice(this.prgBatteryOffset):null}setBatteryRam(t){const s=this.prgRam.length-this.prgBatteryOffset;if(s<=0)return;const a=Math.min(s,t.length);this.prgRam.set(t.subarray(0,a),this.prgBatteryOffset)}}class Qt{constructor(t,s=new Uint8Array(0),a,c=8192,o=0){h(this,"prg");h(this,"chr");h(this,"prgRam");h(this,"prgBatteryOffset",0);h(this,"regSel",0);h(this,"chr1k",new Uint8Array(8));h(this,"prg8k",new Uint8Array(4));h(this,"mirrorCb",null);h(this,"irqReload",0);h(this,"irqCounter",0);h(this,"irqEnable",!1);h(this,"irqRepeat",!1);h(this,"irqLine",!1);this.prg=t,this.chr=s.length?s:new Uint8Array(a||8192);const r=Math.max(0,c|0)+Math.max(0,o|0);this.prgRam=new Uint8Array(r||8192),this.prgBatteryOffset=Math.max(0,c|0);const n=Math.max(1,this.prg.length>>>13);this.prg8k[0]=0,this.prg8k[1]=Math.min(1,n-1)&255,this.prg8k[2]=Math.min(2,n-1)&255,this.prg8k[3]=n-1&255;for(let d=0;d<8;d++)this.chr1k[d]=d&255}setMirrorCallback(t){this.mirrorCb=t}cpuRead(t){if(t>=24576&&t<32768){const s=t-24576;return s<this.prgRam.length?this.prgRam[s]:0}if(t>=32768){const s=this.mapPrg(t);return this.prg[s]}return 0}cpuWrite(t,s){if(t>=24576&&t<32768){const a=t-24576;a<this.prgRam.length&&(this.prgRam[a]=s&255);return}if(t>=32768&&t<=40959){this.regSel=s&15;return}if(t>=40960&&t<=49151){this.writeReg(this.regSel,s&255);return}}writeReg(t,s){if(t>=0&&t<=7){const a=Math.max(1,this.chr.length>>>10);this.chr1k[t]=s%a&255;return}if(t>=8&&t<=11){const a=Math.max(1,this.prg.length>>>13),c=t-8;c===3?this.prg8k[3]=s%a&255:this.prg8k[c]=s%a&255;return}if(t===12){const a=s&3;this.mirrorCb&&(a===0?this.mirrorCb("vertical"):a===1?this.mirrorCb("horizontal"):a===2?this.mirrorCb("single0"):this.mirrorCb("single1"));return}if(t===13){this.irqReload=this.irqReload&65280|s&255;return}if(t===14){this.irqReload=(s&255)<<8|this.irqReload&255;return}if(t===15){const a=this.irqEnable;this.irqEnable=(s&1)!==0,this.irqRepeat=(s&2)!==0,s&128&&(this.irqLine=!1),this.irqEnable&&!a&&(this.irqCounter=Math.max(1,this.irqReload&65535)),this.irqEnable||(this.irqLine=!1);return}}ppuRead(t){const s=t&8191,a=s>>>10,c=(this.chr1k[a]&255)*1024;return this.chr[c+(s&1023)]}ppuWrite(t,s){const a=t&8191;if(this.chr.length>0){const c=a>>>10,o=(this.chr1k[c]&255)*1024;this.chr[o+(a&1023)]=s&255}}mapPrg(t){const s=t-32768>>>13&3,c=(this.prg8k[s]&255)*8192+(t-32768&8191),o=this.prg.length-1;return c&o}tick(t){if(!this.irqEnable)return;let s=t|0;for(;s>0&&this.irqEnable;){const a=Math.min(this.irqCounter,s);if(this.irqCounter-=a,s-=a,this.irqCounter<=0)if(this.irqLine=!0,this.irqRepeat)this.irqCounter=Math.max(1,this.irqReload&65535);else{this.irqEnable=!1;break}}}irqPending(){return this.irqLine}clearIrq(){this.irqLine=!1}getBatteryRam(){return this.prgRam.length-this.prgBatteryOffset>0?this.prgRam.slice(this.prgBatteryOffset):null}setBatteryRam(t){const s=this.prgRam.length-this.prgBatteryOffset;if(s<=0)return;const a=Math.min(s,t.length);this.prgRam.set(t.subarray(0,a),this.prgBatteryOffset)}}var mt={};class Gt{constructor(t){h(this,"mapper");this.rom=t;const s=t.chr.length===0&&t.chrRamSize?t.chrRamSize:void 0,a=t.prgRamSize,c=t.prgNvramSize;switch(t.mapper){case 0:this.mapper=new _t(t.prg,t.chr,s,a??8192,c??0);break;case 1:this.mapper=new Ut(t.prg,t.chr,s,a??8192,c??0);break;case 2:this.mapper=new Ot(t.prg,t.chr,s,a??8192,c??0);break;case 3:this.mapper=new Wt(t.prg,t.chr,s,a??8192,c??0);break;case 11:this.mapper=new zt(t.prg,t.chr,s,a??8192,c??0);break;case 7:this.mapper=new Yt(t.prg,t.chr,s);break;case 4:{const o=!!t.isNES2,r=t.submapper,n={0:{},1:{},2:{},3:{},4:{useMMC6:!0},5:{assertOnRel0:!0},6:{assertOnRel0:!0},7:{assertOnRel0:!0}};let d=!1,e={assertOnRel0:!1};if(o&&typeof r=="number"){const i=n[r]||{};d=!!i.useMMC6,i.assertOnRel0&&(e.assertOnRel0=!0)}if(!o)try{const i=typeof process<"u"?mt:void 0;i&&i.FORCE_MMC6==="1"&&(d=!0)}catch{}this.mapper=d?new Zt(t.prg,t.chr,s):new it(t.prg,t.chr,{chrRamSize:s,prgRamSize:a??8192,prgNvramSize:c??0,...e});break}case 9:this.mapper=new Xt(t.prg,t.chr,s);break;case 66:this.mapper=new Vt(t.prg,t.chr,s,a??8192,c??0);break;case 69:this.mapper=new Qt(t.prg,t.chr,s,a??8192,c??0);break;case 71:this.mapper=new Ht(t.prg,t.chr,s,a??8192,c??0);break;case 64:{this.mapper=new it(t.prg,t.chr,{chrRamSize:s,prgRamSize:a??8192,prgNvramSize:c??0});break}case 21:this.mapper=new rt(t.prg,t.chr,21,s,a??8192,c??0);break;case 22:this.mapper=new rt(t.prg,t.chr,22,s,a??8192,c??0);break;case 23:this.mapper=new rt(t.prg,t.chr,23,s,a??8192,c??0);break;case 25:this.mapper=new rt(t.prg,t.chr,25,s,a??8192,c??0);break;case 206:{this.mapper=new it(t.prg,t.chr,{chrRamSize:s,prgRamSize:a??8192,prgNvramSize:c??0});break}default:throw new Error(`Mapper ${t.mapper} not implemented`)}}readCpu(t){const s=this.mapper.cpuRead(t);try{const a=typeof process<"u"?mt:void 0;a&&a.TRACE_BLARGG==="1"&&t>=24576&&t<=24579&&console.log(`[cart] read $${t.toString(16).padStart(4,"0")} => $${(s&255).toString(16).padStart(2,"0")}`)}catch{}return s}writeCpu(t,s){try{const a=typeof process<"u"?mt:void 0;a&&a.TRACE_BLARGG==="1"&&t>=24576&&t<=24579&&console.log(`[cart] write $${t.toString(16).padStart(4,"0")} <= $${(s&255).toString(16).padStart(2,"0")}`)}catch{}this.mapper.cpuWrite(t,s)}readChr(t){return this.mapper.ppuRead(t)}writeChr(t,s){this.mapper.ppuWrite(t,s)}reset(){typeof this.mapper.reset=="function"&&this.mapper.reset()}exportBatteryRam(){if(this.mapper.getBatteryRam){const t=this.mapper.getBatteryRam();return t?new Uint8Array(t):null}return null}importBatteryRam(t){this.mapper.setBatteryRam&&t&&this.mapper.setBatteryRam(t)}}const Bt=[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068],jt=1662607/1789773,Kt=Bt.map(m=>Math.max(4,Math.round(m*jt))),Jt=[428,380,340,320,286,254,226,214,190,160,142,128,106,85,72,54],ts=[398,354,316,298,276,236,210,198,176,148,132,118,98,78,66,50],at=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],nt=[[0,1,0,0,0,0,0,0],[0,1,1,0,0,0,0,0],[0,1,1,1,1,0,0,0],[1,0,0,1,1,1,1,1]],Et=m=>m==="PAL"?Kt:Bt,vt=m=>m==="PAL"?ts:Jt,ss=(m,t)=>{let s=m;return s<0&&(s+=1),t<=0?0:s<t?(s=s/t,s+s-s*s-1):s>1-t?(s=(s-1)/t,s*s+s+s+1):0};class es{constructor(){h(this,"q",[])}reset(){this.q.length=0}push(t){this.q.length>8192&&this.q.splice(0,this.q.length-4096),this.q.push(t)}render(t,s,a){return{p1p2:0,dmc:0}}prune(t){if(this.q.length===0)return;const s=Math.max(0,this.q.findIndex(a=>a.t>=t)-1);s>0&&this.q.splice(0,s)}_count(){return this.q.length|0}}class is extends es{constructor(){super(...arguments);h(this,"lastT",{p1:-1e15,p2:-1e15,tri:-1e15,noi:-1e15,dmc:-1e15});h(this,"avgInt",{p1:1e3,p2:1e3,tri:1e3,noi:1e3,dmc:1e3})}reset(){super.reset(),this.lastT={p1:-1e15,p2:-1e15,tri:-1e15,noi:-1e15,dmc:-1e15},this.avgInt={p1:1e3,p2:1e3,tri:1e3,noi:1e3,dmc:1e3}}push(s){const a=this.lastT[s.ch];if(a>-1e14){const c=Math.max(1,s.t-a|0),o=.2;this.avgInt[s.ch]=(1-o)*this.avgInt[s.ch]+o*c}this.lastT[s.ch]=s.t,super.push(s)}render(s,a,c){if(this.q.length===0)return{p1p2:0,dmc:0};const o=s,r=a;let n=0,d=0;for(let e=0;e<this.q.length;e++){const i=this.q[e],l=(i.t-o)/r;if(l<=-1)continue;if(l>=1)break;let p=c==null?void 0:c[i.ch];if(typeof p!="number"||!(p>0)){const u=Math.max(1,this.avgInt[i.ch]);p=r/u}p<1e-6&&(p=1e-6),p>.5&&(p=.5);const f=ss(l,p)*i.delta;i.ch==="p1"||i.ch==="p2"?n+=f:i.ch==="dmc"&&(d+=f)}return{p1p2:n,dmc:d}}}var H={};class rs{constructor(){h(this,"cpuRead",null);h(this,"mode5",!1);h(this,"irqInhibit",!1);h(this,"cycles",0);h(this,"stepIndex",0);h(this,"irqFlag",!1);h(this,"frameResetDelay",0);h(this,"frameIrqAssertDelay",0);h(this,"frameIrqDelayCounter",0);h(this,"pulse1Length",0);h(this,"pulse2Length",0);h(this,"pulse1Halt",!1);h(this,"pulse2Halt",!1);h(this,"enableMask",0);h(this,"pulse1EnvVolume",0);h(this,"pulse2EnvVolume",0);h(this,"pulse1EnvDivider",0);h(this,"pulse2EnvDivider",0);h(this,"pulse1EnvPeriod",0);h(this,"pulse2EnvPeriod",0);h(this,"pulse1EnvLoop",!1);h(this,"pulse2EnvLoop",!1);h(this,"pulse1EnvStart",!1);h(this,"pulse2EnvStart",!1);h(this,"pulse1EnvConstant",!1);h(this,"pulse2EnvConstant",!1);h(this,"pulse2TimerPeriod",0);h(this,"pulse2Timer",0);h(this,"pulse2Phase",0);h(this,"pulse2Duty",0);h(this,"pulse2SweepEnable",!1);h(this,"pulse2SweepPeriod",0);h(this,"pulse2SweepNegate",!1);h(this,"pulse2SweepShift",0);h(this,"pulse2SweepDivider",0);h(this,"pulse2SweepReload",!1);h(this,"pulse2SweepMute",!1);h(this,"pulse1TimerPeriod",0);h(this,"pulse1Timer",0);h(this,"pulse1Phase",0);h(this,"pulse1Duty",0);h(this,"pulse1SweepEnable",!1);h(this,"pulse1SweepPeriod",0);h(this,"pulse1SweepNegate",!1);h(this,"pulse1SweepShift",0);h(this,"pulse1SweepDivider",0);h(this,"pulse1SweepReload",!1);h(this,"pulse1SweepMute",!1);h(this,"triLinear",0);h(this,"triLinearReloadVal",0);h(this,"triLinearControl",!1);h(this,"triLinearReloadFlag",!1);h(this,"triLength",0);h(this,"triTimerPeriod",0);h(this,"triTimer",0);h(this,"triPhase",0);h(this,"noiseLength",0);h(this,"noiseHalt",!1);h(this,"noiseEnvConstant",!1);h(this,"noiseEnvPeriod",0);h(this,"noiseEnvDivider",0);h(this,"noiseEnvVolume",0);h(this,"noiseEnvStart",!1);h(this,"noiseMode",!1);h(this,"noisePeriodIndex",0);h(this,"noiseShift",1);h(this,"noiseTimerPeriod",0);h(this,"noiseTimer",0);h(this,"noiseStepCount",0);h(this,"dmcIrqEnabled",!1);h(this,"dmcLoop",!1);h(this,"dmcRateIndex",0);h(this,"dmcAddressBase",49152);h(this,"dmcAddress",49152);h(this,"dmcLengthBase",0);h(this,"dmcBytesRemaining",0);h(this,"dmcIrqFlag",!1);h(this,"dmcTimerPeriod",0);h(this,"dmcTimer",0);h(this,"dmcFetchCount",0);h(this,"dmcSampleBuffer",0);h(this,"dmcSampleBufferFilled",!1);h(this,"dmcShiftReg",0);h(this,"dmcBitsRemaining",0);h(this,"dmcDac",0);h(this,"dmcStallAccum",0);h(this,"blepEnabled",!1);h(this,"blep",null);h(this,"getCpuCycles",null);h(this,"framePhaseOffset",0);h(this,"fourStep",[3729,7457,11186,14916]);h(this,"fiveStep",[3729,7457,11186,14916,18641]);h(this,"region","NTSC");h(this,"frameTimingMode","integer")}recalcFrameEdges(){const t=[3729,7457,11186,14916],s=[3729,7457,11186,14916,18641],a=[3729.5,7456.5,11186.5,14916.5],c=[3729.5,7456.5,11186.5,14916.5,18641.5],o=this.frameTimingMode==="fractional";this.fourStep=o?a.slice():t.slice(),this.fiveStep=o?c.slice():s.slice()}setRegion(t){this.region=t,this.recalcFrameEdges()}getRegion(){return this.region}setFrameTimingMode(t){this.frameTimingMode=t,this.recalcFrameEdges()}reset(){this.blep&&this.blep.reset(),this.cpuRead=null,this.mode5=!1,this.irqInhibit=!1,this.cycles=0,this.stepIndex=0,this.irqFlag=!1,this.pulse1Length=0,this.pulse2Length=0,this.pulse1Halt=!1,this.pulse2Halt=!1,this.enableMask=0,this.pulse1EnvVolume=0,this.pulse2EnvVolume=0,this.pulse1EnvDivider=0,this.pulse2EnvDivider=0,this.pulse1EnvPeriod=0,this.pulse2EnvPeriod=0,this.pulse1EnvLoop=!1,this.pulse2EnvLoop=!1,this.pulse1EnvStart=!1,this.pulse2EnvStart=!1,this.pulse1EnvConstant=!1,this.pulse2EnvConstant=!1,this.noiseLength=0,this.noiseHalt=!1,this.noiseEnvConstant=!1,this.noiseEnvPeriod=0,this.noiseEnvDivider=0,this.noiseEnvVolume=0,this.noiseEnvStart=!1,this.noiseMode=!1,this.noisePeriodIndex=0,this.noiseShift=1,this.noiseTimerPeriod=Et(this.region)[0],this.noiseTimer=this.noiseTimerPeriod,this.noiseStepCount=0,this.dmcIrqEnabled=!1,this.dmcLoop=!1,this.dmcRateIndex=0,this.dmcAddressBase=49152,this.dmcAddress=49152,this.dmcLengthBase=0,this.dmcBytesRemaining=0,this.dmcIrqFlag=!1,this.dmcTimerPeriod=vt(this.region)[0],this.dmcTimer=this.dmcTimerPeriod,this.dmcFetchCount=0,this.dmcSampleBuffer=0,this.dmcSampleBufferFilled=!1,this.dmcShiftReg=0,this.dmcBitsRemaining=0,this.dmcDac=0}writeRegister(t,s){switch(s&=255,t&65535){case 16384:this.pulse1Halt=(s&32)!==0,this.pulse1EnvLoop=(s&32)!==0,this.pulse1EnvConstant=(s&16)!==0,this.pulse1EnvPeriod=s&15,this.pulse1Duty=s>>6&3;break;case 16385:{this.pulse1SweepEnable=(s&128)!==0,this.pulse1SweepPeriod=s>>4&7,this.pulse1SweepNegate=(s&8)!==0,this.pulse1SweepShift=s&7,this.pulse1SweepReload=!0;break}case 16386:this.pulse1TimerPeriod=this.pulse1TimerPeriod&1792|s&255;break;case 16387:{const a=s>>3&31;this.pulse1Length=at[a]|0,this.pulse1EnvStart=!0,this.pulse1TimerPeriod=(s&7)<<8|this.pulse1TimerPeriod&255,this.pulse1Timer=this.pulse1TimerPeriod,this.pulse1Phase=0;break}case 16388:this.pulse2Halt=(s&32)!==0,this.pulse2EnvLoop=(s&32)!==0,this.pulse2EnvConstant=(s&16)!==0,this.pulse2EnvPeriod=s&15,this.pulse2Duty=s>>6&3;break;case 16389:{this.pulse2SweepEnable=(s&128)!==0,this.pulse2SweepPeriod=s>>4&7,this.pulse2SweepNegate=(s&8)!==0,this.pulse2SweepShift=s&7,this.pulse2SweepReload=!0;break}case 16390:this.pulse2TimerPeriod=this.pulse2TimerPeriod&1792|s&255;break;case 16391:{const a=s>>3&31;this.pulse2Length=at[a]|0,this.pulse2EnvStart=!0,this.pulse2TimerPeriod=(s&7)<<8|this.pulse2TimerPeriod&255,this.pulse2Timer=this.pulse2TimerPeriod,this.pulse2Phase=0;break}case 16396:{this.noiseHalt=(s&32)!==0,this.noiseEnvConstant=(s&16)!==0,this.noiseEnvPeriod=s&15;break}case 16398:{this.noiseMode=(s&128)!==0,this.noisePeriodIndex=s&15,this.noiseTimerPeriod=Et(this.region)[this.noisePeriodIndex&15],this.noiseTimer=this.noiseTimerPeriod;break}case 16399:{const a=s>>3&31;this.noiseLength=at[a]|0,this.noiseEnvStart=!0;break}case 16400:{this.dmcIrqEnabled=(s&128)!==0,this.dmcIrqEnabled||(this.dmcIrqFlag=!1),this.dmcLoop=(s&64)!==0,this.dmcRateIndex=s&15,this.dmcTimerPeriod=vt(this.region)[this.dmcRateIndex&15],this.dmcTimer=this.dmcTimerPeriod;break}case 16401:{this.dmcDac=s&127;break}case 16402:{this.dmcAddressBase=49152+(s&255)*64;break}case 16403:{this.dmcLengthBase=(s&255)*16+1;break}case 16392:{this.triLinearControl=(s&128)!==0,this.triLinearReloadVal=s&127;break}case 16394:{this.triTimerPeriod=this.triTimerPeriod&1792|s&255;break}case 16395:{const a=s>>3&31;this.triLength=at[a]|0,this.triTimerPeriod=(s&7)<<8|this.triTimerPeriod&255,this.triLinearReloadFlag=!0,this.triTimer=this.triTimerPeriod,this.triPhase=0;break}case 16405:this.write4015(s);break;case 16407:this.write4017(s);break}}write4017(t){this.mode5=(t&128)!==0,this.irqInhibit=(t&64)!==0;let s=3;try{const a=typeof process<"u"?H:void 0;this.frameTimingMode==="fractional"&&this.getCpuCycles&&(s=3+((this.getCpuCycles()|0)&1?0:1))}catch{}this.frameResetDelay=0,this.irqFlag=!1,this.frameIrqDelayCounter=0,this.cycles=-this.framePhaseOffset,this.stepIndex=0;try{const a=typeof process<"u"?H:void 0;a&&a.TRACE_APU_4015==="1"&&console.log(`[apu] write4017=$${(t&255).toString(16).padStart(2,"0")} mode5=${this.mode5} inhibit=${this.irqInhibit}`)}catch{}this.mode5&&(this.clockEnvelopes(),this.clockTriangleLinear(),this.clockLengthCounters(),this.clockSweeps())}write4015(t){t&=255,this.enableMask=t,t&1||(this.pulse1Length=0),t&2||(this.pulse2Length=0),t&4||(this.triLength=0),t&8||(this.noiseLength=0),t&16?this.dmcBytesRemaining===0&&(this.dmcAddress=this.dmcAddressBase,this.dmcBytesRemaining=this.dmcLengthBase):(this.dmcBytesRemaining=0,this.dmcSampleBufferFilled=!1,this.dmcBitsRemaining=0)}read4015(){let t=0;this.pulse1Length>0&&(t|=1),this.pulse2Length>0&&(t|=2),this.triLength>0&&(t|=4),this.noiseLength>0&&(t|=8),this.irqFlag&&(t|=64),this.dmcIrqFlag&&(t|=128);try{const s=typeof process<"u"?H:void 0;s&&s.TRACE_APU_4015==="1"&&console.log(`[apu] read4015=$${(t&255).toString(16).padStart(2,"0")} (pre-clear) cycles=${this.cycles}`)}catch{}return this.irqFlag=!1,this.dmcIrqFlag=!1,t&255}tick(t){for(let s=0;s<t;s++){if(this.clockTriangleTimer(),this.clockPulse1Timer(),this.clockNoisePeriod(),this.clockPulse2Timer(),this.clockDmcRate(),this.frameIrqDelayCounter>0&&(this.frameIrqDelayCounter--,this.frameIrqDelayCounter===0)){this.irqFlag=!0;try{const c=typeof process<"u"?H:void 0;if(c&&c.TRACE_APU_IRQ==="1"){let o=`cycles=${this.cycles}`;try{if(this.getCpuCycles){const r=this.getCpuCycles()|0;o+=` cpu=${r}`}}catch{}console.log(`[apu] frame IRQ set (delayed) at ${o}`)}}catch{}}this.cycles++;const a=this.mode5?this.fiveStep:this.fourStep;for(;this.stepIndex<a.length&&this.cycles>=a[this.stepIndex];){const c=this.stepIndex;if(this.clockEnvelopes(),this.clockTriangleLinear(),this.mode5?(c===1||c===4)&&(this.clockLengthCounters(),this.clockSweeps()):(c===1||c===3)&&(this.clockLengthCounters(),this.clockSweeps()),this.stepIndex++,!this.mode5&&this.stepIndex===a.length){if(!this.irqInhibit)if(this.frameIrqAssertDelay>0)this.frameIrqDelayCounter=this.frameIrqAssertDelay|0;else{this.irqFlag=!0;try{const o=typeof process<"u"?H:void 0;if(o&&o.TRACE_APU_IRQ==="1"){let r=`cycles=${this.cycles}`;try{if(this.getCpuCycles){const n=this.getCpuCycles()|0;r+=` cpu=${n}`}}catch{}console.log(`[apu] frame IRQ set at ${r}`)}}catch{}}this.cycles-=a[a.length-1],this.stepIndex=0}this.mode5&&this.stepIndex===a.length&&(this.cycles-=a[a.length-1],this.stepIndex=0)}}}clockLengthCounters(){this.pulse1Length>0&&!this.pulse1Halt&&this.enableMask&1&&this.pulse1Length--,this.pulse2Length>0&&!this.pulse2Halt&&this.enableMask&2&&this.pulse2Length--,this.triLength>0&&!this.triLinearControl&&this.enableMask&4&&this.triLength--,this.noiseLength>0&&!this.noiseHalt&&this.enableMask&8&&this.noiseLength--}clockTriangleLinear(){this.triLinearReloadFlag?this.triLinear=this.triLinearReloadVal:this.triLinear>0&&this.triLinear--,this.triLinearControl||(this.triLinearReloadFlag=!1)}triangleEnabled(){return(this.enableMask&4)!==0}clockTriangleTimer(){if(!(!this.triangleEnabled()||this.triLength===0||this.triLinear===0))if(this.triTimer===0){if(this.triTimerPeriod<=1)return;this.triTimer=this.triTimerPeriod,this.triPhase=this.triPhase+1&31}else this.triTimer--}clockEnvelopes(){this.pulse1EnvStart?(this.pulse1EnvStart=!1,this.pulse1EnvDivider=this.pulse1EnvPeriod+1&31,this.pulse1EnvVolume=15):this.pulse1EnvConstant||(this.pulse1EnvDivider>0&&this.pulse1EnvDivider--,this.pulse1EnvDivider===0&&(this.pulse1EnvDivider=this.pulse1EnvPeriod+1&31,this.pulse1EnvVolume>0?this.pulse1EnvVolume--:this.pulse1EnvLoop&&(this.pulse1EnvVolume=15))),this.pulse2EnvStart?(this.pulse2EnvStart=!1,this.pulse2EnvDivider=this.pulse2EnvPeriod+1&31,this.pulse2EnvVolume=15):this.pulse2EnvConstant||(this.pulse2EnvDivider>0&&this.pulse2EnvDivider--,this.pulse2EnvDivider===0&&(this.pulse2EnvDivider=this.pulse2EnvPeriod+1&31,this.pulse2EnvVolume>0?this.pulse2EnvVolume--:this.pulse2EnvLoop&&(this.pulse2EnvVolume=15))),this.noiseEnvStart?(this.noiseEnvStart=!1,this.noiseEnvDivider=this.noiseEnvPeriod+1&31,this.noiseEnvVolume=15):this.noiseEnvConstant||(this.noiseEnvDivider>0&&this.noiseEnvDivider--,this.noiseEnvDivider===0&&(this.noiseEnvDivider=this.noiseEnvPeriod+1&31,this.noiseEnvVolume>0?this.noiseEnvVolume--:this.noiseHalt&&(this.noiseEnvVolume=15)))}clockNoiseTimer(){const t=this.noiseShift&1,s=this.noiseMode?this.noiseShift>>6&1:this.noiseShift>>1&1,a=(t^s)&1;this.noiseShift=this.noiseShift>>>1|a<<14,this.noiseStepCount++}noiseEnabled(){return(this.enableMask&8)!==0}clockNoisePeriod(){!this.noiseEnabled()||this.noiseLength===0||(this.noiseTimer===0?(this.noiseTimer=this.noiseTimerPeriod,this.clockNoiseTimer()):this.noiseTimer--)}dmcFetchNextByte(){if(this.cpuRead&&this.dmcBytesRemaining>0&&!this.dmcSampleBufferFilled){const t=this.cpuRead(this.dmcAddress&65535)&255;this.dmcStallAccum+=4,this.dmcAddress=this.dmcAddress+1&65535,this.dmcBytesRemaining--,this.dmcFetchCount++,this.dmcSampleBuffer=t,this.dmcSampleBufferFilled=!0,this.dmcBytesRemaining===0&&(this.dmcLoop?(this.dmcAddress=this.dmcAddressBase,this.dmcBytesRemaining=this.dmcLengthBase):this.dmcIrqEnabled&&(this.dmcIrqFlag=!0))}}clockDmcByte(){this.dmcBytesRemaining>0&&(this.dmcAddress=this.dmcAddress+1&65535,this.dmcBytesRemaining--,this.dmcFetchCount++,this.dmcBytesRemaining===0&&(this.dmcLoop?(this.dmcAddress=this.dmcAddressBase,this.dmcBytesRemaining=this.dmcLengthBase):this.dmcIrqEnabled&&(this.dmcIrqFlag=!0)))}clockDmcRate(){if(!(this.dmcBytesRemaining===0&&!this.dmcSampleBufferFilled&&this.dmcBitsRemaining===0))if(this.dmcTimer===0)if(this.dmcTimer=this.dmcTimerPeriod,this.dmcBitsRemaining===0)this.dmcSampleBufferFilled||this.dmcFetchNextByte(),this.dmcSampleBufferFilled&&(this.dmcShiftReg=this.dmcSampleBuffer,this.dmcSampleBufferFilled=!1,this.dmcBitsRemaining=8);else{const t=this.dmcShiftReg&1,s=this.dmcDac|0;if(t?this.dmcDac<=125?this.dmcDac+=2:this.dmcDac=127:this.dmcDac>=2?this.dmcDac-=2:this.dmcDac=0,this.blepEnabled&&this.blep&&this.dmcDac!==s){const a=this.dmcDac-s|0;this.blep.push({t:this.cycles+1|0,ch:"dmc",delta:a})}this.dmcShiftReg=this.dmcShiftReg>>>1,this.dmcBitsRemaining--,this.dmcBitsRemaining===0&&this.dmcBytesRemaining>0&&!this.dmcSampleBufferFilled&&this.dmcFetchNextByte()}else this.dmcTimer--}pulse1Enabled(){return(this.enableMask&1)!==0}pulse2Enabled(){return(this.enableMask&2)!==0}clockSweeps(){const t=(s,a,c,o,r,n)=>{const d=a&&(r&7)!==0;let e=!1,i=s&2047;if(d)if(s>=8){const l=s>>(r&7)&2047;let p=o?s-l-(n?1:0):s+l;p<0&&(p=0),p>2047||p<8?e=!0:i=p&2047}else e=!0;else e=!1;return{newPeriod:i,mute:e}};if(this.pulse1SweepReload)this.pulse1SweepDivider=this.pulse1SweepPeriod&7,this.pulse1SweepReload=!1;else if(this.pulse1SweepDivider===0){const s=t(this.pulse1TimerPeriod,this.pulse1SweepEnable,this.pulse1SweepPeriod,this.pulse1SweepNegate,this.pulse1SweepShift,!0);this.pulse1TimerPeriod=s.newPeriod,this.pulse1SweepMute=s.mute,this.pulse1SweepDivider=this.pulse1SweepPeriod&7}else this.pulse1SweepDivider=this.pulse1SweepDivider-1&7;if(this.pulse2SweepReload)this.pulse2SweepDivider=this.pulse2SweepPeriod&7,this.pulse2SweepReload=!1;else if(this.pulse2SweepDivider===0){const s=t(this.pulse2TimerPeriod,this.pulse2SweepEnable,this.pulse2SweepPeriod,this.pulse2SweepNegate,this.pulse2SweepShift,!1);this.pulse2TimerPeriod=s.newPeriod,this.pulse2SweepMute=s.mute,this.pulse2SweepDivider=this.pulse2SweepPeriod&7}else this.pulse2SweepDivider=this.pulse2SweepDivider-1&7;(!this.pulse1SweepEnable||!(this.pulse1SweepShift&7))&&(this.pulse1SweepMute=!1),(!this.pulse2SweepEnable||!(this.pulse2SweepShift&7))&&(this.pulse2SweepMute=!1)}clockPulse1Timer(){const t=nt;if(!(!this.pulse1Enabled()||this.pulse1Length===0))if(this.pulse1Timer===0){const s=this.pulse1Phase&7,a=s+1&7,c=t[this.pulse1Duty&3][s]|0,o=t[this.pulse1Duty&3][a]|0;if(this.blepEnabled&&this.blep&&c!==o&&this.pulse1TimerPeriod>7&&this.pulse1Length>0){const r=this.pulse1EnvConstant?this.pulse1EnvPeriod&15:this.pulse1EnvVolume&15,n=o?+r:-r;this.blep.push({t:this.cycles+1|0,ch:"p1",delta:n})}if(this.pulse1TimerPeriod<=7)return;this.pulse1Timer=this.pulse1TimerPeriod,this.pulse1Phase=this.pulse1Phase+1&7}else this.pulse1Timer--}triangleOutput(){if(!this.triangleEnabled()||this.triLength===0||this.triLinear===0||this.triTimerPeriod<=1)return 0;const t=this.triPhase&31;return t<16?15-t:t-16}pulse1Output(){return!this.pulse1Enabled()||this.pulse1Length===0||this.pulse1TimerPeriod<=7||this.pulse1SweepMute||nt[this.pulse1Duty&3][this.pulse1Phase&7]===0?0:(this.pulse1EnvConstant?this.pulse1EnvPeriod&15:this.pulse1EnvVolume&15)&15}pulse2Output(){return!this.pulse2Enabled()||this.pulse2Length===0||this.pulse2TimerPeriod<=7||this.pulse2SweepMute||nt[this.pulse2Duty&3][this.pulse2Phase&7]===0?0:(this.pulse2EnvConstant?this.pulse2EnvPeriod&15:this.pulse2EnvVolume&15)&15}clockPulse2Timer(){const t=nt;if(!(!this.pulse2Enabled()||this.pulse2Length===0))if(this.pulse2Timer===0){const s=this.pulse2Phase&7,a=s+1&7,c=t[this.pulse2Duty&3][s]|0,o=t[this.pulse2Duty&3][a]|0;if(this.blepEnabled&&this.blep&&c!==o&&this.pulse2TimerPeriod>7&&this.pulse2Length>0){const r=this.pulse2EnvConstant?this.pulse2EnvPeriod&15:this.pulse2EnvVolume&15,n=o?+r:-r;this.blep.push({t:this.cycles+1|0,ch:"p2",delta:n})}if(this.pulse2TimerPeriod<=7)return;this.pulse2Timer=this.pulse2TimerPeriod,this.pulse2Phase=this.pulse2Phase+1&7}else this.pulse2Timer--}noiseOutput(){if(!this.noiseEnabled()||this.noiseLength===0)return 0;const t=this.noiseShift&1,s=this.noiseEnvConstant?this.noiseEnvPeriod&15:this.noiseEnvVolume&15;return t?0:s}mixSample(){const t=this.triangleOutput(),s=this.pulse1Output(),a=this.pulse2Output(),c=this.noiseOutput(),o=this.dmcDac,r=s+a|0,n=r>0?95.88/(8128/r+100):0,d=t/8227+c/12241+o/22638,e=d>0?159.79/(1/d+100):0,i=n+e;let l=128+Math.round(i*127);return l<0?l=0:l>255&&(l=255),l&255}dmcIrqPending(){return this.dmcIrqFlag}frameIrqPending(){return this.irqFlag&&!this.irqInhibit}setCpuRead(t){this.cpuRead=t}setCpuCycleGetter(t){this.getCpuCycles=t}setFramePhaseOffset(t){this.framePhaseOffset=Number.isFinite(t)?t:0}setFrameIrqAssertDelay(t){this.frameIrqAssertDelay=(t|0)>=0?t|0:0}consumeDmcStallCycles(){const t=this.dmcStallAccum|0;return this.dmcStallAccum=0,t}enableBandlimitedSynth(t){this.blepEnabled=!!t,this.blepEnabled&&!this.blep&&(this.blep=new is),this.blep&&this.blep.reset()}mixSampleBlep(t,s){if(!this.blepEnabled||!this.blep)return this.mixSample();const a=this.triangleOutput(),c=this.pulse1Output(),o=this.pulse2Output(),r=this.noiseOutput(),n=this.dmcDac,d=s,e=this.pulse1TimerPeriod>7?d/(16*(this.pulse1TimerPeriod+1)):0,i=this.pulse2TimerPeriod>7?d/(16*(this.pulse2TimerPeriod+1)):0,l=this.dmcTimerPeriod>0?d/this.dmcTimerPeriod:0,p=this.blep.render(t,s,{p1:e,p2:i,dmc:l});let f=c+o+p.p1p2;f<0?f=0:f>30&&(f=30);let u=n+p.dmc;u<0?u=0:u>127&&(u=127);const g=f>0?95.88/(8128/f+100):0,y=a/8227+r/12241+u/22638,S=y>0?159.79/(1/y+100):0,B=g+S;let k=128+Math.round(B*127);return k<0?k=0:k>255&&(k=255),this.blep.prune(t-s*2|0),k&255}debugBlepEventCount(){var t,s;try{return((s=(t=this.blep)==null?void 0:t._count)==null?void 0:s.call(t))|0}catch{return 0}}}var Q={};class as{constructor(t){h(this,"bus");h(this,"cpu");h(this,"ppu");h(this,"io");h(this,"cart");h(this,"apu");h(this,"_lastIrqLine",!1);var r,n;this.bus=new D,this.cart=new Gt(t),this.ppu=new qt,this.ppu.connectCHR(d=>this.cart.readChr(d),(d,e)=>this.cart.writeChr(d,e));const s=this.cart.mapper;s.notifyA12Rise&&this.ppu.setA12Hook(()=>s.notifyA12Rise());const a=this.cart?this.cart.rom.flags6:0,c=(a&8)!==0,o=(a&1)!==0;c?this.ppu.setMirroring("four"):this.ppu.setMirroring(o?"vertical":"horizontal"),s.setMirrorCallback&&s.setMirrorCallback(d=>this.ppu.setMirroring(d)),s.setTimeProvider&&s.setTimeProvider(()=>({frame:this.ppu.frame,scanline:this.ppu.scanline,cycle:this.ppu.cycle})),s.setCtrlProvider&&s.setCtrlProvider(()=>{const d=(this.ppu.getCtrlLine?this.ppu.getCtrlLine():this.ppu.ctrl)&255,e=this.ppu.mask&255,i=(d&8)!==0,l=(d&16)!==0,p=(e&16)!==0,f=(e&8)!==0;let u=d&56;return!l&&!i&&f&&!p&&(u|=16),u&255}),this.io=new Ft(this.ppu,this.bus),this.bus.connectIO(this.io.read,this.io.write),this.bus.connectCart(d=>this.cart.readCpu(d),(d,e)=>this.cart.writeCpu(d,e)),this.cpu=new Dt(this.bus),this.io.setCpuCycleHooks(()=>this.cpu.state.cycles,d=>this.cpu.addCycles(d)),this.apu=new rs;try{const d=t.timing,e=d?d==="multi"?"ntsc":d:"ntsc";this.ppu.setRegion(e);const i=d==="pal"?"PAL":"NTSC";this.apu.setRegion(i)}catch{}this.apu.reset();try{const d=typeof process<"u"?Q:void 0,e=d==null?void 0:d.APU_FRAME_TIMING;if(e&&typeof this.apu.setFrameTimingMode=="function"){const i=e.toLowerCase();i==="fractional"||i==="frac"||i==="1"?this.apu.setFrameTimingMode("fractional"):(i==="integer"||i==="int"||i==="0")&&this.apu.setFrameTimingMode("integer")}}catch{}this.io.attachAPU(this.apu),this.apu.setCpuRead(d=>this.bus.read(d&65535));try{(n=(r=this.apu).setCpuCycleGetter)==null||n.call(r,()=>this.cpu.state.cycles)}catch{}try{const d=typeof process<"u"?Q:void 0,e=d==null?void 0:d.APU_FRAME_PHASE_OFFSET_CYCLES;if(e&&this.apu.setFramePhaseOffset){const l=parseFloat(e);isFinite(l)&&this.apu.setFramePhaseOffset(l)}const i=d==null?void 0:d.APU_FRAME_IRQ_ASSERT_DELAY;if(i&&this.apu.setFrameIrqAssertDelay){const l=parseInt(i,10)|0;this.apu.setFrameIrqAssertDelay(l)}}catch{}}reset(){const t=this.bus.read(65532)|this.bus.read(65533)<<8;this.cpu.reset(t),this.ppu.reset(),this.cart.reset(),this.apu.reset(),this.apu.setCpuRead(s=>this.bus.read(s&65535))}cpuResetOnly(){const t=this.bus.read(65532)|this.bus.read(65533)<<8;this.cpu.reset(t)}stepInstruction(){var a,c;this.ppu.nmiOccurred&&this.ppu.nmiOutput&&(this.cpu.requestNMI(),this.ppu.nmiOccurred=!1);const t=this.cart.mapper;let s=!1;t.irqPending&&t.irqPending()&&(s=!0);try{const o=typeof process<"u"?Q:void 0;if(!!(o&&o.DISABLE_APU_IRQ==="1")||(this.apu&&this.apu.dmcIrqPending&&this.apu.dmcIrqPending()&&(s=!0),this.apu&&this.apu.frameIrqPending&&this.apu.frameIrqPending()&&(s=!0)),o&&o.TRACE_IRQ_LINE==="1"){const n=this.cpu.state.cycles,d=o.TRACE_IRQ_LINE_WINDOW;let e=!0;if(d){const l=/^(\d+)-(\d+)$/.exec(d);if(l){const p=parseInt(l[1],10)|0,f=parseInt(l[2],10)|0;e=n>=p&&n<=f}}const i=o.TRACE_IRQ_LINE_CHANGE_ONLY==="1";if(e&&(!i||s!==this._lastIrqLine)){const l={mapper:!!(t.irqPending&&t.irqPending()),apu_frame:!!(this.apu&&this.apu.frameIrqPending&&this.apu.frameIrqPending()),apu_dmc:!!(this.apu&&this.apu.dmcIrqPending&&this.apu.dmcIrqPending()),I:(this.cpu.state.p&4)!==0,cyc:n,phase:"pre"};console.log(`[irq] ${l.phase} line=${s} I=${l.I} cyc=${l.cyc} mapper=${l.mapper} apu_frame=${l.apu_frame} apu_dmc=${l.apu_dmc}`)}}}catch{}this.cpu.setIrqLine(s),this._lastIrqLine=s,this.cpu.setCycleHook(o=>{if(o<=0)return;this.ppu.tick(o*3),this.apu.tick(o);const r=this.cart.mapper;r&&typeof r.tick=="function"&&r.tick(o)}),this.cpu.step();try{const o=typeof process<"u"?Q:void 0;if(!!(o&&o.ENABLE_DMC_STALLS==="1")){const n=((c=(a=this.apu)==null?void 0:a.consumeDmcStallCycles)==null?void 0:c.call(a))|0;if(n>0){this.cpu.addCycles(n),this.ppu.tick(n*3),this.apu.tick(n);const d=this.cart.mapper;d&&typeof d.tick=="function"&&d.tick(n)}}}catch{}this.ppu.nmiOccurred&&this.ppu.nmiOutput&&(this.cpu.requestNMI(),this.ppu.nmiOccurred=!1),s=!1,t.irqPending&&t.irqPending()&&(s=!0);try{const o=typeof process<"u"?Q:void 0;if(!!(o&&o.DISABLE_APU_IRQ==="1")||(this.apu&&this.apu.dmcIrqPending&&this.apu.dmcIrqPending()&&(s=!0),this.apu&&this.apu.frameIrqPending&&this.apu.frameIrqPending()&&(s=!0)),o&&o.TRACE_IRQ_LINE==="1"){const n=this.cpu.state.cycles,d=o.TRACE_IRQ_LINE_WINDOW;let e=!0;if(d){const l=/^(\d+)-(\d+)$/.exec(d);if(l){const p=parseInt(l[1],10)|0,f=parseInt(l[2],10)|0;e=n>=p&&n<=f}}const i=o.TRACE_IRQ_LINE_CHANGE_ONLY==="1";if(e&&(!i||s!==this._lastIrqLine)){const l={mapper:!!(t.irqPending&&t.irqPending()),apu_frame:!!(this.apu&&this.apu.frameIrqPending&&this.apu.frameIrqPending()),apu_dmc:!!(this.apu&&this.apu.dmcIrqPending&&this.apu.dmcIrqPending()),I:(this.cpu.state.p&4)!==0,cyc:n,phase:"post"};console.log(`[irq] ${l.phase} line=${s} I=${l.I} cyc=${l.cyc} mapper=${l.mapper} apu_frame=${l.apu_frame} apu_dmc=${l.apu_dmc}`)}}}catch{}this.cpu.setIrqLine(s),this._lastIrqLine=s}}function ct(m){return m&15?64<<(m&15):0}function ns(m){if(m.length<16)throw new Error("Invalid iNES file");if(String.fromCharCode(...m.slice(0,4))!=="NES")throw new Error("Invalid iNES header");const t=m[6]&255,s=m[7]&255,a=!!(t&4);let c=t>>4&15|s&240,o=0,r=m[4]&255,n=m[5]&255,d=!1,e=8*1024,i=0,l=0,p=0,f;if((s&12)>>>2===2){d=!0;const k=m[8]&255,P=m[9]&255;c|=(k&240)<<4,o=k&15,r|=(P&15)<<8,n|=(P>>4&15)<<8;const R=m[10]&255,A=m[11]&255;e=ct(R&15),i=ct(R>>4&15),l=ct(A&15),p=ct(A>>4&15);const w=m[12]&255&3;f=w===0?"ntsc":w===1?"pal":w===2?"multi":"dendy"}const u=(r>>>0)*16*1024,g=(n>>>0)*8*1024;let y=16;a&&(y+=512);const S=m.slice(y,y+u);y+=u;const B=g?m.slice(y,y+g):new Uint8Array(0);return{prg:S,chr:B,mapper:c,hasTrainer:a,prgRamSize:e,flags6:t,flags7:s,isNES2:d,submapper:o,prgNvramSize:i,chrRamSize:l,chrNvramSize:p,timing:f}}const T={ReadIdx:0,WriteIdx:1,Capacity:2,Channels:3,Overruns:5,LastOccupancy:6},cs=m=>{const t=new Int32Array(m.controlSAB),s=new Float32Array(m.dataSAB,m.dataByteOffset??0,(new Int32Array(m.controlSAB)[T.Capacity]|0)*(new Int32Array(m.controlSAB)[T.Channels]|0)),a=t[T.Channels]|0,c=t[T.Capacity]|0;return{write:i=>{const l=i.length/a|0,p=Atomics.load(t,T.ReadIdx)|0,u=((Atomics.load(t,T.WriteIdx)|0)-p+c)%c|0,g=c-1-u|0,y=Math.min(l,g)|0;y<l&&Atomics.add(t,T.Overruns,1);let S=0;for(;S<y;){const B=Atomics.load(t,T.WriteIdx)|0,k=c-B|0,P=Math.min(y-S,k)|0,R=B*a,A=S*a,I=P*a;s.set(i.subarray(A,A+I),R);const w=(B+P)%c;Atomics.store(t,T.WriteIdx,w),S+=P}return y},freeSpace:()=>{const i=Atomics.load(t,T.ReadIdx)|0,p=((Atomics.load(t,T.WriteIdx)|0)-i+c)%c|0;return c-1-p|0},occupancy:()=>((Atomics.load(t,T.WriteIdx)|0)-(Atomics.load(t,T.ReadIdx)|0)+c)%c|0,consumerOccupancy:()=>Atomics.load(t,T.LastOccupancy)|0,debugRW:()=>({r:Atomics.load(t,T.ReadIdx)|0,w:Atomics.load(t,T.WriteIdx)|0})}},hs=1789773;let C=null,v=null,W=null,L=48e3,q=2,gt=!1,bt=!1,G=null,j=null,yt=-1,K=4096,It=!1,ht=!1,X=!1,kt=0,St=0;const x={lastCycles:0,targetCycles:0};let Z=null,ot=0;const lt=[];let Pt=0,pt=Number.POSITIVE_INFINITY,dt=0,Rt=0,ft=0,Tt=typeof performance<"u"?performance.now():0;const F=128,J=1024,wt=(m,t)=>{if(!C)return 0;const s=L&&isFinite(L)&&L>0?L:44100,a=hs/s;let c=0;for(;c<m;){for(x.targetCycles+=a;C.cpu.state.cycles<x.targetCycles;)C.stepInstruction();const o=x.targetCycles-a,n=((bt&&C.apu.mixSampleBlep?C.apu.mixSampleBlep(o,a)|0:C.apu.mixSample()|0)-128)/128,e=n-kt+.999*St;kt=n,St=e;const i=Math.max(-1,Math.min(1,e));if(q===2){const l=c*2;t[l]=i,t[l+1]=i}else t[c]=i;c++}return m},os=(m,t,s,a,c)=>{ot++;const o=Math.max(0,a-s);lt.push(o),lt.length>240&&lt.shift(),Pt=(Pt*(ot-1)+m)/ot,pt=Math.min(pt,t),dt=Math.max(dt,t),Rt+=t,ft++;const r=typeof performance<"u"?performance.now():0;if(r-Tt>1e3){const n=lt.slice().sort((p,f)=>p-f),d=Math.max(0,Math.min(n.length-1,Math.floor(n.length*.95))),e=n[d]||0,i=n.length>0?n.reduce((p,f)=>p+f,0)/n.length:0,l=ft>0?Rt/ft:0;postMessage({type:"worker-stats",audio:{pumps:ot,pumpMsAvg:i,pumpMs95p:e,framesPerPumpAvg:Pt,sabOccMin:pt,sabOccAvg:l,sabOccMax:dt,occConsumerNow:t,occProducerNow:(c==null?void 0:c.occProd)??-1,r:(c==null?void 0:c.r)??-1,w:(c==null?void 0:c.w)??-1}}),Tt=r,pt=Number.POSITIVE_INFINITY,dt=0,Rt=0,ft=0}};let ut=0,$t=typeof performance<"u"?performance.now():0;const Mt=()=>{if(!gt||!C)return;if(ht){const P=Math.max(1,q|0);(!W||W.length<512*P)&&(W=new Float32Array(512*P)),wt(512,W),postMessage({type:"audio-chunk",samples:W},[W.buffer]);return}if(!v)return;ut++,X&&ut%2e3===0&&console.log("[worker] pumpAudio heartbeat",ut),x.lastCycles===0&&(x.lastCycles=C.cpu.state.cycles,x.targetCycles=x.lastCycles,X&&console.log("[worker] audio state initialized, cycles:",x.lastCycles));let m,t,s,a;try{const k=v.debugRW();m=k.r,t=k.w,s=v.occupancy(),a=v.freeSpace()}catch(k){X&&console.error("[worker] debugRW failed:",k);return}if(a<F){X&&ut%2e3===0&&console.log("[worker] skipping pump - insufficient free space:",a,"need:",F);return}Z||(Z=new Float32Array(J*q));const c=typeof performance<"u"?performance.now():0,o=Math.max(0,c-$t);$t=c;const r=Math.max(F,Math.min(J,Math.ceil((L|0)*o/1e3)));let n=0,d=0;const e=Math.max(F,Math.floor(K*.55));let i=512,l=2.5;const p=Math.max(0,e-s),f=e>0?p/e:0;(f>.5||r>512)&&(l=4,i=768);const u=Math.min(i,r+Math.min(p,384));for(;s<e&&a>=F&&n<6&&d<u;){const k=Math.min(a,Math.max(0,e-s),u-d),P=f>.5?192:128,R=Math.max(F,Math.min(P,k)),A=Z.subarray(0,R*q);if(wt(R,A),v.write(A)===0){X&&console.warn("[worker] failed to write audio data, freeSpace:",a,"toProduce:",R);break}if(d+=R,s=v.occupancy(),a=v.freeSpace(),n++,(typeof performance<"u"?performance.now():0)-c>l)break}const g=typeof performance<"u"?performance.now():0;try{Nt()}catch{}const y=s,{r:S,w:B}=v.debugRW();os(d,s,c,g,{occProd:y,r:S,w:B}),s<e&&a>0&&setTimeout(Mt,0)},Nt=()=>{if(!C)return;const m=C.ppu.frame|0;if(m===yt)return;const t=C.ppu.getFrameBuffer(),s=new Uint8Array(t);postMessage({type:"ppu-frame",w:256,h:240,indices:s},[s.buffer]),yt=m},ls=()=>{G==null&&(G=setInterval(Mt,2)),j==null&&(j=setInterval(Nt,1e3/60))},ps=()=>{G!=null&&(clearInterval(G),G=null),j!=null&&(clearInterval(j),j=null)},ds=m=>{var s,a,c,o,r,n,d,e,i,l;const t=m.data;switch(t.type){case"set-debug":{X=!!t.enabled;break}case"init":{if(It=!!t.noAudio,ht=!!t.useLegacy,v=t.sab?cs(t.sab):null,L=t.sampleRate|0,q=t.channels|0,K=t.targetFillFrames|0,Z=new Float32Array(J*q),console.log("[worker] init: noAudio:",It,"useLegacy:",ht,"writer:",!!v,"sampleRate:",L,"channels:",q,"targetFillFrames:",K),v){const{r:p,w:f}=v.debugRW();console.log("[worker] initial SAB state: r:",p,"w:",f,"occ:",v.occupancy(),"free:",v.freeSpace())}break}case"load_rom":{const p=ns(t.rom);C=new as(p),(a=(s=C.ppu).setTimingMode)==null||a.call(s,t.useVT?"vt":"legacy");try{const f=t.apuRegion==="PAL"?"PAL":"NTSC";(o=(c=C.apu).setRegion)==null||o.call(c,f);const u=t.apuTiming==="fractional"?"fractional":"integer";(n=(r=C.apu).setFrameTimingMode)==null||n.call(r,u),bt=t.apuSynth==="blep",bt&&((e=(d=C.apu).enableBandlimitedSynth)==null||e.call(d,!0))}catch{}C.reset(),C.io.write(8193,30),(l=(i=C.cpu).setIllegalMode)==null||l.call(i,t.strict?"strict":"lenient"),x.lastCycles=0,x.targetCycles=0,kt=0,St=0,yt=-1;break}case"start":{if(gt=!0,!ht&&v&&C){Z||(Z=new Float32Array(J*q));let p=0;for(;v.occupancy()<K-F&&v.freeSpace()>=F&&p<64;){let f=v.occupancy();const u=Math.min(J,Math.max(F,K-f)),g=Z.subarray(0,u*q);wt(u,g),v.write(g),p++}}ls();break}case"pause":{gt=!1,ps();break}case"input":{if(!C)break;const f={KeyZ:{btn:"A",idx:1},KeyX:{btn:"B",idx:1},ShiftLeft:{btn:"Select",idx:1},Enter:{btn:"Start",idx:1},ArrowUp:{btn:"Up",idx:1},ArrowDown:{btn:"Down",idx:1},ArrowLeft:{btn:"Left",idx:1},ArrowRight:{btn:"Right",idx:1}}[t.code];f&&C.io.getController(f.idx).setButton(f.btn,t.down);break}}};self.onmessage=ds})();
